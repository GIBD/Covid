---
title: "COVID-19 Argentina"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 3
---


```{r setup, include=FALSE}
  knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	cache = FALSE
)
```

```{r importarArg, message=FALSE, warning=FALSE, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(knitr)
library(kableExtra)
library(highcharter)
library(rjson)
library(plotly)
library(gganimate)
library(stringr)
library(sf)
library(tmap)
library(googlesheets4)
library(readxl)
library(RcppRoll)
library(DT)

sep.miles <- function(x){format(x,big.mark=".")}
 
#################
# Carga de Datos
#################
capUti <-3981
## Mapas y Poblaciones
argentina <- fromJSON(file = "data/mapas/ar-all.geo.json")
poblacionArg <- read_delim("data/poblaciones/prov_argentina.csv", ";", escape_double = FALSE,  
                           locale = locale(decimal_mark = ",", grouping_mark = ".", encoding = "ISO-8859-1"),trim_ws = TRUE)
### Totales generales
argCov <- read_excel("data/argentina.xlsx", "argentina_gral")
names(argCov) <- c("dia", "casosD", "Detectados", "muertesD", "Fallecidos", "Altas", "Recuperados", "UTI", 
                   "MuestraD", "TotalPruebas","DescEpidemiologia", "DescTest", 
                   "Descartados",  "Importados", "Estrecho", "Comunitaria", "Investigacion",  "InicioSint", "activos_uti",	"letalidad")
argCov$dia <- as.Date(argCov$dia, '%d/%m/%Y')
covidArg <- read_excel("data/argentina.xlsx", "casos_provincias")
covidArg$FECHA <- as.Date(covidArg$FECHA, '%d/%m/%Y')

### Detalle fallecidos
muertosArg <- covidArg %>% select(FECHA, PROVINCIA, MUERTES)

### Datos abiertos
casos_pronvinciales <- read_csv("data/Covid19Casos.csv")

edades <-  casos_pronvinciales %>% 
  filter(clasificacion_resumen=="Confirmado") %>% group_by(sexo, edad, edad_años_meses) %>%
  mutate(cantidad=n()) %>%  select(sexo, edad, edad_años_meses, cantidad) %>% unique()
edades$edad <- if_else(edades$edad_años_meses=="Meses", 1, edades$edad)

edades <-  edades %>%  group_by(sexo, edad) %>%
  mutate(cantidad=sum(cantidad)) %>%  select(sexo, edad, cantidad) %>% unique()

edades$grupo <- if_else(edades$edad < 10, "0 a 9", 
                     if_else(edades$edad < 20, "10 a 19", 
                     if_else(edades$edad < 30, "20 a 29", 
                     if_else(edades$edad < 40, "30 a 39", 
                     if_else(edades$edad < 50, "40 a 49", 
                     if_else(edades$edad < 60, "50 a 59", 
                     if_else(edades$edad < 70, "60 a 69", 
                     if_else(edades$edad < 80, "70 a 79", "80 o mas"))))))))

edades <- edades %>% group_by(sexo, grupo) %>% mutate(cantidad=sum(cantidad)) %>% 
  select(sexo, grupo, cantidad) %>% unique()

fallecidos_edad <- casos_pronvinciales %>% 
  filter(clasificacion_resumen=="Confirmado" & fallecido=="SI") %>%
  group_by(sexo, edad, edad_años_meses) %>%
  mutate(cantidad = n()) %>% select(sexo, edad, edad_años_meses, cantidad) %>% unique()

fallecidos_edad$edad <- if_else(fallecidos_edad$edad_años_meses=="Meses", 1, fallecidos_edad$edad)

fallecidos_edad <- fallecidos_edad %>% 
  group_by(sexo, edad) %>%
  mutate(cantidad=sum(cantidad)) %>% 
  select(sexo, edad, cantidad) %>% unique()
     
      fallecidos_edad$grupo <- if_else(fallecidos_edad$edad < 10, "0 a 9", 
                     if_else(fallecidos_edad$edad < 20, "10 a 19", 
                     if_else(fallecidos_edad$edad < 30, "20 a 29", 
                     if_else(fallecidos_edad$edad < 40, "30 a 39", 
                     if_else(fallecidos_edad$edad < 50, "40 a 49", 
                     if_else(fallecidos_edad$edad < 60, "50 a 59", 
                     if_else(fallecidos_edad$edad < 70, "60 a 69", 
                     if_else(fallecidos_edad$edad < 80, "70 a 79", "80 o mas"))))))))
     
     fallecidos_edad <- fallecidos_edad %>% group_by(sexo, grupo) %>% mutate(cantidad=sum(cantidad)) %>% 
        select(sexo, grupo, cantidad) %>% unique()
     
     confirmados <- casos_pronvinciales %>% filter(carga_provincia_nombre== residencia_provincia_nombre & 
                                                      clasificacion_resumen=="Confirmado") %>% 
        group_by(carga_provincia_nombre, fecha_apertura) %>% mutate(confirmados = n()) %>% 
        select(carga_provincia_nombre, fecha_apertura, confirmados) %>% unique()
     
     # unique(recuperados$clasificacion)
     recuperados <- casos_pronvinciales %>% 
       filter( carga_provincia_nombre== residencia_provincia_nombre & 
                clasificacion_resumen == "Confirmado" & 
                clasificacion %in% c("Caso confirmado por laboratorio - No Activo por criterio de laboratorio",
                                     "Caso confirmado por laboratorio - No activo (por tiempo de evolución)", 
                                     "Caso confirmado por criterio clínico-epidemiológico  - No activo (por tiempo de evolución)")) %>% 
        group_by(carga_provincia_nombre, fecha_apertura) %>% mutate(altas = n()) %>% 
        select(carga_provincia_nombre, fecha_apertura, altas) %>% unique()
     
     confirmados_lab <- casos_pronvinciales %>% 
        filter(carga_provincia_nombre== residencia_provincia_nombre & 
                 clasificacion_resumen=="Confirmado" &
                 clasificacion %in% c("Caso confirmado por laboratorio - Activo",
                                       "Caso confirmado por laboratorio - Activo Internado",
                                     "Caso confirmado por laboratorio - Fallecido",
                                     "Caso confirmado por laboratorio - No activo (por tiempo de evolución)",
                                     "Caso confirmado por laboratorio - No Activo por criterio de laboratorio" )) %>% 
        group_by(carga_provincia_nombre, fecha_apertura) %>% mutate(confirmados = n()) %>% 
        select(carga_provincia_nombre, fecha_apertura, confirmados) %>% unique()
     
     # table(casos_pronvinciales$clasificacion)
     descartados_lab <- casos_pronvinciales %>% 
       filter(carga_provincia_nombre== residencia_provincia_nombre & 
                clasificacion_resumen=="Descartado" &
                clasificacion %in% c("Caso Descartado") ) %>% 
        group_by(carga_provincia_nombre, fecha_apertura) %>% mutate(descartados = n()) %>% 
        select(carga_provincia_nombre, fecha_apertura, descartados) %>% unique()
     
     positiv_lab <-descartados_lab %>%  
       left_join(confirmados_lab, by=c("carga_provincia_nombre"="carga_provincia_nombre",
                                   "fecha_apertura"="fecha_apertura"))
     
       positiv_lab$positividad <- round(positiv_lab$confirmados/
                                                (positiv_lab$confirmados + positiv_lab$descartados)*100, 1)
       
       positiv_lab$positividad <- if_else(is.na(positiv_lab$positividad), 0,
                                                 as.double(positiv_lab$positividad))
       
       
     descartados <- casos_pronvinciales %>% filter(carga_provincia_nombre== residencia_provincia_nombre & 
                                                      clasificacion_resumen=="Descartado" ) %>% 
        group_by(carga_provincia_nombre, fecha_apertura) %>% mutate(descartados = n()) %>% 
        select(carga_provincia_nombre, fecha_apertura, descartados) %>% unique()
     
     fallecidos <- casos_pronvinciales %>% filter(carga_provincia_nombre== residencia_provincia_nombre & 
                                                      clasificacion_resumen=="Confirmado" &
                                                     fallecido=="SI") %>% 
       group_by(carga_provincia_nombre, fecha_apertura) %>% mutate(fallecidos = n()) %>% 
       select(carga_provincia_nombre, fecha_apertura, fallecidos) %>% unique()
     
     casos_provincias <- confirmados %>% 
       left_join(descartados, by=c("carga_provincia_nombre"="carga_provincia_nombre",
                                   "fecha_apertura"="fecha_apertura")) %>%
       left_join(recuperados, by=c("carga_provincia_nombre"="carga_provincia_nombre",
                                   "fecha_apertura"="fecha_apertura")) %>% 
       left_join(fallecidos, by=c("carga_provincia_nombre"="carga_provincia_nombre",
                                   "fecha_apertura"="fecha_apertura"))

     casos_provincias$positividad <- round(casos_provincias$confirmados/
                                                (casos_provincias$confirmados + casos_provincias$descartados)*100, 1)
     
     casos_provincias$confirmados <- if_else(is.na(casos_provincias$confirmados), 0,
                                                 as.double(casos_provincias$confirmados))
     casos_provincias$altas <- if_else(is.na(casos_provincias$altas), 0, as.double(casos_provincias$altas))
     casos_provincias$descartados <- if_else(is.na(casos_provincias$descartados), 0,
                                                 as.double(casos_provincias$descartados))
     casos_provincias$fallecidos <- if_else(is.na(casos_provincias$fallecidos), 0,
                                                as.double(casos_provincias$fallecidos))
     casos_provincias$positividad <- if_else(is.na(casos_provincias$positividad), 0,
                                                 as.double(casos_provincias$positividad))
     
     casos_provincias$activos <- casos_provincias$confirmados - 
                    casos_provincias$altas - casos_provincias$fallecidos

     color <- function(d){
          c <- if_else(d==0, '#FFFFFF',
               if_else(d < 25, '#fdd49e',
               if_else(d < 50, '#fc8d59',
               if_else(d < 75, '#d7301f',
               if_else(d < 100, '#b30000',
                       "#7f0000")))))
         return(c)}
  
 urlign <- "https://wms.ign.gob.ar/geoserver/gwc/service/tms/1.0.0/capabaseargenmap@EPSG%3A3857@png/{z}/{x}/{-y}.png"
       
       
```


## Cantidad de Casos Actuales
En Argentina los datos son informados diariamente por el Ministerio de Salud de la Nación. Estos datos se informan de manera desestructurada y diariamente se modifica la cantidad de datos brindados.

Los datos con los que se trabajarán son de procesamiento propio en base a los informes mencionados y se encuentran actualizados al `r max(covidArg$FECHA) `.


###  {.tabset  .tabset-fade .tabset-pills}
#### Evolución en Argentina
```{r evolArg, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE}
   
   argCov$dia <- as.Date(argCov$dia, '%d/%m/%Y')
   argCov$Recuperados <- if_else(is.na(argCov$Recuperados), 0, argCov$Recuperados)
   
   evolArg <- argCov %>%
     select(dia, Detectados, Fallecidos, Recuperados) %>% 
     mutate(Activos = Detectados - Fallecidos - Recuperados) %>% 
     select(dia, Detectados, Activos, Fallecidos, Recuperados) %>% 
     gather(tipo, cantidad, c(Detectados, Activos, Fallecidos, Recuperados), -dia)
   
     m <- evolArg %>% filter(dia==max(dia))
     a <- list( x =  m$dia+1, y =if_else(m$tipo=="Fallecidos", m$cantidad+20000, if_else(m$tipo=="Activos", m$cantidad+70000, m$cantidad)),
                text = paste0('<b>', m$tipo, '\n', format(m$cantidad, big.mark=".") , '</b>'),
                xref = "x", yref = "y", showarrow = F, ax = 60, ay = -40)
     
     b <- list( x="2020-03-20", y= 1, yref = "y", xref = "x", ax=0, ay=-390,
                text="ASPO", textangle = 0, showarrow = T,
                arrowhead = 0,  arrowwidth=0.8, borderwidth=0.5, opacity=0.7)
     
     pal <- c( '#8DA0CB', '#9BD92F','#FF8080',  '#66C2A5')

     fig <- plot_ly(evolArg, x =~dia, y=~cantidad, split = ~tipo, color=~tipo,
                    colors=pal, alpha = 0.1, type='scatter', mode='lines', fill='tozeroy')
     
     fig %>% layout(title="<b> Evolución de COVID-19 en Argentina</b>",
                    xaxis = list(title = "día"), yaxis = list(title = ""),
                    annotations=a) %>% layout(showlegend = FALSE, annotations=b) 
       
```




#### Ocupación de UTI
A continuación se grafica la evolución de la cantidad de casos internados en Unidades de Terapia Intensiva y de los casos activos 

```{r distrArgH,echo=FALSE, message=FALSE, warning=FALSE }
 
  p2 <- argCov %>%filter(dia >="2020-03-28") %>%  #filter(dia==max(dia)) %>% 
     select(dia, Detectados, Fallecidos, Recuperados, UTI) %>% 
     mutate(Activos = Detectados - Fallecidos - Recuperados-UTI) %>% 
     select(dia, Activos, Fallecidos, Recuperados, UTI) %>% 
     mutate(porc = UTI/capUti*100)
 
  fig <- plot_ly(p2, x = ~dia, y = ~UTI, type = 'bar', name = 'UTI',
        marker = list(color =  "#8DA0CB")) # 'rgba(222,45,38,0.8)'))
   
  # fig <- fig %>% add_trace(y = ~round(porc,1), name = '% UTI',  
  #                          type = "scatter", mode='lines+markers', marker = list(color = "#8DA0CB")) #'rgba(222,45,38,0.8)'))
  fig <- fig %>% layout(title = 'Ocupación de UTI',
           xaxis = list(title = "", tickfont = list(size = 14, color = 'rgb(107, 107, 107)')),
           yaxis = list( title = 'Cantidad',
             titlefont = list(size = 16, color = 'rgb(107, 107, 107)'),
             tickfont = list( size = 14, color = 'rgb(107, 107, 107)')),
         legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'group', bargap = 0.15, bargroupgap = 0.1)
  
  fig
  
```


#### Tabla
```{r datoEvolArg, echo=FALSE, message=FALSE, warning=FALSE}
   totalesArg <- argCov %>%
     select(dia, Detectados, Fallecidos, Recuperados)

    totalesArg %>% datatable(extensions = 'Buttons', rownames = FALSE,
                          colnames = c("Fecha", "Casos Detectados", "Fallecidos", "Recuperados"),
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



## Ultimos casos confirmados
À continuación se muestra la distribución por provincias de los casos confirmados el día  `r max(covidArg$FECHA)`.
Si presiona sobre los rectángulos mas pequeños ampliará la provincia/jurisdicción correspondiente.


```{r casosDia, echo=FALSE, message=FALSE, warning=FALSE}
 covidArg_hoy <- covidArg %>% 
      group_by(PROVINCIA) %>% filter(FECHA==max(FECHA)) %>% select(PROVINCIA,FECHA, CASOS) %>% unique()
  covidArg_hoy$PROVINCIA <- if_else(covidArg_hoy$PROVINCIA == "Ciudad de Buenos Aires", "CABA",  covidArg_hoy$PROVINCIA)
    
  covidArg_hoy$parents <- "Confirmados"
  plot_ly(data = covidArg_hoy,
          type= "treemap",
          values = ~CASOS,
          labels= ~PROVINCIA,
          parents=  ~parents,
          domain = list(column=0),
          name = "Confirmados",
          textinfo="label+value+percent parent") %>%
    layout(title = paste("Covid19 - Distribución de casos Confirmados el día ", max(covidArg_hoy$FECHA)))

```




## Promedios semanales
Los pormedios de casos confirmados y fallecidos semanales se muestran en el gráfico a continuación

```{r promSem, echo=FALSE, message=FALSE, warning=FALSE }
  promedios<-  argCov %>% select(dia, casosD, Altas, muertesD) %>% 
      mutate(casosP=roll_mean(casosD, n=7, align="right", fill = NA),
             altasP=roll_mean(Altas, n=7, align="right", fill = NA),
             muertesP=roll_mean(muertesD, n=7, align="right", fill = NA)) %>% 
  select(dia, casosP, altasP, muertesP) %>% unique()


  fig <- plot_ly(promedios, x = ~dia, y = ~muertesP, type = 'bar', name = 'Fallecidos', marker = list(color = 'rgba(222,45,38,0.8)'))
  fig <- fig %>% add_trace(y = ~altasP, type = 'bar', name = 'Altas', marker = list(color = '#66C2A5'))
  fig <- fig %>% add_trace(y = ~casosP, name = 'Casos', marker = list(color = 'rgb(55, 83, 109)'))
  
  fig <- fig %>% layout(title = '\n Promedio (7 días) de casos, altas y fallecimientos diarios',
           xaxis = list(
             title = "",
             tickfont = list(size = 14, color = 'rgb(107, 107, 107)')),
           yaxis = list(
             title = 'Cantidad',
             titlefont = list(size = 14, color = 'rgb(107, 107, 107)'),
             tickfont = list( size = 14, color = 'rgb(107, 107, 107)')),
         legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'group', bargap = 0.15, bargroupgap = 0.1)

    fig


```




## Composición por Edad
A continuación se grafican las pirámides poblacionales de casos confirmados y fallecimientos.

La composición de la siguiente pirámide poblacional de los casos confirmados fue confeccionada con los datos abiertos del Ministerio de Salud de la Nación.


### {.tabset  .tabset-fade .tabset-pills}
#### Casos confirmados
```{r piramide}
    
   edades <- edades %>% filter(!is.na(grupo) & sexo %in% c("F", "M"))
   edades$sexo <- if_else(edades$sexo=="M", "Hombre", "Mujer")  
   
   edades <- edades %>%  ungroup() %>% mutate(prop = round(cantidad/sum(cantidad)*100, 2))
   edades$porcent <- if_else(edades$sexo=="Hombre",  edades$prop*-1, edades$prop)   
   
   plot_ly(edades, x = ~porcent, y = ~grupo, color = ~sexo, width = 900) %>%
     add_bars(orientation = "h", hoverinfo = "y+text+name", 
           text =  ~paste(abs(round(porcent,1)), "%", '\n(',cantidad,')'),  
           textposition = 'outside', colors = c("#2c7fb8", "#fa9fb5")) %>%
     layout(bargap = 0.1, barmode = "overlay", 
            title = "Pirámide Poblacional de Casos Confirmados", 
            xaxis = list(tickmode = "array", 
                       tickvals = c(-100, -50, -25, -20, -15, -10, -5, 0, 5, 10, 15, 20, 25, 50, 100),
                       ticktext = c("100", "50%", "25%", "20%", "15%", "10%","5%", "0", "5%", "10%", "15%","20%", "25%", "50%", "100%"),
                       title = "Casos Confirmados"), 
            yaxis = list(title = "Grupo Edad"))

```

#### Fallecidos
```{r piramideFall}
   
     edades_m <- fallecidos_edad %>% filter(sexo %in% c("F", "M")) %>% ungroup() %>% 
           mutate(prop = round(cantidad/sum(cantidad)*100, 2)) %>% 
           select(grupo, genero=sexo, total=cantidad, prop)

     edades_m$genero <- if_else(edades_m$genero=="M", "Hombre", "Mujer")
     
     edades_m$prop <- if_else(edades_m$genero=="Hombre", edades_m$prop*-1, edades_m$prop)
     
     plot_ly(edades_m, x = ~prop, y = ~grupo, color = ~genero, width = 900) %>%
       add_bars(orientation = "h",
          hoverinfo = "y+text+name", 
          # text = ~paste(abs(prop), " %", '\n Cant.: (', total,')'), 
          text =  ~paste(abs(round(prop,1)), "%", '\n(',total,')'),  
          textposition = 'outside',
          colors = c("#2c7fb8", "#fa9fb5")) %>%
       layout(bargap = 0.1, barmode = "overlay", 
           title = "Piramide Poblaciónal de Personas Fallecidas", 
           xaxis = list(tickmode = "array",
                        tickvals = c(-100, -50, -25, -20, -15, -10, -5, 0, 
                                     5, 10, 15, 20, 25, 50, 100),
                        ticktext = c("100", "50%", "25%", "20%", "15%", "10%","5%", "0",
                                     "5%", "10%", "15%","20%", "25%", "50%", "100%"),
                        title = "Fallecidos"),
           yaxis = list(title = "Grupo Edad"))

```

#### Letalidad por Grupo
```{r let_Edad}

  let_edad <- edades %>% left_join(edades_m, by=c("sexo"="genero", "grupo"="grupo")) %>% 
    filter(!is.na(grupo)) %>% 
  mutate(let = round(total/cantidad*100, 1)) %>% select(sexo, grupo, let) %>% unique()

   plot_ly(let_edad, x=~let, y=~grupo, color=~sexo, width = 900) %>% 
       add_bars(orientation = "h",
        hoverinfo = "y+text", 
        text = ~paste(let, '%'), 
        textposition = 'outside',
        colors = c("#2c7fb8", "#fa9fb5")) %>% 
       layout( title = "Tasas de Letalidad por Grupo",
               xaxis = list(title = "Letalidad"), yaxis = list(title = "Grupo Edad"))

```






## Casos actuales por Provincia

La notificación de los casos por jurisdicción se realiza teniendo en cuenta la residencia según el Registro Nacional de las Personas, pudiendo variar en función de la investigación de la jurisdicción.
El Ministerio diariamente informa la cantidad de casos por provincia pudiendo rectificar luego cantidades de casos reasignados. 


####  {.tabset  .tabset-fade .tabset-pills}
##### Activos
La cantidad de casos Activos se ha calculado en base a los informes provinciales de los Ministerios de Salud, considerando los casos confirmados menos los recuperados/altas menos los fallecidos-
Debido a que no todas las provincias lo informan diariamente pueden existir algunas diferencias con las situaciones actuales.

```{r mapaActivos, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center',  out.height='100%'}
  activos <- casos_provincias %>% group_by(carga_provincia_nombre) %>% 
      mutate(activos=sum(activos)) %>% select(carga_provincia_nombre, activos) %>% unique()

  activos$carga_provincia_nombre <- if_else(activos$carga_provincia_nombre=="CABA", 
                                            "Ciudad de Buenos Aires",
                                            activos$carga_provincia_nombre)
  
  colors <- c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026")

  highchart(width = 900) %>%
     hc_title(text = "<i>Casos Activos COVID-19 por Provincia en Argentina</i> - <b>GIBD</b>",
              margin = 5, align = "center", 
              style = list(color = "#bd0026", useHTML = TRUE, fontWeight = "bold")) %>% 
          hc_tooltip(followPointer =  FALSE) %>%
          hc_add_series_map(argentina, activos, name = "Activos",
                            value = "activos", joinBy = c("name", "carga_provincia_nombre"),
                            dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
         hc_colorAxis(stops=color_stops(n=length(colors), colors = colors)) %>%
          hc_legend(align = "center", x = 0, y = -10) %>%
          hc_mapNavigation(enabled = TRUE) %>%
          hc_add_theme(hc_theme_ffx()) %>% 
          hc_add_annotation(xValue = 0, yValue = 0, 
                            title = list(text = 'Fuente: Ministerios de Salud Provinciales')) %>% 
          hc_chart(borderColor = "#bd0026",
             borderRadius = 10,
             borderWidth = 2)
               
```


##### Casos
```{r mapas, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
  covidArg_hoy <- covidArg %>% 
    group_by(PROVINCIA) %>% 
    mutate(total=sum(CASOS)) %>% select(PROVINCIA, total) %>% unique()

  highchart(width = 900) %>%
          hc_title(text = "<i>Mapa dinámico de COVID-19 en Argentina</i> - <b>GIBD</b>",
             margin = 5, align = "center",
             style = list(color = "#08338F", useHTML = TRUE)) %>% 
          hc_subtitle(text = "Casos detectados por provincia", align = "center",
                style = list(color = "#0C5C9E", fontWeight = "bold")) %>% 
          hc_tooltip(followPointer =  FALSE) %>%
          hc_add_series_map(argentina, covidArg_hoy, name = "Total",
                            value = "total", joinBy = c("name", "PROVINCIA"),
                            dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
          hc_colorAxis(minColor = "#B7D4EB", maxColor = "#08338F")  %>%
          hc_legend(align = "center", x = 0, y = -10) %>%
          hc_mapNavigation(enabled = TRUE) %>%
          hc_add_theme(hc_theme_ffx()) %>% 
          hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Datos Propios')) %>% 
          hc_chart(borderColor = "#08338F",
             borderRadius = 10,
             borderWidth = 2)
```

##### Fallecidos
```{r mapasFallArg, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
  muertosArg_hoy <- muertosArg %>% group_by(PROVINCIA) %>% mutate(total=sum(MUERTES, na.rm = T)) %>% 
   
  select(Provincia=PROVINCIA, total) %>% unique()


  highchart(width = 900) %>%
          hc_title(text = "<i>Mapa dinámico de COVID-19 en Argentina</i> - <b>Fallecidos</b>",
             margin = 5, align = "center",
             style = list(color = "#780000", useHTML = TRUE)) %>% 
          hc_subtitle(text = "Casos detectados por provincia",
                align = "center",
                style = list(color = "#780000", fontWeight = "bold")) %>% 
          hc_tooltip(followPointer =  FALSE) %>%
          hc_add_series_map(argentina, muertosArg_hoy, name = "Total",
                            value = "total", joinBy = c("name", "Provincia"),
                            dataLabels = list(enabled = TRUE,
                                              format = '{point.properties.woe-name}')) %>%
          hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
          hc_legend(align = "center", x = 0, y = -10) %>%
          hc_mapNavigation(enabled = TRUE) %>%
          hc_add_theme(hc_theme_ffx()) %>% 
          hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Datos Propios')) %>% 
          hc_chart(borderColor = "#780000",
             borderRadius = 10,
             borderWidth = 2)
```

##### Tabla
```{r tabProv, echo=FALSE, message=FALSE, warning=FALSE}
   
   tabla <- covidArg_hoy %>% left_join(muertosArg_hoy, by=c("PROVINCIA"="Provincia")) %>% 
      left_join(activos,  by=c("PROVINCIA"="carga_provincia_nombre")) %>% 
  select(PROVINCIA, total.x, total.y, activos)
   names(tabla) <- c("Provincia", "Confirmados", "Fallecidos", "Recuperados") 
   tabla$Fallecidos <- if_else(is.na(tabla$Fallecidos), 0, as.double(tabla$Fallecidos))
  
   tabla  %>%  kable( col.names =  c("Provincia", "Confirmados", "Fallecidos", "Recuperados"),
                           format.args = list( big.mark=".", decimal.mark = ","),
            align =  c('l', 'c', 'c', 'c') ) %>%  kable_styling()
  
```



## Distribución por Provincias
Los porcentajes que representa cada provincia de casos confirmados, fallecidos y activos se muestra a continuación

###  {.tabset  .tabset-fade .tabset-pills}
#### Confirmados
```{r distrProvConf}
  
   tabla$parents <- "Confirmados"
   plot_ly(data = tabla,
        type= "treemap",
        values = ~Confirmados,
        labels= ~Provincia,
        parents=  ~parents,
        domain = list(column=0),
        name = "Confirmados",
        textinfo="label+value+percent parent") %>%
  layout(title = "Covid19 - Distribución de casos Confirmados por provincia")

```

#### Fallecidos
```{r distrProvFall}
   tabla$parents <- "Fallecidos"
   plot_ly(data = tabla,
        type= "treemap",
        values = ~Fallecidos,
        labels= ~Provincia,
        parents=  ~parents,
        domain = list(column=0),
        name = "Fallecidos",
        textinfo="label+value+percent parent") %>%
  layout(title = "Covid19 - Distribución de casos Fallecidos por provincia")

```

#### Activos
```{r distrProvAct}

   activos$parents <- "Activos"
   plot_ly(data = activos,
        type= "treemap",
        values = ~activos,
        labels= ~carga_provincia_nombre,
        parents=  ~parents,
        domain = list(column=0),
        name = "Activos",
        textinfo="label+value+percent parent") %>%
  layout(title = "Covid19 - Distribución de casos Activos por provincia")

```






## Evolución por Provincia
A continuación se muestra la evolución de las curvas de los casos confirmados y fallecimientos por día para cada una de las provincias argentinas. Ambas curvas se muestran a escala libre y escala logaritmica.

También se muestra al final la media móvil (7 días) de los casos darios por provincia 

<!-- <!-- ### Evolución --> 
<!-- <iframe width="760" height="500" src="https://preview.flourish.studio/2125321/R0ECnRKTwlv1xuOmT0wP9XQuaG66nj0TPEgdMBACYQY9BWfIEXMnxfgX4EVUlm9O/" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe> -->

###  {.tabset  .tabset-fade .tabset-pills}
#### Casos
```{r ev_prov, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

  tabla_prov<- covidArg %>% 
    group_by(PROVINCIA, FECHA) %>% mutate(casos=sum(CASOS)) %>% select(PROVINCIA, FECHA, casos) %>% unique()
  tabla_prov$acumulados <-0
  tabla_prov$FECHA <- as.Date(tabla_prov$FECHA , "%d/%m/%Y")
  tabla_prov <- tabla_prov %>% ungroup() %>% group_by(PROVINCIA) %>% 
    arrange(PROVINCIA, FECHA) %>% 
    mutate(acumulados =cumsum(casos))
  
  tabla_prov <- tabla_prov %>%
    gather(casos, acum, -c(PROVINCIA, FECHA))
  names(tabla_prov) <- c("provincia", "fecha", "tipo", "cant")
  p <- tabla_prov %>%
    filter(cant>0&tipo=="acumulados") %>% 
    group_by(provincia) %>% arrange(fecha) %>% mutate(dia1 = row_number()) 
  
  fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~provincia, type = "scatter", mode='lines+markers') 
  fig <- layout(fig, autosize = F, width = 800, height=550,  # automargin = FALSE, margin = 1,
                title="Evolución de casos confirmados por Provincia",
                xaxis = list(title = "día"), yaxis = list(title = "casos"))
  
  fig

  
```


#### Casos (Log)
```{r ev_provLog, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}
    fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~provincia, type = "scatter", mode='lines+markers')
    fig <- layout(fig,  autosize = F, width = 800, height=550,  # automargin = FALSE, margin = 1,
                  title="Evolución de casos confirmados por Provincia (Log)",
                  xaxis = list(title = "día"), yaxis = list(type = "log", title = "casos"))
    fig

```



#### Fallecidos
```{r ev_provFall, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

   tabla_prov_m<- muertosArg %>% 
      group_by(PROVINCIA, FECHA) %>% mutate(muertes=sum(MUERTES, na.rm = T)) %>% select(Provincia=PROVINCIA, fecha=FECHA, muertes) %>% unique() 
  
      tabla_prov_m$acumulados <-0
      tabla_prov_m$fecha <- as.Date(tabla_prov_m$fecha , "%d/%m/%Y")
    
    tabla_prov_m <- tabla_prov_m %>% ungroup() %>% group_by(Provincia) %>% 
      arrange(Provincia, fecha) %>% 
      mutate(acumulados =cumsum(muertes))
    
    tabla_prov_m <- tabla_prov_m %>%
      gather(muertes, acumulados, -c(Provincia, fecha))
    
    names(tabla_prov_m) <- c("provincia", "fecha", "tipo", "cant")
   
    p <- tabla_prov_m %>%
      filter(cant>0&tipo=="acumulados") %>% 
      group_by(provincia) %>% arrange(fecha) %>% mutate(dia1 = row_number()) 
    
    fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~provincia, type = "scatter", mode='lines+markers') 
    fig <- layout(fig,  autosize = F, width = 800, height=550, #  automargin = FALSE, margin = 1,
                  title="Evolución fallecidos por Provincia",
                  xaxis = list(title = "día"), yaxis = list(title = "fallecimientos"))
    fig

```


#### Fallecidos (Log)
```{r ev_provFallLog, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}
    fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~provincia, type = "scatter", mode='lines+markers') 
    fig <- layout(fig,  autosize = F, width = 800, height=550, #  automargin = FALSE, margin = 1,
                  title="Evolución fallecidos por Provincia",
                  xaxis = list(title = "día"), yaxis = list(title = "fallecimientos", type = "log"))
    fig

```




### Promedios diarios
Para seleccionar sólo una provincia haga doble click sobre el nombre de la misma en la leyenda
```{r promProvSem, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%' }
  
  prom <- tabla_prov %>% 
    group_by(provincia) %>% filter(tipo=="casos") %>% 
    mutate(prom= round(roll_mean(cant,  n=7, align="right", fill = NA), 0)) %>%  
    filter(!is.na(prom) & prom>0)

  fig <- plot_ly(prom, x = ~fecha, y = ~prom, color = ~provincia, type = "bar") #, mode='lines+markers') 
  fig <- layout(fig,
                 autosize = F, width = 800, height=550,#   automargin = FALSE, margin = 1,
                title="Evolución de casos diarios por Provincia \n (promedio de 7 días)",
                xaxis = list(title = "día"), yaxis = list(title = "casos"))
  fig

```



### Incidencia diaria
Para seleccionar sólo una provincia haga doble click sobre el nombre de la misma en la leyenda
```{r incProvDiaria, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%' }
  
  incidProv <- tabla_prov %>% left_join(poblacionArg) %>% filter(tipo=="casos") %>% 
    mutate(incid = round(cant/poblacion*100000, 1),
           IncP = round(roll_mean(incid,  n=7, align="right", fill = NA), 0)) %>% 
    select(provincia, fecha, tipo, cant, incid, IncP)
    # group_by(provincia) %>% filter(tipo=="casos") %>% 
    # mutate(prom= round(roll_mean(cant,  n=7, align="right", fill = NA), 0)) %>%  
    # filter(!is.na(prom) & prom>0)

  fig <- plot_ly(incidProv, x = ~fecha, y = ~IncP, color = ~provincia, alpha = 1,  size = 20, type = 'area') #,"bar" mode='lines+markers') 
  fig <- layout(fig,  autosize = F, width = 800, height=550,# 
                title="Evolución de la Incidencia diaria por Provincia",
                xaxis = list(title = "día"), yaxis = list(title = "casos c/100 mil Hab"))
  fig

```



### Días Transcurridos

Los días transcurridos dese que el Ministerio de Salud de Nación no reporta casos para cada una de las provincias son:

```{r diasProv}

   dias <- tabla_prov %>% filter(tipo== "casos" & cant > 0) %>% group_by(provincia) %>% 
      mutate(ultimo=max(fecha)) %>% select(provincia, ultimo) %>% unique() %>%  
      mutate(sincasos= (today()-ultimo),
             col=if_else(sincasos < 2, "#d7191c", if_else(sincasos < 5,"#d6604d",
                   if_else(sincasos < 15, "#a6d96a", "#1a9641")))) %>% 
     arrange(desc(sincasos),desc(provincia))
  
  # dias$sincasos_m <- dias$sincasos+1
  ax <- list(title = "días",
             zeroline = FALSE,
             showline = FALSE,
             showticklabels = FALSE,
             showgrid = FALSE)
  
   fig <- plot_ly(dias, type="bar", colors = ~unique(col)) 
   fig <- fig %>% add_trace( x = ~sincasos+1, y = ~provincia, name= "Días",
                            color=~col, text=~sincasos, textposition = 'auto', 
                            textfont = list(color = 'rgb(0,0,0)'), 
                            mode="lines",
                               showlegend = FALSE,
                               line = list(width = 15)) %>% 
      layout(title="Días Transcurridos Sin reportar nuevos casos", 
             xaxis = ax,
             yaxis=list(title=""))
   fig
   
```





## Incidencia Acumulada

La incidencia acumulada (IA) proporciona una estimación de la probabilidad o el riesgo de que un individuo, libre de una determinada enfermedad, la desarrolle durante un período específico de tiempo.

En Argentina, considerando una población de 45.376.763 (Proyección estimada por INDEC), la tasa de incidencia acumulada nacional es de `r round(sum(argCov$casosD)/45376763 * 100000, 1)` cada 100 mil habitantes.

Al día de la fecha las incidencias acumuladas por cada 100.000 habitantes en la provincias de Argentina son: 

###  {.tabset  .tabset-fade .tabset-pills}
#### Mapa

```{r mapIAArg, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
  ia_prov <- tabla_prov %>%
    filter(tipo == "acumulados") %>%
    group_by(provincia) %>%
    filter(fecha == max(fecha)) %>%
    select(provincia, cant) %>%
    left_join(poblacionArg) %>% 
    mutate(ia= round(cant/poblacion * 100000, 0)) %>%
    arrange(desc(ia))

 
  
  highchart() %>%
    hc_title(text = "<i>Incidencia Acumulada COVID-19 en Argentina</i> ",
             margin = 20, align = "center", style = list(color = "#780000", useHTML = TRUE)) %>%
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(argentina, ia_prov, name = "IA", value = "ia", joinBy = c("name", "provincia"),
                      dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
    hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud - INDEC')) %>% 
    hc_chart(borderColor = "#780000", borderRadius = 10, borderWidth = 2)

```


#### Datos

```{r iAProvD}

  ia_prov$provincia <- if_else(ia_prov$provincia=="Ciudad de Buenos Aires", "CABA", ia_prov$provincia)

  tabiaprov <- ia_prov %>% select(provincia, cant, ia) %>% arrange(desc(ia))
  tabiaprov$provincia <- if_else(tabiaprov$provincia=="Ciudad de Buenos Aires", "CABA", tabiaprov$provincia)
  tabiaprov %>%  datatable(extensions = 'Buttons', rownames = FALSE,
                          colnames = c("Provincia", "Casos Detectados", "Incidencia cada 100.000 Hab."),
              options = list(dom = 'Blfrtip', buttons = c('csv', 'excel', 'pdf'),
                           lengthMenu = list(c(10,25,50,-1), c(10,25,50,"All"))))
  
```

#### Gráfica
```{r sud_tasainc, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%', fig.align='center'}
 

  fig <- plot_ly(tabiaprov, type="bar")
  fig <- fig %>% add_trace( x = ~provincia, y = ~ia, name="Incidencia",
                            color= ~(-ia),
                            text=~ia, textposition = 'auto',
                            mode="lines",
                            line = list(width = 5)) %>% 
    hide_colorbar() %>%
    layout(title="Covid-19 Incidencia por Provinciass",  
           xaxis = list(), yaxis=list(title="Casos x 100.000 Hab."))
  
  fig %>% layout(showlegend=F)
       
```




## Letalidad en Argentina

En la actualidad (`r max(totalesArg$dia)`) en Argentina, la **tasa de mortalidad particular o letalidad** es de `r round(totalesArg$Fallecidos[totalesArg$dia==max(totalesArg$dia)]/totalesArg$Detectados[totalesArg$dia==max(totalesArg$dia)] * 100, 2)`%, mientras que el **porcentaje pacientes recuperados** es del `r round(totalesArg$Recuperados[totalesArg$dia==max(totalesArg$dia)]/totalesArg$Detectados[totalesArg$dia==max(totalesArg$dia)] * 100, 2)`%.

La tasa de Letalidad a nivel nacional ha evolucionado como lo muestra la siguiente gráfica.

```{r evolLetalArg, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%' }
    evolLet <- argCov %>% mutate(let = round(Fallecidos/Detectados * 100, 1) ) %>% 
      select(dia, Detectados, Fallecidos, let) %>% arrange(dia)
    evolLet$dia <- as.Date(evolLet$dia, "%d/%m/%Y")
    
    plot_ly(evolLet, x = ~dia, y = ~let, type = "bar", name = "Letalidad en Argentina",
           texttemplate = '%{y:.2s}', textposition = 'outside') %>% 
          layout(xaxis=list(title=""), yaxis = list(title = "Letalidad en Argentina"))

```




## Tasa de Mortalidad
La **tasa de mortalidad general** de cada una de las provincias viene dada por comparar la cantidad de personas fallecidas respecto a la población total de la provincia.

###  {.tabset  .tabset-fade .tabset-pills}
#### Gráfica
```{r sud_tasa_mort, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%', fig.align='center'}
  p <- muertosArg  %>% group_by(PROVINCIA) %>% mutate(fall = sum(MUERTES, na.rm = T)) %>% 
    select(PROVINCIA, fall) %>% unique() %>% 
    left_join(poblacionArg, by = c("PROVINCIA"="provincia")) %>% 
    mutate(tasa_mor = round(fall/poblacion * 1000000, 0)) %>% arrange(desc(tasa_mor))
  
p$PROVINCIA <- if_else(p$PROVINCIA=="Ciudad de Buenos Aires", "CABA", p$PROVINCIA)
  fig <- plot_ly(p, type="bar")
  fig <- fig %>% add_trace( x = ~PROVINCIA, y = ~tasa_mor, name="Mortalidad",
                            color= ~(-tasa_mor),
                            text=~tasa_mor, 
                            textposition = 'auto',
                            mode="lines",
                            line = list(width = 5)) %>% 
    hide_colorbar() %>%
    layout(title="Covid-19 Mortalidad por Provincias",  
           xaxis = list(), yaxis=list(title="Fall. x 1000000 Hab."))
  
  fig %>% layout(showlegend=F)
       
```


#### Datos
Los datos de la mortalidad por provincias al `r  max(muertosArg$FECHA)` son:
```{r d_tasa_mortalid, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%', fig.align='center'}
p %>% select(PROVINCIA, fall,  tasa_mor) %>% 
   datatable(extensions = 'Buttons', rownames = FALSE,
                          colnames = c("Provincia", "Fallecidos", "Mortalidad"),
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



<!-- El `r round(nrow(muertosArg[muertosArg$genero=="Hombre", ])/nrow(muertosArg) * 100, 1)` % de los fallecidos son Hombres, mientras que el `r round(nrow(muertosArg[muertosArg$genero=="Mujer", ])/nrow(muertosArg) * 100, 1)` % restante corresponde a Mujeres. -->

<!-- La edad media de los pacientes fallecidos es de `r round(mean(muertosArg$edad, na.rm = T), 0)` años, y en particular la edad media de los Hombres fallecidos es de `r round(mean(muertosArg$edad[muertosArg$genero=="Hombre"], na.rm = T), 0)` años y en la Mujeres de `r round(mean(muertosArg$edad[muertosArg$genero=="Mujer"], na.rm = T), 0)` años. -->

<!-- En el siguiente gráfico se observa la distribución de los pacientes fallecidos por sexo y edad. -->

```{r fallArg, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

  # ggplot(muertosArg, aes(x=genero, y=edad, fill= genero) )+
  #     geom_violin(alpha=0.6) +
  #     labs( 
  #          subtitle="Distribución de fallecidos según el sexo y la edad", 
  #          caption="Fuente: Ministerio de Salud", 
  #          y="Edad", 
  #          x="Sexo",
  #          color=NULL) +  
  # scale_fill_manual( values = c("lightsteelblue", "lightpink1"),
  #                    name= "Sexo", breaks = c("Hombre", "Mujer"), labels = c("Hombre", "Mujer"))

```




## Letalidad por Provincias
En base a las provincias de residencia de los fallecidos, informadas por el Ministerio de Salud Nacional, y considerando las cantidades actualizadas de casos en cada provincia se obtienen las siguientes tasas de letalidad a nivel provincial


###  {.tabset  .tabset-fade .tabset-pills}
#### Mapa
```{r mapLEtArg, echo=FALSE, message=FALSE, warning=FALSE,  fig.align='center', paged.print=FALSE}

  let_prov <- muertosArg %>% group_by(PROVINCIA) %>% 
    mutate(cantidad = sum(MUERTES, na.rm = T)) %>% 
    select(Provincia = PROVINCIA, cantidad) %>% unique() %>% 
    left_join(ia_prov, by=c("Provincia"="provincia")) %>% 
    select("Provincia", "cantidad", "cant") %>% 
  mutate(letalidad = round(cantidad/cant * 100, 1))


  highchart() %>%
    hc_title(text = "<i>Letalidad por COVID-19 en Argentina</i> ",
             margin = 20, align = "center", style = list(color = "#780000", useHTML = TRUE)) %>%
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(argentina, let_prov, name = "Let", value = "letalidad", 
                      joinBy = c("name", "Provincia"), 
                      dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
    hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud')) %>% 
    hc_chart(borderColor = "#780000", borderRadius = 10, borderWidth = 2)

```



#### Datos
```{r datLetProv, echo=FALSE,message=FALSE, warning=FALSE}
  let_prov$Provincia <- if_else(let_prov$Provincia=="Ciudad de Buenos Aires", "CABA", let_prov$Provincia)

  tabla <- tabiaprov %>% left_join(let_prov, by=c("provincia"="Provincia")) %>% 
  select(provincia, casos=cant.x, ia, fallecidos=cantidad, letalidad)

  tabla %>%  datatable(extensions = 'Buttons', rownames = FALSE,
                          colnames = c("Provincia", "Casos Detectados", "Incidencia cada 100.000 Hab.",
                                       "Fallecidos", "% Letalidad"),
              options = list(dom = 'Blfrtip', buttons = c('csv', 'excel', 'pdf'),
                           lengthMenu = list(c(10,25,50,-1), c(10,25,50,"All"))))
  
```



## Distribución de Casos por Tipo
Los tipos de Casos confirmados se clasifican en:
*Importados* (cuando se registra trasmisión relacionada viajes al exterior del país)

*Contacto estrecho/Conglomerado*: casos en los que se puede determinar la cadena de transmisión por contacto estrecho con infectados

*Comunitario*: aquellos casos en los que no se puede relacionar a los casos confirmados con cadenas de trasmisión conocidas. 

*Investigación*: casos que se encuentran en estudio para definir el tipo de transmisión. En algún momento tiene que pasar a alguno de los otros 3 casos

La evolución y distribución de los casos según el tipo en Argentina es:


###  {.tabset  .tabset-fade .tabset-pills}
#### Distribución
```{r distrCasos, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

  distCasos <- argCov %>% mutate(porImportados = Importados/Detectados,
                                porEstrecho = Estrecho/Detectados,
                                porComunitaria = Comunitaria/Detectados,
                                porInvestigacion = Investigacion/Detectados) %>% 
    select(dia, porImportados, porEstrecho, porComunitaria, porInvestigacion) %>% arrange(dia)
  
  distCasos$dia <- as.Date(distCasos$dia, '%d/%m/%Y')
 
  plot_ly(distCasos, x = ~dia, y = ~porInvestigacion, type = "bar", name = "En Investigación", color = I("orchid3"),
          hoverinfo = 'text',
          text = ~paste('</br> Fecha: ', dia ,
                        '</br> Importados: ', round(porImportados*100, 2),'%',
                      '</br> Contactos Estrechos: ', round(porEstrecho*100, 2),'%',
                      '</br> Circulación Comunitaria: ', round(porComunitaria*100, 2),'%',
                      '</br> En Investigación: ', round(porInvestigacion*100, 2),'%')) %>% 
    add_trace(y = ~porComunitaria, name = "Circulación Comunitaria", color = I("indianred3")) %>% 
    add_trace(y = ~porEstrecho, name = "Contactos Estrechos", color = I("olivedrab3")) %>% 
    add_trace(y = ~porImportados, name = "Importados",  color = I("steelblue3")) %>% 
    layout(yaxis = list(title = "% según Tipo de Caso", tickformat = "%"), 
           xaxis=list(title=""),
           barmode = "stack",
           legend = list(orientation = 'h', font = list(size = 10)))
  
```



#### Cantidades
```{r estudioCasos, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

  tipoCaso <- argCov %>% select(dia, Importados, Estrecho, Comunitaria, Investigacion)
  
  tipoCaso$dia <- as.Date(tipoCaso$dia, '%d/%m/%Y')
 
  plot_ly(tipoCaso, x = ~dia, y = ~Importados, type = "bar", name = "Importados",  color = I("steelblue3"),
          hoverinfo = 'text',
          text = ~paste('</br> Importados: ', Importados,
                      '</br> Contactos Estrechos: ', Estrecho,
                      '</br> Circulación Comunitaria: ', Comunitaria,
                      '</br> En Investigación: ', Investigacion)) %>% 
    add_trace(y = ~Estrecho, name = "Contactos Estrechos", color = I("olivedrab3")) %>% 
    add_trace(y = ~Comunitaria, name = "Circulación Comunitaria", color = I("indianred3")) %>% 
    add_trace(y = ~Investigacion, name = "En Investigación",  color = I("orchid3")) %>% 
    layout(yaxis = list(title = "Tipos de casos"), barmode = "stack",
           legend = list(x = 0.029, y = 1.038, font = list(size = 10)))
  
```

## Test


Desde el día 16/03/2020 el Ministerio de Salud comenzó a informar la cantidad de pruebas diagnósticas y casos descartados de COVID-19.
A continuación se visualiará la evolución en la proporción de los casos detectados sobre la cantidad de pruebas analizadas, la cantidad de test realizados hasta la fecha y la proporción de la cantidad de test por millón de habitantes

####  {.tabset  .tabset-fade .tabset-pills}
##### Tasa de Positividad
A continuación se visualiará la evolución en la proporción de los casos detectados sobre la cantidad de pruebas analizadas. 
```{r test, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}
 
 test <- argCov %>% select(dia, DescTest, Detectados, Recuperados, MuestraD) %>%
         mutate(total = DescTest + Detectados)
  test <- test %>% filter(DescTest >= 0) %>%  mutate(prop= round(Detectados/total * 100, 2)) %>% arrange(dia)
  test$dia <-as.Date(test$dia, "%d/%m/%Y")
  
  plot_ly(test, x = ~dia, y = ~prop, type = "bar", name = "Tasa de Positividad",
           texttemplate = '%{y:.3s}', textposition = 'outside') %>% 
    layout(title="Tasa de Positividad", xaxis=list(title=""), yaxis = list(title = "Tasa de Positividad (%)"))

```

##### Cantidades
```{r propTestD, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}
  p4 <- plot_ly(test, x = ~dia, y = ~DescTest, type = "bar", name = "Test Negativos") %>% 
            add_trace(y = ~Detectados, name = "Test Positivos") %>% 
        layout(title="Cantidad de Test Realizados", yaxis = list(title = "Acumulado de Pruebas Realizadas"), barmode = "stack")
  p4
  
```


#### Positividad por Provincia
```{r positProv, out.width='100%'}
    testProv <- positiv_lab %>% 
            group_by(carga_provincia_nombre)%>% arrange(fecha_apertura) %>% 
            filter(fecha_apertura > "2020-04-30" & fecha_apertura!=max(fecha_apertura)) %>% 
            mutate(positP=roll_mean(positividad, n=7, align="right", fill = NA)) %>% 
            select(carga_provincia_nombre, fecha_apertura, positP) 

  # testProv <- casos_pronvinciales %>% 
  #           group_by(carga_provincia_nombre)%>% arrange(fecha_apertura) %>% 
  #           filter(fecha_apertura > "2020-04-30" & fecha_apertura!=max(fecha_apertura)) %>% 
  #           mutate(positP=roll_mean(positividad, n=7, align="right", fill = NA)) %>% 
  #           select(carga_provincia_nombre, fecha_apertura, positP) 
      
      fig <- plot_ly(testProv, x = ~fecha_apertura, y = ~positP, 
                    color = ~carga_provincia_nombre, type = "scatter", mode='lines+markers') 
      fig <- layout(fig,   autosize = F, width = 800, height=550,# 
                    title="Evolución de la Tasa de Positividad por Provincia \n (promedio a 7 días)",
                    xaxis = list(title = "día"), yaxis = list(title = "% Posit."))
      fig

```



## Casos por Inicio de Síntomas
Considerando la fecha de inicio de síntomas, o en caso de no existir la menor entre las fechas de apertura o diagnóstico se obtienen las siguientes curvas para cada provincia.
* Para seleccionar una sola o mas hacer doble clik sobre el nombre de la/s misma/s en la leyenda
```{r iniSint, out.width='100%'}
  confirmados <- casos_pronvinciales %>% filter(clasificacion_resumen=="Confirmado")
  
  confirmados$fis <- if_else(is.na(confirmados$fecha_inicio_sintomas),
                           min(confirmados$fecha_apertura, confirmados$fecha_diagnostico), 
                           confirmados$fecha_inicio_sintomas)
  confirmados$fis<- as.Date(confirmados$fis, "%d/%m/%Y")

  tProv <- confirmados %>%  arrange(fis) %>% 
            group_by(carga_provincia_nombre, fis) %>% 
            mutate(casos = n()) %>% 
            select(carga_provincia_nombre, fis, casos) %>% unique()
  
  fig <- plot_ly(tProv, x = ~fis, y = ~casos, color = ~carga_provincia_nombre, type = "bar") 
  fig <- layout(fig,   autosize = F, width = 800, height=550,# 
                title="Evolución de Casos por Fecha de Inicio de Síntomas",
                xaxis = list(title = "día"), yaxis = list(title = "casos"))
  fig
  
  
```





## Fallecidos por Fecha de Fallecimiento
En la siguiente gráfica se muestra la cantidad de fallecidos diarios considerando la fecha en que se producen los decesos y no la fecha en que son reportadas. 
Para este gráfico se considera la provincia que carga el caso cuando no se especifique la provincia de residencia de la persona

* Para seleccionar una sola o mas hacer doble clik sobre el nombre de la/s misma/s en la leyenda
```{r fallFeFall, out.width='100%'}
  fallecidos <- casos_pronvinciales %>% filter(clasificacion_resumen=="Confirmado" & !(is.na(fecha_fallecimiento)))
 

  fallecidos$fecha_fallecimiento<- as.Date(fallecidos$fecha_fallecimiento, "%d/%m/%Y")

  fallecidos$residencia_provincia_nombre <- if_else(is.na(fallecidos$residencia_provincia_nombre),
                                                    fallecidos$carga_provincia_nombre,
                                                    fallecidos$residencia_provincia_nombre)
  
  # write.csv(tProv, "tProv.csv")
  # write.csv(tProvF, "tProvF.csv")
  
  tProvF <- fallecidos %>%  arrange(fecha_fallecimiento) %>% 
            group_by(residencia_provincia_nombre, fecha_fallecimiento) %>% 
            mutate(fall = n()) %>% 
            select(provincia = residencia_provincia_nombre, fecha=fecha_fallecimiento, fall) %>% unique()
  
  fig <- plot_ly(tProvF, x = ~fecha, y = ~fall, color = ~provincia,  text= ~fall,  textposition = 'outside',
                 type = "bar") 
  fig <- layout(fig,   autosize = F, width = 800, height=550,# 
                title="Fallecidos por Fecha de Fallecimiento",
                xaxis = list(title = "día"), yaxis = list(title = "fallecidos"))
  fig
  
  
```