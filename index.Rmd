---
title: "COVID-19"
knit: (function(inputFile, encoding) { 
         rmarkdown::render(inputFile,
                           encoding=encoding, 
                           output_file=file.path(dirname(inputFile), 'docs', 'index.html')) })
output: 
  html_document:
    toc: true
    toc_float:
       collapsed: true 
       smooth_scroll: false
  github_document: default
runtime: shiny
---

```{r setup, include=FALSE}
  knitr::opts_chunk$set(
    # cache = TRUE,
  	echo = FALSE,
  	message = FALSE,
  	warning = FALSE
  )
```

```{r importar, message=FALSE, warning=FALSE, include=FALSE}
   library(readr)
   library(dplyr)
   library(tidyr)
   library(ggplot2)
   library(lubridate)
   library(knitr)
   library(kableExtra)
   library(highcharter)
   library(rjson)
   library(plotly)
   library(gganimate)
   library(stringr)
   library(leaflet)
   library(sf)
   library(tmap)
   library(googlesheets4)
   library(readxl)
   # library(shiny)

sep.miles <- function(x){format(x,big.mark=".")}
 
  #################
  # Carga de Datos
  #################

  ## Datos mundiales
    { # Confirmados
      covid19 <- read_csv("https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")

      covid19 <- covid19[-1]
      
      # Fallecidos
      covid19_m <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
      # covid19_m <- read_csv("https://github.com/CSSEGISandData/COVID-19/blob/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
      covid19_m <- covid19_m[-1]
      
    # Recuperados
      covid_19_r <- read_csv("https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")
    covid_19_r <- covid_19_r[-1]
    }  

  ## Mapas y Poblaciones
    {
      argentina <- fromJSON(file = "data/mapas/ar-all.geo.json")
      sud <- fromJSON(file="data/mapas/south-america.geo.json")
      world <- fromJSON(file="data/mapas/world.geo.json")
   
      deptos <- st_read(dsn ="data/mapas/departamentos.shp") 
      amba_dptos <- st_read(dsn ="data/mapas/AMBA_dptos.shp")
     
      entrerios <- fromJSON(file="data/mapas/entrerios_dpto.geo.json")
      deptos_er <- st_read(dsn ="data/mapas/departamentos_entrerios.shp") 
  
      amba_loc <-read_delim("data/poblaciones/AMBA.csv", ";", escape_double = FALSE, 
                            locale = locale(encoding = "ISO-8859-1"), trim_ws = TRUE)
         
      localidades <- read_csv("data/mapas/localidades.csv", 
                              locale = locale(encoding = "ISO-8859-1"))
      
      # Paises América
      poblacion <- data.frame( c('Argentina', 'Bolivia', 'Brazil', 'Chile', 'Colombia', 'Ecuador',
                                 'Paraguay',	'Peru',	'Surinam', 'Uruguay',  'Venezuela'),
                               c(44938712, 11383094,	210147125, 19107216, 50372424, 17300000,
                                 7152703, 33105273,524000, 3529014, 28067000))
      names(poblacion) <- c('pais', 'poblacion')
      # poblacion_arg <- read_delim("data/poblaciones/prov_argentina.csv", ";", escape_double = FALSE,
      #                                locale = locale(decimal_mark = ",", encoding = "ISO-8859-1"),
      #                               trim_ws = TRUE)
  }  

  ## Dataset Mundial
    {
      mundial <- covid19[,-c(2,3)]
      mundial <- mundial %>% gather(fecha, casos, 2:max(col(mundial)), -`Country/Region`) 
      names(mundial) <- c('pais', 'fecha', 'confirmados')
      mundial$pais <- if_else(mundial$pais==	'US', 'United States of America', mundial$pais)
      
      mundial <- mundial %>% group_by(pais, fecha) %>% 
        mutate(casos =  sum(confirmados)) %>% 
        select(pais, fecha, casos) %>% unique()
      
      mundial$fecha <-paste0(mundial$fecha,'20')
      mundial$fecha <-as.Date(mundial$fecha ,"%m/%d/%Y")
      
      mundial<-mundial %>%
        filter(casos > 0) %>% 
        group_by(pais) %>% 
        arrange(pais,fecha) %>% 
        mutate(dia= 1:n())
      
      mundial_r <- covid_19_r[,-c(2,3)]
         
      mundial_r <- mundial_r %>% gather(fecha, recuperados, 2:max(col(mundial_r)), -`Country/Region`) 
      names(mundial_r) <- c('pais', 'fecha', 'recuperados')
      mundial_r$pais <- if_else(mundial_r$pais==	'US', 'United States of America', mundial_r$pais)
      
      mundial_r <- mundial_r %>% group_by(pais, fecha) %>% 
        mutate(recuperados =sum(recuperados)) %>% select(pais, fecha, recuperados) %>% unique()
      
      mundial_r$fecha <-paste0(mundial_r$fecha,'20')
      mundial_r$fecha <-as.Date(mundial_r$fecha ,"%m/%d/%Y")
      
      mundial_r<-mundial_r %>%
        filter(recuperados > 0) %>% 
        group_by(pais) %>% 
        arrange(pais,fecha) %>% 
        mutate(dia= 1:n())
      
      mundial_m <- covid19_m[,-c(2,3)]
         
      mundial_m <- mundial_m %>% gather(fecha, casos, 2:max(col(mundial_m)), -`Country/Region`) 
      names(mundial_m) <- c('pais', 'fecha', 'muertes')
      mundial_m$pais <- if_else(mundial_m$pais==	'US', 'United States of America', mundial_m$pais)
      
      mundial_m <- mundial_m %>% group_by(pais, fecha) %>% 
        mutate(muertes =sum(muertes)) %>% select(pais, fecha, muertes) %>% unique()
      
      mundial_m$fecha <-paste0(mundial_m$fecha,'20')
      mundial_m$fecha <-as.Date(mundial_m$fecha ,"%m/%d/%Y")
      
      mundial_m<-mundial_m %>%
        filter(muertes > 0) %>% 
        group_by(pais) %>% 
        arrange(pais,fecha) %>% 
        mutate(dia= 1:n())
      
       mundial_ambos <- mundial %>% 
        left_join(mundial_m, by=c('pais', 'fecha')) %>% 
        left_join(mundial_r, by=c('pais', 'fecha')) %>%  select(pais, fecha, dia.x, casos, muertes, recuperados)
      
      mundial_ambos$muertes <- if_else(is.na(mundial_ambos$muertes), 0, mundial_ambos$muertes)
      mundial_ambos$recuperados <- if_else(is.na(mundial_ambos$recuperados), 0, mundial_ambos$recuperados)
       
      names(mundial_ambos) <- c("pais", "fecha", "dia", "casos", "muertes", "recuperados")
      mundial_ambos$fecha <-as.Date(mundial_ambos$fecha ,"%m/%d/%Y")
      
      
      rm(mundial_m, mundial, mundial_r)
    
      }
    
  ## Dataset Paises mas afectados y Arg
    { 
       mayores <- c('China', 'France', 'US', 'Spain', 'Italy',  'Germany', 'Argentina')#, 'Korea, South')
      
      afectados <- mundial_ambos %>% 
        filter(pais %in% mayores) %>% 
        select(pais, fecha, casos, muertes,  dia) %>% 
        arrange(pais,fecha) 
  
        afectados$muertes <- if_else(is.na(afectados$muertes), 0, afectados$muertes)
        
        afectados$pais <- gsub("US", "EEUU", afectados$pais)
        afectados$pais <- gsub("Spain", "EspaÃ±a", afectados$pais)
        afectados$pais <- gsub("Korea, South", "Corea del Sur", afectados$pais)
        afectados$pais <- gsub("Italy", "Italia", afectados$pais)
        afectados$pais <- gsub("Germany", "Alemania", afectados$pais)
        afectados$pais <- gsub("France", "Francia", afectados$pais)
        rm(masAfectados, masAfectados_m)
    }
    

  ## Dataset Sudamérica
    { 
      sudamerica <- mundial_ambos %>% 
        filter(pais %in% poblacion$pais) 
      
      sudamerica <- sudamerica %>% group_by(pais) %>% mutate(nuevos = casos-lag(casos))
      
      sudamerica$nuevos <- if_else(is.na(sudamerica$nuevos)&sudamerica$dia==1, 
                                   sudamerica$casos, sudamerica$nuevos)
      
      sudamerica$semanal <- 0
        for(p in sudamerica$pais){
          for(i in 8:max(sudamerica$dia[sudamerica$pais==p])){
            semanal <- sum(sudamerica$nuevos[((sudamerica[,"pais"]==p)&
                                                (sudamerica[,"dia"]<=i)&(sudamerica[,"dia"]>=(i-6)))])
            sudamerica$semanal[((sudamerica[,"pais"]==p) &
                                  (sudamerica[,"dia"]==i))] <- if_else(semanal >0, semanal, 0)
          }}

    sudamerica$muertes <- if_else(is.na(sudamerica$muertes), 0, sudamerica$muertes)
  }
    
  ## Dataset Argentina
    {  
      ### Totales generales
      argCov <- read_delim("data/argentina_gral.csv", ";", 
                           escape_double = FALSE, trim_ws = TRUE, 
                           locale = locale(encoding = "ISO-8859-1"))
      names(argCov) <- c("dia", "casosD", "Detectados", "muertesD", "Fallecidos", "Recuperados",
                      "UTI","MuestraD","TotalPruebas","DescEpidemiologia", "DescTest", "Descartados", 
                      "Mujeres", "Hombres", "Importados", "Estrecho", "Comunitaria", "Investigacion")
      argCov$dia <- as.Date(argCov$dia, '%d/%m/%Y')
      
      poblacionArg <- read_delim("data/poblaciones/prov_argentina.csv", ";", escape_double = FALSE,
                                 locale = locale(decimal_mark = ",", grouping_mark = ".",
                                                 encoding = "ISO-8859-1"), trim_ws = TRUE)
       
      ### Detalle por provincias
      covidArg <- read_delim("data/casos_provincias.csv", ";", 
                            escape_double = FALSE, trim_ws = TRUE, locale = locale(encoding = "ISO-8859-1"))
      covidArg$FECHA <- as.Date(covidArg$FECHA, '%d/%m/%Y')
    
      ### Detalle fallecidos
      muertosArg <- read_delim("data/argentina_fallecidos.csv", ";", 
                               escape_double = FALSE, trim_ws = TRUE, locale = locale(encoding = "ISO-8859-1"))
      
   }
  
  ## Dataset Provincias Argentinas
    {
    
       casos_pronvinciales <- read_excel("data/covid_departamental.xlsx")
           names(casos_pronvinciales) <- c("provincia", "departamento",  "localidad","fecha",
                                       "cantidad", "recuperados", "fallecidos", "internados", 
                                       "uti", "enestudio", "aislados", "estudiados", "descartados")
 
       
       ###
       # provincias_hoy <- read_excel("data/provincias_hoy.xlsx")
       
       ### ENTRE RIOS
       covid_er <- read_delim("data/entre_rios_casos.csv", ";", escape_double = FALSE, 
                              locale = locale(encoding = "ISO-8859-1"), trim_ws = TRUE)
       poblac_er <-  read_delim("data/poblaciones/poblacion_entre_rios.csv",  ";", escape_double = FALSE, 
                           locale = locale(decimal_mark = ",", 
                                           grouping_mark = ".", encoding = "ISO-8859-1"), trim_ws = TRUE)
       names(poblac_er) <- c("departamento", "poblacion")
    }
  
     color <- function(d){
          c <- if_else(d==0, '#FFFFFF',
               if_else(d < 25, '#fdd49e',
               if_else(d < 50, '#fc8d59',
               if_else(d < 75, '#d7301f',
               if_else(d < 100, '#b30000',
                       "#7f0000")))))
         return(c)}
  
       urlign <- "https://wms.ign.gob.ar/geoserver/gwc/service/tms/1.0.0/capabaseargenmap@EPSG%3A3857@png/{z}/{x}/{-y}.png"
       
```



> Análisis realizado por el Grupo de Investigación en Bases de Datos - UTN - FRCU
> <http://www.frcu.utn.edu.ar/gibd>
>
> gibd@frcu.utn.edu.ar

# Situación Mundial
## Casos actuales
El 30 de enero, la Organización Mundial de la Salud declaró la emergencia de salud pública internacional por el brote epidémico de coronavirus. 

La cifra de contagios confirmados del nuevo coronavirus SARS-CoV-2 superó la barrera del millón, siendo en la actualidad **`r  sep.miles(as.integer(sum(covid19[,ncol(covid19)]))) `** los casos confirmados.

Las muertes por la pandemia alcanzan las **`r   sep.miles(as.integer(sum(covid19_m[,ncol(covid19_m)]))) `**, de acuerdo con los datos de la universidad estadounidense Johns Hopkins, uno de las fuentes más consultadas del mundo.


###  {.tabset  .tabset-fade .tabset-pills}
#### Activos
```{r mapaMundoActivos, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

      mundialHoy <- mundial_ambos %>% 
        group_by(pais) %>%  
        filter(dia==max(dia)) %>% mutate(activos=casos-muertes-recuperados) #%>% select(pais, dia, fecha, activos)
      
      colors <- c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", 
                  "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026")

      highchart() %>% 
         hc_title(text = "<i>Casos Activos COVID-19</i>",
                  margin = 20, align = "center", style = list(color = "#800026", useHTML = TRUE)) %>%
         hc_tooltip(followPointer =  FALSE) %>%
         hc_add_series_map(world, mundialHoy, name = "Activos", value = "activos", joinBy = c("name", "pais"),
                      dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
         hc_colorAxis(stops=color_stops(n=length(colors), colors = colors)) %>%
         hc_legend(align = "center", x = 0, y = -10) %>%
         hc_mapNavigation(enabled = TRUE) %>%
         hc_add_theme(hc_theme_ffx()) %>%
         hc_add_annotation(xValue = 0, yValue = 0,
                           title = list(text = 'Fuente: Johns Hopkins. <p> Elaborado por: GIBD UTN')) %>%
         hc_chart(borderColor = "#800026", borderRadius = 10, borderWidth = 2)
      
      
```


#### Detectados
```{r mapaMundoCasos, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

      # mundialHoy <- mundial_ambos %>% 
      #   group_by(pais) %>%  
      #   filter(dia==max(dia)) %>% select(pais, dia, fecha, casos)
      
      highchart() %>% 
         hc_title(text = "<i>Casos Acumulados COVID-19</i>",
                  margin = 20, align = "center", style = list(color = "#08338F", useHTML = TRUE)) %>%
         hc_tooltip(followPointer =  FALSE) %>%
         hc_add_series_map(world, mundialHoy, name = "Casos", value = "casos", joinBy = c("name", "pais"),
                      dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
         hc_colorAxis(minColor = "#B7D4EB", maxColor = "#08338F")  %>%
         hc_legend(align = "center", x = 0, y = -10) %>%
         hc_mapNavigation(enabled = TRUE) %>%
         hc_add_theme(hc_theme_ffx()) %>%
         hc_add_annotation(xValue = 0, yValue = 0, 
                           title = list(text = 'Fuente: Johns Hopkins. <p> Elaborado por: GIBD UTN')) %>%
         hc_chart(borderColor = "#08338F", borderRadius = 10, borderWidth = 2)
```

#### Fallecidos
```{r mapaMundoMuertes, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

      # mundialMHoy <- mundial_ambos %>% 
      #   group_by(pais) %>%  
      #   filter(dia==max(dia)) %>% 
      #   select(pais, dia, fecha, muertes) 

      highchart() %>% 
         hc_title(text = "<i>Fallecidos COVID-19</i>",
                  margin = 20, align = "center", style = list(color = "#780000", useHTML = TRUE)) %>%
         hc_tooltip(followPointer =  FALSE) %>%
         hc_add_series_map(world, mundialHoy, name = "Muertes", value = "muertes", joinBy = c("name", "pais"),
                      dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
         hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
         hc_legend(align = "center", x = 0, y = -10) %>%
         hc_mapNavigation(enabled = TRUE) %>%
         hc_add_theme(hc_theme_ffx()) %>%
         hc_add_annotation(xValue = 0, yValue = 0, 
                           title = list(text = 'Fuente: Johns Hopkins. <p> Elaborado por: GIBD UTN')) %>%
         hc_chart(borderColor = "#780000", borderRadius = 10, borderWidth = 2)
       
```



## Letalidad
###  {.tabset  .tabset-fade .tabset-pills}
#### Curvas
```{r grafLetalidadMundo, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center',  out.height='100%'}

      letal <- mundial_ambos %>% 
        group_by(pais) %>% 
        # filter(dia==max(dia) & muertes>=100) %>%
         filter(muertes>=100) %>%
        mutate(letalidad = round(muertes/casos * 100, 2)) %>% unique() %>% arrange(pais, dia)
      
        fig <- plot_ly(letal, x = ~dia, y = ~letalidad, color = ~pais, type = "scatter", mode='lines+markers') 
        fig <- layout(fig, yaxis = list(type = "log"))
        fig

       
```

#### Tabla
```{r letalidadMundo, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
   
      letalHoy <- mundial_ambos %>% 
        group_by(pais) %>% 
        filter(dia==max(dia) & muertes>=100) %>%
        mutate(letalidad = round(muertes/casos * 100, 2)) %>% unique() %>% arrange(desc(letalidad), pais)
      
   letalHoy %>% select(pais, fecha, casos, muertes, letalidad) %>% filter(letalidad >0) %>% 
   kable( col.names =  c("País", "Fecha", "Casos",  "Fallecidos", "Tasa Letalidad"),
          align =  c('l', 'c', 'c', 'c', 'c')  , format.args = list( big.mark=".", decimal.mark = ",")) %>% 
   kable_styling()

   rm(covid19, covid19_m, covid_19_r)
   rm(letalHoy)
       
```


## Evolución por fecha
En el siguiente gráfico se puede analizar la velocidad y magnitud que ha tenido la propagación del Covid-19 en los países más afectados hasta la fecha indicada y Argentina. 

###  {.tabset  .tabset-fade .tabset-pills}
#### Logarítmica
El hecho de que la visión de éste sea logarítmica permite analizar en una escala más adecuada cómo ha sido la evolución de la pandemia, debido a la amplia gama de valores. 
```{r logar, echo=FALSE, out.width='100%', fig.align='center'}

  p <- afectados %>% select(pais, fecha, casos)
  fig <- plot_ly(p, x = ~fecha, y = ~casos, color = ~pais, type = "scatter", mode='lines+markers') 
  fig <- layout(fig, yaxis = list(type = "log"))
  fig
  
```

#### Lineal
Las curvas de evolución a escala lineal de casos detectados de COVID-19 en Argentina y en los países mas afectados a nivel mundial son:

```{r mundo, echo=FALSE, out.width='95%', fig.align='center'}
  p <- afectados %>% select(dia, fecha, casos)
  fig <- plot_ly(p, x = ~dia, y = ~casos, color = ~pais, type = "scatter", mode='lines+markers') 
  fig <- layout(fig, xaxis = list(title = "día"), yaxis = list(title = "casos"))
  fig
```

## Evolución en días
Excluyendo China y comparando la evolución de los casos detectados en estos paises en los primeros `r max(afectados$dia.x[afectados$pais=="Argentina"]) ` días, que son los transcurridos desde el primer caso detectado en Argentina, se obtienen las siguientes curvas: 

```{r mundo20, echo=FALSE, out.width='95%', fig.align='center'}
  diasArg <- max(afectados$dia[afectados$pais=="Argentina"])
  
  p <- afectados %>%
    filter(dia <= diasArg & pais != "China") 
  fig <- plot_ly(p, x = ~dia, y = ~casos, color = ~pais, type = "scatter", mode='lines+markers') 
  fig <- layout(fig, xaxis = list(title = "día"), yaxis = list(title = "casos"))
  fig
```

## Evolución luego de 100 casos
Para poner en contexto la situación, en el siguiente gráfico puede verse cómo fue evolucionando la cantidad de personas infectadas en estos países en el período siguiente al de haber llegado a los 100 casos confirmados.

###  {.tabset  .tabset-fade .tabset-pills}
#### Logaritmica
```{r dia100mundo, echo=FALSE, out.width='95%', fig.align='center'}
  p <- afectados %>%
    filter(casos>100 & pais != "China") %>% 
    group_by(pais) %>% arrange(fecha) %>% mutate(dia100 = row_number()) 
  fig <- plot_ly(p, x = ~dia, y = ~casos, color = ~pais, type = "scatter", mode='lines+markers') 
  fig <- layout(fig, xaxis = list(title = "día"), yaxis = list(type="log",title = "casos"))
  fig
  
```


#### Lineal
```{r dia100mundoLin, echo=FALSE, out.width='95%', fig.align='center'}
  p <- afectados %>%
    filter(casos>100 & pais != "China") %>% 
    group_by(pais) %>% arrange(fecha) %>% mutate(dia100 = row_number()) 
  fig <- plot_ly(p, x = ~dia, y = ~casos, color = ~pais, type = "scatter", mode='lines+markers') 
  fig <- layout(fig, xaxis = list(title = "día"), yaxis = list(title = "casos"))
  fig
  
```



# Sudamérica

## Inicios
En Sud América el primer caso detectado de COVID-19 se informa el día `r day(min(sudamerica$fecha))` de `r format(min(sudamerica$fecha), "%b")` del 2020 en `r sudamerica %>% filter(fecha==min(sudamerica$fecha)) %>% select(pais)`. 
A continuación se muestran las fechas en que se detectó por primera vez un infectado en cada país:

```{r tablaFechas, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%', out.height='70%', paged.print=FALSE}
  fechas <- sudamerica %>%
    group_by(pais) %>%  arrange( fecha ) %>%
    mutate(inicio= format(min(fecha),'%d/%m/%Y') ) %>%
    select(pais, inicio)%>%
    unique()

  names(fechas) <- c('content', 'start')
  fechas$start <- as.Date(as.character(fechas$start), format="%d/%m/%Y")
  
  timevis::timevis(fechas, zoomFactor = 0.8)
```

## Casos Totales y Casos letales
En el siguiente gráfico se muestran las series de cantidades de casos y cantidades de fallecidos en cada país, en el primero se visualiza la escala fija sobre el y, en la segunda se muestra la escala libre que mejor se adapta a cada país 

###  {.tabset  .tabset-fade .tabset-pills}
#### Escala fija
```{r casos_muertes, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%',out.height="100%", fig.align='center'}
  casos<- sudamerica %>% select(pais, dia, casos, muertes) %>% 
    gather(tipo, cant, -c(pais, dia))

  p <- ggplot(casos, aes(dia, cant, color=tipo, group=tipo, text = paste0(tipo, ": ", cant))) +
    geom_line(aes(shape=tipo, color=tipo)) +
    labs(x = 'día', y="") + 
    facet_wrap(~pais, ncol=3)+   theme(legend.position = 'bottom')
  
  ggplotly(p, tooltip = "text" ) %>% 
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2), height = 800)
  
```


#### Escala libre
```{r casos_muertes_libre, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%', out.height="100%", fig.align='center'}
 
  p <- ggplot(casos, aes(dia, cant, color=tipo, group=tipo, text = paste0(tipo, ": ", cant))) +
    geom_line(aes(shape=tipo, color=tipo), show.legend = F)+
    labs(x = 'día', y="") + 
    facet_wrap(~pais, scales = "free_y", ncol=3)+
    theme(legend.position = 'bottom')
  
  ggplotly(p, tooltip = "text") %>% 
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2), height = 800)

```



## Evolución de Covid
A continuación se graficará la evolución de casos acumulados y falllecidos de los países en simultáneo, tomando como día inicial el día en que se detectó por primera vez un infectado en cada país.

A las curvas se las mostrará en escala lineal y en escala (y) logaritmica para facilitar la visualización

###  {.tabset  .tabset-fade .tabset-pills}
#### Casos
```{r casosSud, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}

p <- sudamerica %>% group_by(pais) 
  fig <- plot_ly(p, x = ~dia, y = ~casos, color = ~pais, type = "scatter", mode='lines+markers') 
  fig <- layout(fig,  title="Casos detectados en Sudamérica (escala lineal)",
                xaxis = list(title = "día"), yaxis = list( title = "casos"))
  fig


```

#### Casos (Log)
```{r casosSudLog, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
   p <- sudamerica %>% group_by(pais) 
   fig <- plot_ly(p, x = ~dia, y = ~casos, color = ~pais, type = "scatter", mode='lines+markers') 
   fig <- layout(fig, title="Casos detectados en Sudamérica (escala Log)",
                 xaxis = list(title = "día"), yaxis = list(type="log", title = "casos"))
   fig

```

#### Fallecidos
```{r muertesSud, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
   p <- sudamerica %>% group_by(pais) 
   fig <- plot_ly(p, x = ~dia, y = ~muertes, color = ~pais, type = "scatter", mode='lines+markers') 
   fig <- layout(fig,  title="Fallecidos en Sudamérica (escala lineal)",
                 xaxis = list(title = "día"), yaxis = list( title = "casos"))
   fig

```

#### Fallecidos (Log)
```{r muertesSudLog, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
  fig <- plot_ly(p, x = ~dia, y = ~muertes, color = ~pais, type = "scatter", mode='lines+markers') 
  fig <- layout(fig,  title="Fallecidos en Sudamérica (escala log)",
                xaxis = list(title = "día"), yaxis = list(type="log", title = "casos"))
  fig

```





## Incidencia Acumulada
La incidencia acumulada (IA) proporciona una estimación de la probabilidad o el riesgo de que un individuo libre de una determinada enfermedad la desarrolle durante un período especificado de tiempo.

Al día de la fecha las incidencias acumuladas por cada 100.000 habitantes de los países de Sud América es: 

###  {.tabset  .tabset-fade .tabset-pills}
#### Mapa
```{r mapSud, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
  ia <- sudamerica %>% 
    group_by(pais) %>% 
    filter(dia==max(dia)) %>% 
    left_join(poblacion ) %>% 
    mutate(inc= as.double(round(casos/poblacion*100000, 2))) %>%  
    select(pais, dia, poblacion, casos, inc) %>% 
    arrange(desc(inc))

  highchart() %>%
    hc_title(text = "<i>Incidencia COVID-19 en Sudamérica</i>",
             margin = 20, align = "center", style = list(color = "#08338F", useHTML = TRUE)) %>%
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(sud, ia, name = "IA", value = "inc", joinBy = c("name", "pais"),
                      dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
    hc_colorAxis(minColor = "#B7D4EB", maxColor = "#08338F")  %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>%
    hc_add_annotation(xValue = 0, yValue = 0, 
                      title = list(text = 'Fuente: OMS. <p> Elaborado por: GIBD UTN')) %>%
    hc_chart(borderColor = "#08338F", borderRadius = 10, borderWidth = 2)

```

#### Tabla Datos
Como se observa, el país con la mayor Incidencia Acumulada al día de hoy es **`r ia[1,1] `**, que lleva *`r ia[1,2] ` días* desde la detección del primer caso.
```{r ia, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
  ia  %>% kable( col.names =  c("País", "Días", "Población","# Casos", "IA"),format.args = list( big.mark=".", decimal.mark = ","), align =  c('l', 'c', 'c', 'c', 'c') ) %>% 
      kable_styling()
```





## Tasa de Letalidad
Una proporción interesante a comparar es la **tasa de mortalidad particular o tasa de letalidad**, es decir la cantidad de personas que fallecieron respecto al total de casos en un período de tiempo.
A continuación se muestra la evolución de la tasa de letalidad en los distintos países considerando el primer día de detección del virus

###  {.tabset  .tabset-fade .tabset-pills}
#### Gráfica
```{r g_tasa_mort, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%', fig.align='center'}
  # p <- ambos %>% mutate(tasa_m = round(fallecidos/casos * 100, 1))
  p <- sudamerica %>% mutate(tasa_m = round(muertes/casos * 100, 1))
  fig <- plot_ly(p, x = ~dia, y = ~tasa_m, color = ~pais, type = "scatter", mode='lines+markers') 
  fig <- layout(fig, xaxis = list(title = "día"), yaxis = list(title = "Tasa de Letalidad"))
  fig

```

#### Datos
Los datos de la tasa de letalidad al `r  max(sudamerica$fecha)` para cada país son:
```{r d_tasa_mort, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%', fig.align='center'}

  sudamerica %>% group_by(pais) %>% 
    filter(fecha == max(fecha)) %>%   mutate(tasa_m = round(muertes/casos * 100, 2))%>%
    select(pais, casos, muertes, tasa_m) %>% 
    arrange(desc(tasa_m)) %>% 
    kable( col.names =  c("País", "# Casos", "# Fallecidos", "Tasa de Letalidad(%)"),
           format.args = list( big.mark=".", decimal.mark = ","),
            align =  c('l', 'c', 'c','c') ) %>%    
    kable_styling()

```






## Trayectoria de Nuevos Casos
Este gráfico (propuesto por https://aatishb.com/covidtrends/) muestra la evolución entre la cantidad total de casos de COVID-19 en una fecha frente a los nuevos casos confirmados en la semana previa a la misma. 

Cuando se traza de esta manera, el crecimiento exponencial se representaría como una línea recta creciente. 
Se puede observar que casi todos los países siguen un camino muy similar de crecimiento exponencial.

###  {.tabset  .tabset-fade .tabset-pills}
#### Sudamérica
 <!-- ```{r dinamico, echo=FALSE, fig.align='center', fig.show='animate', message=FALSE, warning=FALSE, paged.print=FALSE} -->
```{r dinamico, echo=FALSE, fig.align='center',message=FALSE, warning=FALSE, paged.print=FALSE}
	avance <- sudamerica %>% group_by(pais) %>% filter(dia != max(dia))
   
	# dinamico <- 
	   ggplot(avance) +
	  geom_line(aes(casos, semanal, group=pais, color=pais), size=1)+ scale_y_log10() + scale_x_log10() 

	# dinamico <- dinamico + transition_reveal(casos)
	# animate(dinamico, renderer = ffmpeg_renderer(format = "webm"))
```

#### Por país
```{r grafTray, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%', fig.align='center'}
 
  sudamerica %>% 
    group_by(pais) %>% 
    ggplot(aes(x=casos, y=semanal, color=pais))+
    geom_line(show.legend=FALSE) +
    scale_y_log10() + scale_x_log10() +
    labs(title="", x='Total de Casos',
         y="Trayectoria de COVID-19 en SudAmérica", caption="Datos: Universidad Johns Hopkins") + 
    facet_wrap(~pais,  ncol=5)

```








# Argentina

## Cantidad de Casos Actuales
En Argentina los datos son informados diariamente por el Ministerio de Salud de la Nación. Estos datos se informan de manera desestructurada y diariamente se modifica la cantidad de datos brindados.

Los datos con los que se trabajarán son de procesamiento propio en base a los informes mencionados y se encuentran actualizados al `r max(covidArg$FECHA) `.


###  {.tabset  .tabset-fade .tabset-pills}
#### Evolución en Argentina
```{r evolArg, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE}
   
   argCov$dia <- as.Date(argCov$dia, '%d/%m/%Y')
   argCov$Recuperados <- if_else(is.na(argCov$Recuperados), 0, argCov$Recuperados)
   
   evolArg <- argCov %>%
     select(dia, Detectados, Fallecidos, Recuperados) %>% 
     mutate(Activos = Detectados - Fallecidos - Recuperados) %>% 
     select(dia, Detectados, Activos, Fallecidos, Recuperados) %>% 
     gather(tipo, cantidad, c(Detectados, Activos, Fallecidos, Recuperados), -dia)
   
   pal <- c( '#8DA0CB', '#9BD92F','#FF8080',  '#66C2A5')
   fig <- plot_ly(evolArg, x =~dia, y=~cantidad, split = ~tipo, color=~tipo,
         colors=pal, alpha = 0.1, type='scatter', mode='lines', fill='tozeroy')
   fig
  
```


#### Distribución Actual
Situación de los casos detectados en la actualidad. Los casos Activos aquí se discriminan con los casos que se encuentran en Unidades de Terapia Intensiva 

```{r distrArgH,echo=FALSE, message=FALSE, warning=FALSE }
 
  p2 <- argCov %>% filter(dia==max(dia)) %>% 
     select(dia, Detectados, Fallecidos, Recuperados, UTI) %>% 
     mutate(Activos = Detectados - Fallecidos - Recuperados-UTI) %>% 
     select(dia, Activos, Fallecidos, Recuperados, UTI) %>% 
     gather(tipo, cantidad, c(Activos, Fallecidos, Recuperados, UTI), -dia) %>%
     select(tipo, cantidad) %>% mutate(porc = cantidad/sum(cantidad))

   ##aplicar mismos colores
   pal2 <- c( '#8DA0CB', '#FF8080',  '#66C2A5')
   fig <- plot_ly(p2, labels = ~tipo, values = ~porc, type = 'pie',
        textposition = 'inside', textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        hoverinfo = 'text',
        text = ~paste( round((porc * 100), 1), ' %'),
        marker = list(colors = pal2,line = list(color = '#FFFFFF', width = 1)),
        showlegend = FALSE)
  fig
  
```


#### Tabla
```{r datoEvolArg, echo=FALSE, message=FALSE, warning=FALSE}
 totalesArg <- argCov %>%
   select(dia, Detectados, Fallecidos, Recuperados) 

 totalesArg %>% kable( col.names =  c("Fecha", "Casos Detectados", "Fallecidos", "Recuperados"),
                       format.args = list( big.mark=".", decimal.mark = ","),
            align =  c('l', 'c', 'c', 'c') ) %>%  kable_styling()
```



## Composición por Edad
A continuación se grafican las pirámides poblacionales de casos confirmados y fallecimientos.

La composición de la siguiente pirámide poblacional de los casos confirmados fue confeccionada considerando que el porcentaje de Hombres y Mujeres informado por el Ministerio de Salud se distribute uniformemente en cada grupo etaraio.

### {.tabset  .tabset-fade .tabset-pills}
#### Casos confirmados
```{r piramide}

   edades <- read_delim("data/edades_arg.csv", ";", escape_double = FALSE, locale = locale(decimal_mark = ","), trim_ws = TRUE)
   edades <- edades %>% gather(sexo, prop, c("mujeres", "varones"), -c(1:2, 5:13))
   edades$prop <- as.double(edades$prop)
   edades$fecha <- as.Date(edades$fecha, "%d/%m/%Y")
   edades <- edades %>% gather(edad, cant, c(3:11), -c(1:2, 12:13))
   edades<- edades %>%  mutate(n= round((cant * prop/100), 0)) %>% 
      group_by(fecha) %>% mutate(porcent=round(n/sum(n)*100,2) ) %>% ungroup()
   
   edades$sexo <- if_else(edades$sexo=="varones",  "Hombre", "Mujer")
   
   edades$porcent <- if_else(edades$sexo=="Hombre",  edades$porcent*-1, edades$porcent)
   
   edadesHoy <- edades %>%  filter(fecha==max(fecha))
   
   plot_ly(edadesHoy, x = ~porcent, y = ~edad, color = ~sexo) %>%
     add_bars(orientation = "h",
           hoverinfo = "y+text+name", text =  ~paste(abs(porcent), " %", '\n Cant.: (', n,')'),  
           colors = c("#2c7fb8", "#fa9fb5")) %>%
     layout(bargap = 0.1, barmode = "overlay", 
            title = "Piramide Poblaciónal de Casos Confirmados", 
            xaxis = list(tickmode = "array", 
                       tickvals = c(-100, -50, -25, -20, -15, -10, -5, 0, 
                                      5, 10, 15, 20, 25, 50, 100),
                         ticktext = c("100", "50%", "25%", "20%", "15%", "10%","5%", "0",
                                      "5%", "10%", "15%","20%", "25%", "50%", "100%"),
                         title = "Casos Confirmados"), 
            yaxis = list(title = "Grupo Edad"))


```

#### Fallecidos
```{r piramideFall}
   edades_m <- muertosArg  %>% group_by(genero, edad) %>% mutate(n=n())%>% 
      select(genero, edad, n) 
   edades_m$grupo <- if_else(edades_m$edad < 10, "0 a 9", 
                   if_else(edades_m$edad < 20, "10 a 19", 
                   if_else(edades_m$edad < 30, "20 a 29", 
                   if_else(edades_m$edad < 40, "30 a 39", 
                   if_else(edades_m$edad < 50, "40 a 49", 
                   if_else(edades_m$edad < 60, "50 a 59", 
                   if_else(edades_m$edad < 70, "60 a 69", 
                   if_else(edades_m$edad < 80, "70 a 79", "80 o mas"))))))))

      edades_m <- edades_m %>% group_by(grupo, genero) %>% mutate(total = n()) %>% 
         select(grupo, genero, total) %>% unique() %>% ungroup() %>% 
         mutate(prop = round(total/sum(total)*100, 2)) %>% 
         select(grupo, genero, total, prop)
      
      edades_m$prop <- if_else(edades_m$genero=="Hombre", edades_m$prop*-1, edades_m$prop)

plot_ly(edades_m, x = ~prop, y = ~grupo, color = ~genero) %>%
  add_bars(orientation = "h",
        hoverinfo = "y+text+name", text = ~paste(abs(prop), " %", '\n Cant.: (', total,')'), 
        colors = c("#2c7fb8", "#fa9fb5")) %>%
  layout(bargap = 0.1, barmode = "overlay", 
         title = "Piramide Poblaciónal de Personas Fallecidas", 
         xaxis = list(tickmode = "array",
                      tickvals = c(-100, -50, -25, -20, -15, -10, -5, 0, 
                                   5, 10, 15, 20, 25, 50, 100),
                      ticktext = c("100", "50%", "25%", "20%", "15%", "10%","5%", "0",
                                   "5%", "10%", "15%","20%", "25%", "50%", "100%"),
                      title = "Fallecidos"),
         yaxis = list(title = "Grupo Edad"))

   

```

#### Letalidad por Grupo
```{r let_Edad}

   let_edad <- edadesHoy %>% left_join(edades_m, by=c("sexo"="genero", "edad"="grupo")) %>% 
   mutate(let = round(total/n*100, 1)) 

   plot_ly(let_edad, x=~let, y=~edad, color=~sexo) %>% 
       add_bars(orientation = "h",
        hoverinfo = "y+text", text = ~paste('Género: ', sexo, '\n Letalidad: ', let, ' %'), 
        colors = c("#2c7fb8", "#fa9fb5")) %>% 
       layout( title = "Tasas de Letalidad por Grupo",
               xaxis = list(title = "Letalidad"), yaxis = list(title = "Grupo Edad"))

```






## Casos actuales por Provincia

La notificación de los casos por jurisdicción se realiza teniendo en cuenta la residencia según el Registro Nacional de las Personas, pudiendo variar en función de la investigación de la jurisdicción.
El Ministerio diariamente informa la cantidad de casos por provincia pudiendo rectificar luego cantidades de casos reasignados. 


####  {.tabset  .tabset-fade .tabset-pills}
##### Activos
La cantidad de casos Activos se ha calculado en base a los informes provinciales de los Ministerios de Salud, considerando los casos confirmados menos los recuperados/altas menos los fallecidos-
Debido a que no todas las provincias lo informan diariamente pueden existir algunas diferencias con las situaciones actuales.

```{r mapaActivos, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center',  out.height='100%'}
 activos <- casos_pronvinciales %>%filter(departamento == "TOTAL GENERAL") %>%  mutate(activos = cantidad-recuperados-fallecidos) %>%  
   select(provincia, activos, cantidad, recuperados, fallecidos) 

   activos$activos <- if_else(is.na(activos$activos), 0, activos$activos)
 
   activos$recuperados <- if_else(is.na(activos$recuperados), 0, activos$recuperados)
   activos$provincia <- if_else(activos$provincia=="Tierra del Fuego, Antártida e Islas del Atlántico Sur", "Tierra del Fuego", activos$provincia)
   activos$provincia <- if_else(activos$provincia=="Ciudad Autónoma de Buenos Aires", "Ciudad de Buenos Aires", activos$provincia)
   
  colors <- c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026")

  highchart() %>%
     hc_title(text = "<i>Casos Activos COVID-19 por Provincia en Argentina</i> - <b>GIBD</b>",
              margin = 5, align = "center", style = list(color = "#bd0026", useHTML = TRUE, fontWeight = "bold")) %>% 
          hc_tooltip(followPointer =  FALSE) %>%
          hc_add_series_map(argentina, activos, name = "Activos",
                            value = "activos", joinBy = c("name", "provincia"),
                            dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
         hc_colorAxis(stops=color_stops(n=length(colors), colors = colors)) %>%
          hc_legend(align = "center", x = 0, y = -10) %>%
          hc_mapNavigation(enabled = TRUE) %>%
          hc_add_theme(hc_theme_ffx()) %>% 
          hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerios de Salud Provinciales')) %>% 
          hc_chart(borderColor = "#bd0026",
             borderRadius = 10,
             borderWidth = 2)
               
```


##### Casos
```{r mapas, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
  covidArg_hoy <- covidArg %>% 
    group_by(PROVINCIA) %>% 
    mutate(total=sum(CASOS)) %>% select(PROVINCIA, total) %>% unique()

  highchart() %>%
          hc_title(text = "<i>Mapa dinámico de COVID-19 en Argentina</i> - <b>GIBD</b>",
             margin = 5, align = "center",
             style = list(color = "#08338F", useHTML = TRUE)) %>% 
          hc_subtitle(text = "Casos detectados por provincia",
                align = "center",
                style = list(color = "#0C5C9E", fontWeight = "bold")) %>% 
          hc_tooltip(followPointer =  FALSE) %>%
          hc_add_series_map(argentina, covidArg_hoy, name = "Total",
                            value = "total", joinBy = c("name", "PROVINCIA"),
                            dataLabels = list(enabled = TRUE,
                                              format = '{point.properties.woe-name}')) %>%
          hc_colorAxis(minColor = "#B7D4EB", maxColor = "#08338F")  %>%
          hc_legend(align = "center", x = 0, y = -10) %>%
          hc_mapNavigation(enabled = TRUE) %>%
          hc_add_theme(hc_theme_ffx()) %>% 
          hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Datos Propios')) %>% 
          hc_chart(borderColor = "#08338F",
             borderRadius = 10,
             borderWidth = 2)
```

##### Fallecidos
```{r mapasFallArg, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
  muertosArg_hoy <- muertosArg %>% 
    group_by(Provincia) %>% 
    mutate(total=n()) %>% select(Provincia, total) %>% unique()


  highchart() %>%
          hc_title(text = "<i>Mapa dinámico de COVID-19 en Argentina</i> - <b>Fallecidos</b>",
             margin = 5, align = "center",
             style = list(color = "#780000", useHTML = TRUE)) %>% 
          hc_subtitle(text = "Casos detectados por provincia",
                align = "center",
                style = list(color = "#780000", fontWeight = "bold")) %>% 
          hc_tooltip(followPointer =  FALSE) %>%
          hc_add_series_map(argentina, muertosArg_hoy, name = "Total",
                            value = "total", joinBy = c("name", "Provincia"),
                            dataLabels = list(enabled = TRUE,
                                              format = '{point.properties.woe-name}')) %>%
          hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
          hc_legend(align = "center", x = 0, y = -10) %>%
          hc_mapNavigation(enabled = TRUE) %>%
          hc_add_theme(hc_theme_ffx()) %>% 
          hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Datos Propios')) %>% 
          hc_chart(borderColor = "#780000",
             borderRadius = 10,
             borderWidth = 2)
```

##### Tabla
```{r tabProv, echo=FALSE, message=FALSE, warning=FALSE}
   
   tabla <- covidArg_hoy %>% left_join(muertosArg_hoy, by=c("PROVINCIA"="Provincia")) %>% 
      left_join(activos,  by=c("PROVINCIA"="provincia")) %>% select(PROVINCIA, total.x, total.y, recuperados)
   names(tabla) <- c("Provincia", "Confirmados", "Fallecidos", "Recuperados") 
   tabla$Fallecidos <- if_else(is.na(tabla$Fallecidos), 0, as.double(tabla$Fallecidos))
  
   tabla  %>%  kable( col.names =  c("Provincia", "Confirmados", "Fallecidos", "Recuperados"),
                           format.args = list( big.mark=".", decimal.mark = ","),
            align =  c('l', 'c', 'c', 'c') ) %>%  kable_styling()
  
```



## Distribución por Provincias
Los porcentajes que representa cada provincia de casos confirmados, fallecidos y activos se muestra a continuación

###  {.tabset  .tabset-fade .tabset-pills}
#### Confirmados
```{r distrProvConf}
  
   tabla$parents <- "Confirmados"
   plot_ly(data = tabla,
        type= "treemap",
        values = ~Confirmados,
        labels= ~Provincia,
        parents=  ~parents,
        domain = list(column=0),
        name = "Confirmados",
        textinfo="label+value+percent parent") %>%
  layout(title = "Covid19 - Distribución de casos Confirmados por provincia")

```

#### Fallecidos
```{r distrProvFall}
   tabla$parents <- "Fallecidos"
   plot_ly(data = tabla,
        type= "treemap",
        values = ~Fallecidos,
        labels= ~Provincia,
        parents=  ~parents,
        domain = list(column=0),
        name = "Fallecidos",
        textinfo="label+value+percent parent") %>%
  layout(title = "Covid19 - Distribución de casos Fallecidos por provincia")

```

#### Activos
```{r distrProvAct}
   tabla$Activos <- tabla$Confirmados-tabla$Recuperados-tabla$Fallecidos
   tabla$parents <- "Activos"
   plot_ly(data = tabla,
        type= "treemap",
        values = ~Activos,
        labels= ~Provincia,
        parents=  ~parents,
        domain = list(column=0),
        name = "Activos",
        textinfo="label+value+percent parent") %>%
  layout(title = "Covid19 - Distribución de casos Activos por provincia")

```





## Distribución por Departamentos
Gracias al aporte de reunir y disponibilizar los datos de [Sistemas Mapache](https://github.com/SistemasMapache/Covid19arData) y al aporte de muchos usuarios como [@ClariCardozoCas](https://twitter.com/ClariCardozoCas), [@juanjocorrea_ok](https://twitter.com/juanjocorrea_ok) se muestra la distribución de casos a nivel departamental de las provincias: Buenos Aires, Ciudad Autónoma de Buenos Aires, Río Negro, Neuquén, Tucumán,  Santa Fe, Chaco, Salta y Entre Ríos en base a datos propios.

```{r dptoArg, echo=FALSE, message=FALSE, warning=FALSE}
   
     casos_pronvincialesT <- casos_pronvinciales %>% 
   # filter(departamento != "TOTAL GENERAL") %>%  
   select(provincia, localidad, cantidad) 
  
  casos_pronvincialesT <- casos_pronvincialesT %>% 
    left_join(localidades, by=c("localidad"="nombre", "provincia"="provincia")) %>% unique()
  
  casos_pronvincialesT$departamen <- if_else(is.na(casos_pronvincialesT$departamen)&
                                              casos_pronvincialesT$provincia=="Buenos Aires",
                                            casos_pronvincialesT$localidad, casos_pronvincialesT$departamen)
  casos_pronvincialesT$departamen <- if_else(is.na(casos_pronvincialesT$departamen)&
                                              casos_pronvincialesT$provincia=="Ciudad Autónoma de Buenos Aires",
                                            casos_pronvincialesT$localidad, casos_pronvincialesT$departamen)
  casos_pronvincialesT$departamen <- if_else(is.na(casos_pronvincialesT$departamen)&
                                              casos_pronvincialesT$provincia=="Tucumán",
                                            casos_pronvincialesT$localidad, casos_pronvincialesT$departamen)
  casos_pronvincialesT$departamen <- if_else(is.na(casos_pronvincialesT$departamen)&
                                              casos_pronvincialesT$provincia=="Santiago del Estero",
                                            casos_pronvincialesT$localidad, casos_pronvincialesT$departamen)
  
  # vacios <- casos_pronvinciales %>% filter(is.na(departamen))
  
  casos_pronvincialesT <- casos_pronvincialesT %>%
    ungroup() %>% 
    group_by(provincia, departamen) %>% 
    mutate(casos = sum(cantidad))%>% unique() %>% 
    select(provincia, departamen, casos)
  names(casos_pronvincialesT) <- c("provincia", "departamento", "casos")
  
  provincias_casos <- casos_pronvincialesT %>% group_by(provincia) %>% 
     select(provincia) %>% unique() %>% ungroup()
  deptos <- deptos %>%  right_join(provincias_casos , by=c("provincia"="provincia"))
  
  deptos_covid <- deptos %>%  
    left_join(casos_pronvincialesT, by=c("departamen" = "departamento", "provincia"="provincia")) %>% 
    unique()
  
  deptos_covid$casos<- if_else(is.na(deptos_covid$casos), 0, deptos_covid$casos)
     
  leaflet(data = deptos_covid) %>%
         addTiles(urlTemplate = urlign, attribution="IGN") %>% 
    addPolygons( color = "#444444", weight = 1,
                 fillColor = color(deptos_covid$casos), fillOpacity = 0.6,
                 label = paste(deptos_covid$provincia, ", ",
                               deptos_covid$departamen, ": ", 
                               deptos_covid$casos),
                 popup = paste(deptos_covid$provincia, "<br/>",
                               deptos_covid$departamen, ": ", 
                               deptos_covid$casos),
                 highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE))  %>% 
     addLegend(colors = c('#FFFFFF','#fdd49e', '#fc8d59', '#d7301f', '#b30000', '#7f0000'), 
                    labels= c("0", "1-24", "25-49", "50-74", "75 - 99", "100 o más"), position ="bottomright") 
  
             
```




### AMBA
```{r dptoAMBA, echo=FALSE, message=FALSE, warning=FALSE}

   amba <-amba_loc %>% left_join(casos_pronvinciales, by=c("provincia"="provincia", "departamento"="localidad")) %>%
  select(provincia, departamento, cantidad, fallecidos, recuperados)

  names(amba) <- c("provincia", "localidad", "cantidad", "fallecidos", "recuperados")
  amba$localidad <- gsub("TOTAL GENERAL", "Ciudad Autónoma de Buenos Aires",  amba$localidad )
  
  amba <- amba %>% 
    left_join(localidades, by=c("localidad"="nombre", "provincia"="provincia")) %>% unique() %>% 
    select(provincia, departamen, localidad, cantidad, fallecidos, recuperados)
  
  amba$departamen <- if_else(is.na(amba$departamen) & amba$provincia=="Buenos Aires",
                                            amba$localidad, amba$departamen)
  
   amba$departamen <- if_else( amba$provincia=="Ciudad Autónoma de Buenos Aires",
                                            amba$localidad, amba$departamen)
  deptos_covid <- amba_dptos %>%  
    left_join(amba, by=c("departam_1" = "departamen", "provincia_"="provincia")) %>% 
    unique() 
 
  deptos_covid$cantidad<- if_else(is.na(deptos_covid$cantidad), 0, 
                                  as.double(deptos_covid$cantidad))
  deptos_covid$recuperados<- if_else(is.na(deptos_covid$recuperados), 0,
                                     as.double(deptos_covid$recuperados))
  deptos_covid$fallecidos<- if_else(is.na(deptos_covid$fallecidos), 0,
                                    as.double(deptos_covid$fallecidos))
  
  tabla <- amba %>% mutate(casost=sum(cantidad, na.rm = T), 
                           muertesT=sum(fallecidos, na.rm = T),
                           recuperadosT=sum(recuperados, na.rm = T)) %>% 
    select(casost, muertesT, recuperadosT) %>% unique()
  
  paisT <- argCov %>% filter(dia==max(dia)) %>% select(Detectados, Fallecidos, Recuperados)

  

  
  
```

En la actualidad el Area Metropolitana concentra un `r round(tabla$casost/paisT$Detectados*100, 2)` % de los casos confirmados por COVID-19 en todo el país y un `r round(tabla$muertesT/paisT$Fallecidos*100, 2)` % de los fallecidos. Es por ello que a continuación se muestra aparte el mapa del AMBA.

```{r mapaAmba, echo=FALSE, message=FALSE, warning=FALSE}
 
  leaflet(data = deptos_covid) %>%      
   addTiles(urlTemplate = urlign ) %>% 
    addPolygons( color = "#444444", weight = 1,
                 fillColor = color(deptos_covid$cantidad), fillOpacity = 0.6,
                 popup = paste(deptos_covid$provincia_, " <br/> ", deptos_covid$departam_1,
                               " <br/>- confirmados ", deptos_covid$cantidad,
                               " <br/>- recuperados ",deptos_covid$recuperados,
                               " <br/>- fallecidos ",deptos_covid$fallecidos),
                 highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE))  %>% 
     addLegend(colors = c('#FFFFFF','#fdd49e', '#fc8d59', '#d7301f', '#b30000', '#7f0000'), 
                    labels= c("0", "1-24", "25-49", "50-74", "75 - 99", "100 o más"), 
               position ="bottomright") 
  

rm(deptos_covid, deptos, casos_pronvincialesT, casos_pronvinciales, amba_dptos)
```










## Evolución por Provincia
A continuación se muestra la evolución de casos detectados por provincias y las curvas de casos confirmados y fallecimientos por día para cada una de las provincias argentinas. Ambas curvas se muestran a escala libre y escala logaritmica

<!-- ### Evolución -->
<iframe width="760" height="500" src="https://preview.flourish.studio/2125321/R0ECnRKTwlv1xuOmT0wP9XQuaG66nj0TPEgdMBACYQY9BWfIEXMnxfgX4EVUlm9O/" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

###  {.tabset  .tabset-fade .tabset-pills}
#### Casos
```{r ev_prov, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

   tabla_prov<- covidArg %>% 
    group_by(PROVINCIA, FECHA) %>% mutate(casos=sum(CASOS)) %>% select(PROVINCIA, FECHA, casos) %>% unique() 

    tabla_prov$acumulados <-0
    tabla_prov$FECHA <- as.Date(tabla_prov$FECHA , "%d/%m/%Y")
  
  tabla_prov <- tabla_prov %>% ungroup() %>% group_by(PROVINCIA) %>% 
    arrange(PROVINCIA, FECHA) %>% 
    mutate(acumulados =cumsum(casos))
  
  tabla_prov <- tabla_prov %>%
    gather(casos, acum, -c(PROVINCIA, FECHA))# %>% ungroup()
  
  names(tabla_prov) <- c("provincia", "fecha", "tipo", "cant")
 
 
  p <- tabla_prov %>%
    filter(cant>0&tipo=="acumulados") %>% 
    group_by(provincia) %>% arrange(fecha) %>% mutate(dia1 = row_number()) 
  
  fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~provincia, type = "scatter", mode='lines+markers') 
  fig <- layout(fig, title="Evolución de casos confirmados por Provincia",xaxis = list(title = "día"), yaxis = list(title = "casos"))
  fig

```

#### Casos (Log)
```{r ev_provLog, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}
  fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~provincia, type = "scatter", mode='lines+markers') 
  fig <- layout(fig, title="Evolución de casos confirmados por Provincia (Log)",xaxis = list(title = "día"), yaxis = list(type = "log", title = "casos"))
  fig

```


#### Fallecidos
```{r ev_provFall, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

   tabla_prov_m<- muertosArg %>% 
      group_by(Provincia, fecha) %>% mutate(muertes=n()) %>% select(Provincia, fecha, muertes) %>% unique() 
  
      tabla_prov_m$acumulados <-0
      tabla_prov_m$fecha <- as.Date(tabla_prov_m$fecha , "%d/%m/%Y")
    
    tabla_prov_m <- tabla_prov_m %>% ungroup() %>% group_by(Provincia) %>% 
      arrange(Provincia, fecha) %>% 
      mutate(acumulados =cumsum(muertes))
    
    tabla_prov_m <- tabla_prov_m %>%
      gather(muertes, acumulados, -c(Provincia, fecha))
    
    names(tabla_prov_m) <- c("provincia", "fecha", "tipo", "cant")
   
    p <- tabla_prov_m %>%
      filter(cant>0&tipo=="acumulados") %>% 
      group_by(provincia) %>% arrange(fecha) %>% mutate(dia1 = row_number()) 
    
    fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~provincia, type = "scatter", mode='lines+markers') 
    fig <- layout(fig, title="Evolución fallecidos por Provincia",xaxis = list(title = "día"), yaxis = list(title = "fallecimientos"))
    fig

```


#### Fallecidos (Log)
```{r ev_provFallLog, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}
    fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~provincia, type = "scatter", mode='lines+markers') 
    fig <- layout(fig, title="Evolución fallecidos por Provincia",xaxis = list(title = "día"), yaxis = list(title = "fallecimientos", type = "log"))
    fig

```

### Días Transcurridos

Los días transcurridos dese que el Ministerio de Salud de Nación no reporta casos para cada una de las provincias son:

```{r diasProv}

   dias <- tabla_prov %>% filter(tipo== "casos" & cant > 0) %>% group_by(provincia) %>% 
      mutate(ultimo=max(fecha)) %>% select(provincia, ultimo) %>% unique() %>%  
      mutate(sincasos= (today()-ultimo),
             col=if_else(sincasos < 2, "#d7191c", if_else(sincasos < 5,"#d6604d",
                   if_else(sincasos < 15, "#a6d96a", "#1a9641")))) %>% 
     arrange(desc(sincasos),desc(provincia))

   fig <- plot_ly(dias, type="bar", colors = ~unique(col)) 
   fig <- fig %>% add_trace( x = ~sincasos, y = ~provincia, name= "Días",
                            color=~col, text=~sincasos, textposition = 'auto',
                            mode="lines",
                               showlegend = FALSE,
                               line = list(width = 15)) %>% 
      layout(title="Días Transcurridos Sin reportar nuevos casos", 
             xaxis = list(title = "días"), yaxis=list(title=""))
   fig
   
   

```




## Incidencia Acumulada

La incidencia acumulada (IA) proporciona una estimación de la probabilidad o el riesgo de que un individuo, libre de una determinada enfermedad, la desarrolle durante un período específico de tiempo.

En Argentina, considerando una población de 45.376.763 (Proyección estimada por INDEC), la tasa de incidencia acumulada nacional es de `r round(sum(argCov$casosD)/45376763 * 100000, 2)` cada 100 mil habitantes.

Al día de la fecha las incidencias acumuladas por cada 100.000 habitantes en la provincias de Argentina son: 

###  {.tabset  .tabset-fade .tabset-pills}
#### Mapa

```{r mapIAArg, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
 # round(sum(tabla_prov$cant[tipo=='casos'])/45376763 * 100000, 2)

  ia_prov <- tabla_prov %>%
    filter(tipo == "acumulados") %>%
    group_by(provincia) %>%
    filter(fecha == max(fecha)) %>%
    select(provincia, cant) %>%
    left_join(poblacionArg) %>% 
    mutate(ia= round(cant/poblacion * 100000, 2)) %>%
    arrange(desc(ia))

  highchart() %>%
    hc_title(text = "<i>Incidencia Acumulada COVID-19 en Argentina</i> ",
             margin = 20, align = "center", style = list(color = "#780000", useHTML = TRUE)) %>%
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(argentina, ia_prov, name = "IA", value = "ia", joinBy = c("name", "provincia"),
                      dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
    hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud - INDEC')) %>% 
    hc_chart(borderColor = "#780000", borderRadius = 10, borderWidth = 2)

```


#### Datos

```{r iAProvD}
  tabiaprov <- ia_prov %>% select(provincia, cant, ia) %>% arrange(desc(ia))
  tabiaprov %>% kable(col.names = c("Provincia", "Casos", "Tasa Incidencia"),
                      format.args = list( big.mark=".", decimal.mark = ","),
            align=c('l', 'c', 'c')) %>%
  kable_styling()

```









## Letalidad en Argentina

En la actualidad (`r max(totalesArg$dia)`) en Argentina, la **tasa de mortalidad particular o letalidad** es de `r round(totalesArg$Fallecidos[totalesArg$dia==max(totalesArg$dia)]/totalesArg$Detectados[totalesArg$dia==max(totalesArg$dia)] * 100, 2)`%, mientras que el **porcentaje pacientes recuperados** es del `r round(totalesArg$Recuperados[totalesArg$dia==max(totalesArg$dia)]/totalesArg$Detectados[totalesArg$dia==max(totalesArg$dia)] * 100, 2)`%.

La tasa de Letalidad a nivel nacional ha evolucionado como lo muestra la siguiente gráfica.

```{r evolLetalArg, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%' }
    evolLet <- argCov %>% mutate(let = round(Fallecidos/Detectados * 100, 1) ) %>% 
      select(dia, Detectados, Fallecidos, let) %>% arrange(dia)
    evolLet$dia <- as.Date(evolLet$dia, "%d/%m/%Y")
    
    plot_ly(evolLet, x = ~dia, y = ~let, type = "bar", name = "Letalidad en Argentina",
           texttemplate = '%{y:.2s}', textposition = 'outside') %>% 
          layout(xaxis=list(title=""), yaxis = list(title = "Letalidad en Argentina"))
  


```


El `r round(nrow(muertosArg[muertosArg$genero=="Hombre", ])/nrow(muertosArg) * 100, 1)` % de los fallecidos son Hombres, mientras que el `r round(nrow(muertosArg[muertosArg$genero=="Mujer", ])/nrow(muertosArg) * 100, 1)` % restante corresponde a Mujeres.

La edad media de los pacientes fallecidos es de `r round(mean(muertosArg$edad, na.rm = T), 0)` años, y en particular la edad media de los Hombres fallecidos es de `r round(mean(muertosArg$edad[muertosArg$genero=="Hombre"], na.rm = T), 0)` años y en la Mujeres de `r round(mean(muertosArg$edad[muertosArg$genero=="Mujer"], na.rm = T), 0)` años.

En el siguiente gráfico se observa la distribución de los pacientes fallecidos por sexo y edad.

```{r fallArg, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}
 # round(mean(muertosArg$edad[muertosArg$genero=="Mujer"], na.rm = T), 0)
  ggplot(muertosArg, aes(x=genero, y=edad, fill= genero) )+
      geom_violin(alpha=0.6) +
      labs( 
           subtitle="Distribución de fallecidos según el sexo y la edad", 
           caption="Fuente: Ministerio de Salud", 
           y="Edad", 
           x="Sexo",
           color=NULL) +  
  scale_fill_manual( values = c("lightsteelblue", "lightpink1"),
                     name= "Sexo", breaks = c("Hombre", "Mujer"), labels = c("Hombre", "Mujer"))

```




## Letalidad por Provincias
En base a las provincias de residencia de los fallecidos, informadas por el Ministerio de Salud Nacional, y considerando las cantidades actualizadas de casos en cada provincia se obtienen las siguientes tasas de letalidad a nivel provincial


###  {.tabset  .tabset-fade .tabset-pills}
#### Mapa
```{r mapLEtArg, echo=FALSE, message=FALSE, warning=FALSE,  fig.align='center', paged.print=FALSE}

  let_prov <- muertosArg %>% group_by(Provincia) %>% 
    mutate(cantidad = n()) %>% 
    select(Provincia, cantidad) %>% unique() %>% 
    left_join(ia_prov, by=c("Provincia"="provincia")) %>% 
    select("Provincia", "cantidad", "cant") %>% 
  mutate(letalidad = round(cantidad/cant * 100, 1))


  highchart() %>%
    hc_title(text = "<i>Letalidad por COVID-19 en Argentina</i> ",
             margin = 20, align = "center", style = list(color = "#780000", useHTML = TRUE)) %>%
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(argentina, let_prov, name = "Let", value = "letalidad", 
                      joinBy = c("name", "Provincia"), 
                      dataLabels = list(enabled = TRUE, format = '{point.properties.woe-name}')) %>%
    hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud')) %>% 
    hc_chart(borderColor = "#780000", borderRadius = 10, borderWidth = 2)

```



#### Datos
```{r datLetProv, echo=FALSE,message=FALSE, warning=FALSE}
 let_prov %>% arrange(desc(letalidad)) %>% kable( col.names =  c("Provincia", "Muertes", "Casos Acumulados", "Tasa Letalidad"),format.args = list( big.mark=".", decimal.mark = ","),
            align =  c('l', 'c', 'c', 'c') ) %>%  kable_styling()
```



## Distribución de Casos por Tipo
Los tipos de Casos confirmados se clasifican en:
*Importados* (cuando se registra trasmisión relacionada viajes al exterior del país)

*Contacto estrecho/Conglomerado*: casos en los que se puede determinar la cadena de transmisión por contacto estrecho con infectados

*Comunitario*: aquellos casos en los que no se puede relacionar a los casos confirmados con cadenas de trasmisión conocidas. 

*Investigación*: casos que se encuentran en estudio para definir el tipo de transmisión. En algún momento tiene que pasar a alguno de los otros 3 casos

La evolución y distribución de los casos según el tipo en Argentina es:


###  {.tabset  .tabset-fade .tabset-pills}
#### Distribución
```{r distrCasos, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

  distCasos <- argCov %>% mutate(porImportados = Importados/Detectados,
                                porEstrecho = Estrecho/Detectados,
                                porComunitaria = Comunitaria/Detectados,
                                porInvestigacion = Investigacion/Detectados) %>% 
    select(dia, porImportados, porEstrecho, porComunitaria, porInvestigacion) %>% arrange(dia)
  
  distCasos$dia <- as.Date(distCasos$dia, '%d/%m/%Y')
 
  plot_ly(distCasos, x = ~dia, y = ~porInvestigacion, type = "bar", name = "En Investigación", color = I("orchid3"),
          hoverinfo = 'text',
          text = ~paste('</br> Fecha: ', dia ,
                        '</br> Importados: ', round(porImportados*100, 2),'%',
                      '</br> Contactos Estrechos: ', round(porEstrecho*100, 2),'%',
                      '</br> Circulación Comunitaria: ', round(porComunitaria*100, 2),'%',
                      '</br> En Investigación: ', round(porInvestigacion*100, 2),'%')) %>% 
    add_trace(y = ~porComunitaria, name = "Circulación Comunitaria", color = I("indianred3")) %>% 
    add_trace(y = ~porEstrecho, name = "Contactos Estrechos", color = I("olivedrab3")) %>% 
    add_trace(y = ~porImportados, name = "Importados",  color = I("steelblue3")) %>% 
    layout(yaxis = list(title = "% según Tipo de Caso", tickformat = "%"), 
           xaxis=list(title=""),
           barmode = "stack",
           legend = list(orientation = 'h', font = list(size = 10)))
  
```



#### Cantidades
```{r estudioCasos, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

  tipoCaso <- argCov %>% select(dia, Importados, Estrecho, Comunitaria, Investigacion)
  
  tipoCaso$dia <- as.Date(tipoCaso$dia, '%d/%m/%Y')
 
  plot_ly(tipoCaso, x = ~dia, y = ~Importados, type = "bar", name = "Importados",  color = I("steelblue3"),
          hoverinfo = 'text',
          text = ~paste('</br> Importados: ', Importados,
                      '</br> Contactos Estrechos: ', Estrecho,
                      '</br> Circulación Comunitaria: ', Comunitaria,
                      '</br> En Investigación: ', Investigacion)) %>% 
    add_trace(y = ~Estrecho, name = "Contactos Estrechos", color = I("olivedrab3")) %>% 
    add_trace(y = ~Comunitaria, name = "Circulación Comunitaria", color = I("indianred3")) %>% 
    add_trace(y = ~Investigacion, name = "En Investigación",  color = I("orchid3")) %>% 
    layout(yaxis = list(title = "Tipos de casos"), barmode = "stack",
           legend = list(x = 0.029, y = 1.038, font = list(size = 10)))
  
```

## Test


Desde el día 16/03/2020 el Ministerio de Salud comenzó a informar la cantidad de pruebas diagnósticas y casos descartados de COVID-19.
A continuación se visualiará la evolución en la proporción de los casos detectados sobre la cantidad de pruebas analizadas, la cantidad de test realizados hasta la fecha y la proporción de la cantidad de test por millón de habitantes

####  {.tabset  .tabset-fade .tabset-pills}
##### Tasa de Positividad
A continuación se visualiará la evolución en la proporción de los casos detectados sobre la cantidad de pruebas analizadas. 
```{r test, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}

  test <- argCov %>% select(dia, DescTest, Detectados, Recuperados, MuestraD) %>%
         # mutate(total = DescTest + Detectados)
      mutate(total = DescTest + Detectados+ Recuperados)
  test <- test %>% filter(DescTest >= 0) %>%  mutate(prop= round(Detectados/total * 100, 2)) %>% arrange(dia)
 
  test$dia <-as.Date(test$dia, "%d/%m/%Y")
  
  plot_ly(test, x = ~dia, y = ~prop, type = "bar", name = "Tasa de Positividad",
           texttemplate = '%{y:.2s}', textposition = 'outside') %>% 
    layout(title="Tasa de Positividad", xaxis=list(title=""), yaxis = list(title = "Tasa de Positividad (%)"))
  

```

##### Cantidades
```{r propTestD, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%'}
  p4 <- plot_ly(test, x = ~dia, y = ~DescTest, type = "bar", name = "Test Negativos") %>% 
            add_trace(y = ~Detectados, name = "Test Positivos") %>% 
        layout(title="Cantidad de Test Realizados", yaxis = list(title = "Acumulado de Pruebas Realizadas"), barmode = "stack")
  p4

  
```


##### Test por Habitantes
```{r tesHab}
   testHab <- argCov %>%
      mutate(porHab = round(TotalPruebas/45376763*1000000, 1)) %>% select(dia, porHab) 
  
    testHab$dia <- as.Date(testHab$dia, "%d/%m/%Y")
    plot_ly(testHab, x = ~dia, y = ~(porHab), type = "bar", name = "Tasa de Positividad",
           texttemplate = '%{y:.4s}', 
         textposition = 'outside') %>% 
    layout(title="Test x Millón de Habitantes", xaxis=list(title=""), yaxis = list(title = "Test x millón de Habitantes"))

```





# Entre Ríos

## Casos por Departamento
A continuación se muestran la cantidad de casos de COVID-19 confirmados por el Ministerio de Salud de Entre Ríos, discriminados por departamento y localidad


###  {.tabset  .tabset-fade .tabset-pills}
#### Departamental
```{r mapaER}

  covider <- covid_er %>% group_by(DEPARTAMENTO) %>%
    mutate(cantidad=n()) %>% select(DEPARTAMENTO, cantidad) %>% unique()
  
  
  highchart() %>%
    hc_title(text = "<i>Casos de COVID-19 en Entre Ríos</i> ",
             margin = 20, align = "center", style = list(color = "#08338F", useHTML = TRUE)) %>%
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(entrerios, covider, name = "Casos", value = "cantidad",
                      joinBy = c("nam", "DEPARTAMENTO"),
                      dataLabels = list(enabled = TRUE,
                                        format = '{point.properties.nam}: {point.value}')) %>%
    hc_colorAxis(minColor = "#B7D4EB", maxColor = "#08338F")  %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud ER')) %>% 
    hc_chart(borderColor = "#08338F", borderRadius = 10, borderWidth = 2)
  
```



#### Por Ciudad
```{r locER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
 
  localidades_er <- covid_er %>% group_by(Lat, Long) %>% mutate(cant=n()) %>% 
    select(LOCALIDAD, Lat, Long, cant) %>% unique() %>% ungroup()
  
  leaflet() %>% addTiles() %>% 
      # addProviderTiles(providers$OpenStreetMap) %>% 
         addTiles(urlTemplate = urlign ) %>% 
      addPolygons(data=deptos_er, fill=FALSE, weight = 1, color = "#000")  %>% 
      addCircleMarkers(data=localidades_er,  lat = localidades_er$Lat, lng = localidades_er$Long, 
                       radius = ~cant*3, weight = 1, color = "red", 
                       popup = paste(localidades_er$LOCALIDAD, ": ",localidades_er$cant)) 
    
```








## Incidencia Acumulada

En Argentina, la tasa de incidencia acumulada nacional es de `r round(sum(argCov$casosD)/45376763 * 100000, 2)` cada 100 mil habitantes. La Incidencia Acumulada de toda la provincia de Entre Ríos es de `r round(sum(covider$cantidad)/sum(poblac_er$poblacion, na.rm = T)*100000, 2)` cada 100.000 habitantes.

La incidencia acumulada (IA) a nivel departamental, considerando la población proyectada por INDEC para el 2020 se observan en el mapa y tabla a continuación


###  {.tabset  .tabset-fade .tabset-pil}
#### Mapa
```{r casosER}


   
   covid_er_ia <- covider %>% left_join(poblac_er, by=c("DEPARTAMENTO"="departamento")) %>% 
       mutate(ia= round(cantidad/poblacion * 100000, 2)) %>% arrange(desc(ia))

   highchart() %>%
    hc_title(text = "<i>Incidencia Acumulada de COVID-19 en Entre Ríos</i> ",
             margin = 20, align = "center", style = list(color = "#780000", useHTML = TRUE)) %>%
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(entrerios, covid_er_ia, name = "Incidencia", value = "ia",
                      joinBy = c("nam", "DEPARTAMENTO"),
                      dataLabels = list(enabled = TRUE,
                                        format = '{point.properties.nam}: {point.value}')) %>%
    hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud ER')) %>% 
    hc_chart(borderColor = "#780000", borderRadius = 10, borderWidth = 2)

```

#### Tabla
```{r tablaIAER}
 tabiaprov_er <- covid_er_ia %>% select(DEPARTAMENTO, poblacion, cantidad, ia) %>% arrange(desc(ia))
  tabiaprov_er %>% kable(col.names = c("Departemento","Población",  "Casos", "Tasa Incidencia"),
                      format.args = list( big.mark=".", decimal.mark = ","),
            align=c('l', 'c', 'c', 'c')) %>%
  kable_styling()
```