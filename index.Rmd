---
title: "COVID-GIBD"
knit: (function(inputFile, encoding) { 
         rmarkdown::render(inputFile,
                           encoding=encoding, 
                           output_file=file.path(dirname(inputFile), 'docs', 'index.html')) })
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(knitr)
library(kableExtra)
library(highcharter)
library(rjson)

covid19 <- read_csv("https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
covid19 <- covid19[-1]

covid19_m <- read_csv("https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
covid19_m <- covid19_m[-1]

argentina <- fromJSON(file = "data/ar-all.geo.json")
sud <- fromJSON(file="data/south-america.geo.json")

covidArg <-read_delim("data/COVID_Arg.csv", ";", 
                      escape_double = FALSE, trim_ws = TRUE, locale = locale(encoding = "ISO-8859-1"))

poblacion <- data.frame( c('Argentina', 'Bolivia', 'Brazil', 'Chile', 'Colombia', 'Ecuador',  'Paraguay',	'Peru',	'Surinam', 'Uruguay',  'Venezuela'), 
  c(44938712, 11383094,	210147125,19107216,	50372424,	17300000,	 7152703, 33105273,524000, 3529014, 28067000)) 

names(poblacion) <- c('pais', 'poblacion')



covidArg$recuperados <- if_else(is.na(covidArg$recuperados), 0, covidArg$recuperados)
covidArg$FALLECIDOS <- if_else(is.na(covidArg$FALLECIDOS), 0, covidArg$FALLECIDOS)

paises_sa <- c('Brazil', 'Argentina', 'Chile', 'Peru', 'Paraguay', 'Bolivia', 'Uruguay', 'Colombia', 'Venezuela',  'Ecuador', 'Guayana Francesa')

## Sudamérica
sudamerica <- covid19 %>% 
  filter(`Country/Region` %in% paises_sa) 
sudamerica <- sudamerica[,-c(2:38)]
sudamerica <- sudamerica %>% 
  gather(fecha, casos, 2:max(col(sudamerica)), -`Country/Region`) 

names(sudamerica) <- c('pais', 'fecha', 'casos')
sudamerica$fecha <-paste0(sudamerica$fecha,'20')
sudamerica$fecha <- as.Date(sudamerica$fecha ,"%m/%d/%Y")

sudamerica<-sudamerica %>%
  filter(casos > 0) %>% 
  group_by(pais) %>% 
  arrange(pais,fecha) %>% 
  mutate(dia= 1:n())

sudamerica<-sudamerica %>%
  filter(casos > 0) %>% 
  group_by(pais)

sudamerica_m <- covid19_m %>% 
  filter(`Country/Region` %in% paises_sa) 
sudamerica_m <- sudamerica_m[,-c(2:38)]
sudamerica_m <- sudamerica_m %>% 
  gather(fecha, casos, 2:max(col(sudamerica_m)), -`Country/Region`) 

names(sudamerica_m) <- c('pais', 'fecha', 'fallecidos')
sudamerica_m$fecha <-paste0(sudamerica_m$fecha,'20')
sudamerica_m$fecha <- as.Date(sudamerica_m$fecha ,"%m/%d/%Y")

sudamerica_m<-sudamerica_m %>%
  filter(fallecidos > 0) %>% 
  group_by(pais) %>% 
  arrange(pais,fecha) %>% 
  mutate(dia= 1:n())

sudamerica_m<-sudamerica_m %>%
  filter(fallecidos > 0) %>% 
  group_by(pais)

```

## Sudamérica

En Sud América se informa el día `r day(min(sudamerica$fecha))` de `r format(min(sudamerica$fecha), "%b")` del 2020 en `r sudamerica %>% filter(fecha==min(sudamerica$fecha)) %>% select(pais)`. 


### Evolución de nuevos casos
La evolución de casos acumulados por país se muestra desde el día en que se detectó por primera vez un infectado.

A las gráficas se les ha agregado la tendencia (basada en el modelo de regresión local)

####  {.tabset  .tabset-fade .tabset-pills}
##### Por país
```{r casospais, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}

sudamerica %>% 
  group_by(pais) %>% 
  ggplot(aes(x=dia, y=casos, color=pais))+
  geom_line( show.legend=FALSE) +
  geom_smooth(se=F, show.legend = F) +                  
  labs(title="Casos detectados COVID-19 ", x='día',
       y="Cantidad de casos", caption="Datos: Universidad Johns Hopkins") + 
  facet_wrap(~pais,  ncol=4)
```

##### Sudamérica
Las curvas de evolución de los países en simultáneo:

```{r pressure, echo=FALSE, out.width='90%', fig.align='center'}
sudamerica %>%
  ggplot(aes(x=dia, y=casos, group=pais, color=pais)) + 
  geom_line(size=1.2 ) + geom_point()+
  labs(title="COVID-19 en Sudamérica", y="Cantidad de casos", caption="Datos: Universidad Johns Hopkins") + 
  theme_minimal() + labs(color='Países') 
```

##### Fechas de Inicio
A continuación se muestran las fechas en que se detectó por primera vez un infectado en cada país:
```{r tablaFechas, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', out.width='50%'}

t_fechas <- sudamerica %>% 
  group_by(pais) %>%  arrange( fecha ) %>% 
  mutate(inicio= format(min(fecha),'%d/%m/%Y') ) %>% 
  select(pais, inicio)%>% 
  unique() 
t_fechas %>%  kable( col.names =  c("País", "Fecha 1° Caso"), align = c('l','c')) %>% kable_styling()
```


### Incidencia Acumulada
La incidencia acumulada (IA) proporciona una estimación de la probabilidad o el riesgo de que un individuo libre de una determinada enfermedad la desarrolle durante un período especificado de tiempo.

Al día de la fecha las incidencias acumuladas por cada 100000 habitantes de los países de Sud América es: 

####  {.tabset  .tabset-fade .tabset-pills}
##### Mapa
```{r mapSud, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
ia <- sudamerica %>% 
  group_by(pais) %>% 
  filter(dia==max(dia)) %>% 
  left_join(poblacion ) %>% 
  mutate(inc= as.double(round(casos/poblacion*100000, 2))) %>%  
  select(pais, dia, poblacion, casos, inc) %>% 
  arrange(desc(inc))

highchart() %>%
        hc_title(text = "<i>Incidencia COVID-19 en Sudamérica</i> - <b>GIBD</b>",
           margin = 20, align = "center",
           style = list(color = "#08338F", useHTML = TRUE)) %>% 
               hc_tooltip(followPointer =  FALSE) %>%
        hc_add_series_map(sud, ia, name = "IA",
                          value = "inc", joinBy = c("name", "pais"),
                          dataLabels = list(enabled = TRUE,
                                            format = '{point.properties.woe-name}')) %>%
        hc_colorAxis(minColor = "#B7D4EB", maxColor = "#08338F")  %>%
        hc_legend(align = "center", x = 0, y = -70) %>%
        hc_mapNavigation(enabled = TRUE) %>%
        hc_add_theme(hc_theme_ffx()) %>% 
        hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Datos Propios')) %>% 
        hc_chart(borderColor = "#08338F",
           borderRadius = 10,
           borderWidth = 2)

```

##### Tabla Datos
Como se observa, el país con la mayor Incidencia Acumulada al día de hoy es **`r ia[1,1] `**, que lleva *`r ia[1,2] ` días* desde la detección del primer caso.
```{r ia, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
ia  %>% kable( col.names =  c("País", "Días", "Población","# Casos", "IA"),
          align =  c('l', 'c', 'c', 'c', 'c') ) %>% 
    kable_styling()
```


### Mortalidad
A continuación se grafica la evolución de las cantidades de fallecimientos desde la detección del virus en cada país, y la tabla correspondiente a la cantidad acumulada al día de la fecha.

####  {.tabset  .tabset-fade .tabset-pills}
##### Gráfico
```{r muertesg, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}

sudamerica_m %>% 
  group_by(pais) %>% 
  ggplot(aes(x=dia, y=fallecidos, color=pais))+
  geom_line( show.legend=FALSE) +
  geom_smooth(se=F, show.legend = F) +                  
  labs(title="", x='día',
       y="Cantidad de Fallecidos", caption="Datos: Universidad Johns Hopkins") + 
  facet_wrap(~pais,  ncol=4)
# scales="free",
```

##### Tabla

Al día de la fecha las incidencias acumuladas por cada 100000 habitantes de los países de Sud América es: 

```{r muertes_t, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
ambos <- sudamerica %>% 
  left_join(sudamerica_m, by=c('pais', 'fecha'))
ambos$fallecidos <- if_else(is.na(ambos$fallecidos), 0, ambos$fallecidos)
ambos <- ambos[-6]

muertes <- sudamerica_m %>% 
  group_by(pais) %>% 
  filter(dia==max(dia)) %>% 
  select(pais, fallecidos) %>% arrange(desc(fallecidos))
  muertes  %>% kable( col.names =  c("País", "# Fallecidos"),
          align =  c('l', 'c') ) %>%    kable_styling()
```

### Tasa de Mortalidad
Una proporción interesante a comparar es la **tasa de mortalidad particular**, es decir la cantidad de personas que fallecieron respecto al total de casos en un período de tiempo.
A continuación se muestra la evolución de la tasa de mortalidad en los distintos países considerando el primer día de detección del virus

```{r tasa_mort, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}

ambos <- ambos %>%   mutate(tasa_m= fallecidos/casos * 100)

ambos %>%
  ggplot(aes(x=dia.x, y=tasa_m, group=pais, color=pais)) + 
  geom_line(size=1.2 ) + geom_point()+
  labs(title="Tasa de mortalidad en Sudamérica", y="Tasa de mortalidad", caption="Datos: Universidad Johns Hopkins") + theme_minimal() + labs(color='Países') 

```


### Casos letales sobre Casos Totales

En el siguiente gráfico se muestran las series de cantidades de casos y cantidades de fallecidos en cada país

```{r casos_muertes, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}

 casos<- ambos %>% select(pais, dia.x, casos, fallecidos) %>% 
  gather(tipo, cant, -c(pais, dia.x))

ggplot(data = casos, aes(x=dia.x, y=cant, group=tipo))+
        geom_line(aes(linetype=tipo, color=tipo))+
        geom_point(aes(shape=tipo, color=tipo))+
          labs(title='Cantidades de Casos y Fallecidos')+
          labs(x = 'Año', y = expression(''))+
          # scale_color_manual(values=c("navy", "red2"))+
          theme(legend.position="bottom") + 
  facet_wrap(~pais,  ncol=4) 
# scales="free",
```

#### Trayectoria de Nuevos Casos
Este gráfico (propuesto por https://aatishb.com/covidtrends/) muestra los nuevos casos confirmados de COVID-19 en la última semana frente al total de casos confirmados hasta la fecha. Cuando se traza de esta manera, el crecimiento exponencial se representa como una línea recta que se inclina hacia arriba. Tenga en cuenta que casi todos los países siguen un camino muy similar de crecimiento exponencial.

## Argentina

En Argentina los datos son informados diariamente por el Ministerio de Salud de la Nación. Estos datos se informan de manera desestructurada y diariamente se modifican los datos brindados.

Los datos con los que se trabajarán son de procesamiento propio en base a los informes mencionados.
```{r mapas, echo=FALSE, message=FALSE, warning=FALSE}
covidArg_hoy <- covidArg %>% 
  group_by(PROVINCIA) %>% 
  mutate(total=sum(CASOS)) %>% select(PROVINCIA, total) %>% unique()


highchart() %>%
        hc_title(text = "<i>Mapa dinámico de COVID-19 en Argentina</i> - <b>GIBD</b>",
           margin = 20, align = "center",
           style = list(color = "#08338F", useHTML = TRUE)) %>% 
        hc_subtitle(text = "Casos detectados por provincia",
              align = "center",
              style = list(color = "#0C5C9E", fontWeight = "bold")) %>% 
        hc_tooltip(followPointer =  FALSE) %>%
        hc_add_series_map(argentina, covidArg_hoy, name = "Total",
                          value = "total", joinBy = c("name", "PROVINCIA"),
                          dataLabels = list(enabled = TRUE,
                                            format = '{point.properties.woe-name}')) %>%
        hc_colorAxis(minColor = "#B7D4EB", maxColor = "#08338F")  %>%
        hc_legend(align = "center", x = 0, y = -70) %>%
        hc_mapNavigation(enabled = TRUE) %>%
        hc_add_theme(hc_theme_ffx()) %>% 
        hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Datos Propios')) %>% 
        hc_chart(borderColor = "#08338F",
           borderRadius = 10,
           borderWidth = 2)
```

### Evolución por Provincia

La notificación de los casos por jurisdicción se realiza teniendo en cuenta la residencia según el Registro Nacional de las Personas. Pudiendo variar en función de la investigación de la jurisdicción. 
A continuación se muestra la evolución de nuevos casos detectados por día para cada una de las provincias argentinas.

```{r ev_prov, echo=FALSE, fig.align='center', message=FALSE,fig.show='asis',fig.dim = c(5, 7), warning=FALSE, out.width='100%', paged.print=FALSE}

covidArg$FECHA<-as.Date(covidArg$FECHA, format = "%d/%m/%Y")

covidArg %>% 
  group_by(PROVINCIA, FECHA) %>%
  mutate(diario=sum(CASOS)) %>% 
  select(PROVINCIA, FECHA, diario) %>% unique() %>% 
    ggplot(aes(x=FECHA, y=diario, group_by(PROVINCIA)))+
    geom_line( show.legend=FALSE, color='blue') +
    # geom_smooth(se=F, show.legend = F) +                  
    labs( #title="Casos detectados COVID-19 ", 
          x='',
         y="Cantidad de casos", caption="Datos: Min. Salud Arg.") + 
    # facet_wrap(PROVINCIA ~ .,  ncol=1) +
 facet_wrap( ~PROVINCIA,  ncol=3) +
  theme_bw() +
     theme(panel.grid.major.x = element_blank(), 
       panel.grid.minor.x = element_blank(),
       panel.grid.major.y = element_blank(),
       panel.grid.minor.y = element_blank())+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=45, hjust=.5, vjust=.5),
                        axis.text.y = element_text(colour="grey20", size=8),
          text=element_text(size=11, family="Arial"))


```
En la provincia de Buenos Aires y Ciudad de Buenos Aires se observa una cantidad decreciente muy pronunciada el día 29/03/2020, esto se debe a la reasignación de jurisdicción informada por Ministerio. Se asignó al día en que fueron informadas debido a la falta del dato sobre el caso reasignado.


Este gráfico interactivo muestra los nuevos casos confirmados de COVID-19 en la última semana frente al total de casos confirmados hasta la fecha. Cuando se traza de esta manera, el crecimiento exponencial se representa como una línea recta que se inclina hacia arriba. Tenga en cuenta que casi todos los países siguen un camino muy similar de crecimiento exponencial.

```{r argGral, echo=FALSE, message=FALSE, warning=FALSE}
# gralArg<- read_delim("data/detalle_casos.csv", ";", 
#                       escape_double = FALSE, trim_ws = TRUE, locale = locale(encoding = "ISO-8859-1"))
gralArg <- read_delim("data/detalle_casos.csv", 
    ";", escape_double = FALSE, locale = locale(decimal_mark = ","), 
    na = "0", trim_ws = TRUE)

gralArg$Fallecidos <- if_else(is.na(gralArg$Fallecidos ), 0, gralArg$Fallecidos )
gralArg$Recuperados <- if_else(is.na(gralArg$Recuperados ), 0, gralArg$Recuperados )
gralArg$Terapia <- if_else(is.na(gralArg$Terapia ), 0, gralArg$Terapia )
gralArg$`Tests Totales` <- if_else(is.na(gralArg$`Tests Totales`), 0, gralArg$`Tests Totales`)
gralArg$TasaExp <- if_else(is.na(gralArg$TasaExp), 0.0, gralArg$TasaExp)

ggplot(data = gralArg, aes(x = CasosTot, y = Nuevos)) +
     geom_line()
  
 
```
