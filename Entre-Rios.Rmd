---
title: "Entre Ríos"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r carga, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
  library(readr)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(lubridate)
  library(knitr)
  library(kableExtra)
  library(highcharter)
  library(rjson)
  library(plotly)
  library(gganimate)
  library(stringr)
  library(leaflet)
  library(leaflet.extras)
  library(sf)
  library(tmap)
  library(googlesheets4)
  library(readxl)
  library("tidyverse")
  library("ggTimeSeries")
 

  theme_elegante_std <- function(base_family) {}


  entrerios <- fromJSON(file="data/mapas/entrerios_dpto.geo.json")
  deptos_er <- st_read(dsn ="data/mapas/departamentos_entrerios.shp") 
      
  ### ENTRE RIOS
  covid_er <- entre_rios_casos <- read_excel("data/entre_rios_casos.xlsx", "CASOS")
  covid_er_altas <- entre_rios_casos <- read_excel("data/entre_rios_casos.xlsx", "ALTAS")
  
  poblac_er <-  read_delim("data/poblaciones/poblacion_entre_rios.csv",  ";", escape_double = FALSE, 
                           locale = locale(decimal_mark = ",", 
                                           grouping_mark = ".", encoding = "ISO-8859-1"), trim_ws = TRUE)
  names(poblac_er) <- c("departamento", "poblacion")
     
  ### Base Nación
  # covid19ER <- read_excel("data/covid19casos.xlsx")
   covid19ER <- read_csv("data/Covid19Casos.csv")
  names(covid19ER) <- c("id_evento_caso", "sexo", "edad", "edad_anos_meses", "residencia_pais_nombre",
                        "residencia_provincia_nombre", 	"residencia_departamento_nombre",
                        "carga_provincia_nombre", 	"fecha_inicio_sintomas", 	"fecha_apertura",
                        "sepi_apertura", 	"fecha_internacion", 	"cuidado_intensivo", 	"fecha_cui_intensivo",
                        "fallecido", 	"fecha_fallecimiento",	"asistencia_respiratoria_mecanica",
                        "carga_provincia_id",	"origen_financiamiento",	"Clasificacion",
                        "clasificacion_resumen",	"residencia_provincia_id", 	"fecha_diagnostico",
                        "residencia_departamento_id",	"ultima_actualizacion")
  covid19ER <- covid19ER %>% filter(residencia_provincia_nombre=="Entre Ríos")
  
  covid19ER_Conf <- covid19ER %>%
    filter(clasificacion_resumen=="Confirmado" & carga_provincia_nombre=="Entre Ríos")
  # table(covid19ER_Conf$sexo)
    
  covid19ER_Rec <- covid19ER %>% 
    filter(fallecido=="NO" & clasificacion_resumen=="Confirmado" &
             Clasificacion %in% c("Caso confirmado - No activo (por laboratorio y tiempo de evolución)",
                                  "Caso confirmado - No Activo por criterio de laboratorio", 
                                  "Caso confirmado - No activo (por tiempo de evolución)")) %>%
     group_by(residencia_provincia_nombre, residencia_departamento_nombre) %>%
     mutate(altas=n()) %>%
     select(residencia_provincia_nombre, residencia_departamento_nombre, altas) %>% unique()
  
  covid19ER_Sosp <- covid19ER %>% 
    filter(clasificacion_resumen=="Sospechoso" & carga_provincia_nombre=="Entre Ríos") %>%
    group_by(residencia_provincia_nombre, residencia_departamento_nombre, Clasificacion) %>%
    mutate(sospechosos=n()) %>%
    select(residencia_provincia_nombre, residencia_departamento_nombre,Clasificacion, sospechosos) %>% unique()
  
  covid19ER_Desc <- covid19ER %>% filter(clasificacion_resumen=="Descartado") %>%
     group_by(residencia_provincia_nombre, residencia_departamento_nombre) %>%
     mutate(descartados=n())
  # %>% select(residencia_provincia_nombre, residencia_departamento_nombre, descartados) %>% unique()
  
  
  ### Movilidad
  poligonosMovil <- read_csv("data/poligonosMovil.csv",  locale = locale(encoding = "ISO-8859-1"))
  
  movement <- read_delim("data/movement-range.txt", 
                         "\t", escape_double = FALSE, locale = locale(encoding = "ISO-8859-1"), 
                         trim_ws = TRUE) %>% filter(country=="ARG") 

  datos_mov <- movement %>% left_join(poligonosMovil, by=c("polygon_id" = "GID_2")) %>% 
    filter(NAME_1 =="Entre Ríos")
   
  datos_mov$polygon_name <- gsub("Col-n", "Colón", datos_mov$polygon_name )
  datos_mov$polygon_name <- gsub("Nogoy-", "Nogoyá", datos_mov$polygon_name )
  datos_mov$polygon_name <- gsub("Federaci-n", "Federación", datos_mov$polygon_name )
  datos_mov$polygon_name <- gsub("Gualeguaych-", "Gualeguaychú", datos_mov$polygon_name )
  datos_mov$polygon_name <- gsub("Paran-", "Paraná", datos_mov$polygon_name )
  
```

<!-- # Entre Ríos -->
## Evolución diaria
La evolución de casos por departamento desde el inicio de la pandemia se muestra a continuación

```{r evolER, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%' }
   
   covid_er$FECHA <- as.Date(covid_er$FECHA, '%d/%m/%Y')
   evolER <- covid_er %>% group_by(DEPARTAMENTO, FECHA) %>% 
     mutate(cantidad= n()) %>% select(DEPARTAMENTO, FECHA, cantidad) %>% unique()
   
   evolER$acumulados <-0
   evolER <- evolER %>% ungroup() %>% group_by(DEPARTAMENTO) %>% 
    arrange(DEPARTAMENTO, FECHA) %>% 
    mutate(acumulados =cumsum(cantidad))
   
   evolER <- evolER %>%
    gather(cantidad, acum, -c(DEPARTAMENTO, FECHA))
   names(evolER) <- c("departamento", "fecha", "tipo", "cant")
   
   p <- evolER %>%
     filter(cant>0&tipo=="acumulados") %>%
     group_by(departamento) %>% arrange(fecha) %>% mutate(dia1 = row_number())
   
   fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~departamento, type = "scatter", mode='lines+markers')
   fig <- layout(fig, title="Evolución de casos confirmados por Departamento",
                 xaxis = list(title = "día"), yaxis = list(title = "casos"))
   fig

     
```


## Casos por Departamento
A continuación se muestran la cantidad de casos de COVID-19 confirmados por el Ministerio de Salud de Entre Ríos, discriminados por departamento y localidad


###  {.tabset  .tabset-fade .tabset-pills}
#### Departamental
```{r mapaER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

  covider <- covid_er %>% group_by(DEPARTAMENTO) %>%
    mutate(cantidad=n()) %>% select(DEPARTAMENTO, cantidad) %>% unique()
  
  
  highchart() %>%
    hc_title(text = "<i>Casos de COVID-19 en Entre Ríos</i> ",
             margin = 20, align = "center", style = list(color = "#08338F", useHTML = TRUE)) %>%
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(entrerios, covider, name = "Casos", value = "cantidad",
                      joinBy = c("nam", "DEPARTAMENTO"),
                      dataLabels = list(enabled = TRUE,
                                        format = '{point.properties.nam}: {point.value}')) %>%
    hc_colorAxis(minColor = "#B7D4EB", maxColor = "#08338F")  %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud ER')) %>% 
    hc_chart(borderColor = "#08338F", borderRadius = 10, borderWidth = 2)
  
```



#### Por Ciudad
```{r locER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
 
  localidades_er <- covid_er %>% group_by(Lat, Long) %>% mutate(cant=n()) %>% 
    select(LOCALIDAD, Lat, Long, cant) %>% unique() # %>% ungroup()
 
  leaflet() %>% addTiles() %>% 
      addProviderTiles(providers$OpenStreetMap) %>% 
      addPolygons(data=deptos_er, fill=FALSE, weight = 1, color = "#000")  %>% 
      addFullscreenControl()  %>%  
  # addCircleMarkers(data=covid_er, lng =  as.double(covid_er$Long), lat = as.double(covid_er$Lat), 
  #            clusterOptions = markerClusterOptions(maxClusterRadius=30), clusterId = "pointsCluster") %>%
  addMarkers(data=covid_er, lng =  as.double(covid_er$Long), lat = as.double(covid_er$Lat),
             clusterOptions = markerClusterOptions(singleMarkerMode= T), clusterId = "pointsCluster") %>%
  addEasyButton(
    easyButton(states =  list(easyButtonState( 
      stateName="unfrozen-markers", icon="ion-toggle",
      title="Freeze Clusters",
      onClick = JS("function(btn, map) 
      {var  clusterManager = map.layerManager.getLayer('cluster', 'pointsCluster');
      clusterManager.freezeAtZoom();
      btn.state('frozen-markers');}")),
      easyButtonState(
        stateName="frozen-markers",
        icon="ion-toggle-filled",
        title="UnFreeze Clusters",
        onClick = JS("function(btn, map) {
        var clusterManager = map.layerManager.getLayer('cluster', 'pointsCluster');
        clusterManager.unfreeze();
        btn.state('unfrozen-markers');}"))
      )))

  
```







## Casos Activos
A continuación se muestran la cantidad de casos Activos de COVID-19. Los casos activos son los confirmados menos los recuperados y fallecidos


###  {.tabset  .tabset-fade .tabset-pills}
#### Departamental
```{r mapaERAct, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
  
  # activos <- covid19ER_Conf %>% 
  # group_by(residencia_provincia_nombre, residencia_departamento_nombre) %>% mutate(conf=n()) %>% 
  covider$provincia <- "Entre Ríos"

  activos <- covider %>% 
  # select(residencia_provincia_nombre, residencia_departamento_nombre, conf) %>% unique() %>% 
    left_join(covid_er_altas, by=c("DEPARTAMENTO"="DEPARTAMENTO"))

  # covider
  
  activos$altas <- if_else(is.na(activos$ALTAS), 0, as.double(activos$ALTAS))  
  activos$FALLECIDOS <- if_else(is.na(activos$FALLECIDOS), 0, as.double(activos$FALLECIDOS))  
  
  activos$activos <- activos$cantidad - activos$altas - activos$FALLECIDOS
  
  
  
  colors <- c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026")

  highchart() %>%
    hc_title(text = "<i>Casos Activos COVID-19 por Departamento en Entre Ríos</i> - <b>GIBD</b>",
             margin = 5, align = "center", 
             style = list(color = "#bd0026", useHTML = TRUE, fontWeight = "bold")) %>% 
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(entrerios, activos, name = "Activos", value = "activos",
                      joinBy = c("nam", "DEPARTAMENTO"),
                      dataLabels = list(enabled = TRUE,
                                        format = '{point.properties.nam}: {point.value}')) %>%
    hc_colorAxis(stops=color_stops(n=length(colors), colors = colors)) %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerios de Salud Nación')) %>% 
    hc_chart(borderColor = "#bd0026", borderRadius = 10, borderWidth = 2)
  
```





## Fallecidos
A continuación se muestra el mapa departamental de los fallecidos COVID-19 en la provincia de Entre Ríos.

###  {.tabset  .tabset-fade .tabset-pills}
#### Mapa
```{r mapaERFall, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
  
  # activos <- covid19ER_Conf %>% 
  # group_by(residencia_provincia_nombre, residencia_departamento_nombre) %>% mutate(conf=n()) %>% 
  # covider$provincia <- "Entre Ríos"

  fallecidos <- covider %>% 
  # select(residencia_provincia_nombre, residencia_departamento_nombre, conf) %>% unique() %>% 
    left_join(covid_er_altas, by=c("DEPARTAMENTO"="DEPARTAMENTO"))

  # covider
  
  # fallecidos$altas <- if_else(is.na(activos$ALTAS), 0, as.double(activos$ALTAS))  
  fallecidos$FALLECIDOS <- if_else(is.na(fallecidos$FALLECIDOS), 0, as.double(fallecidos$FALLECIDOS))  
  
  # activos$activos <- activos$cantidad-activos$altas - activos$FALLECIDOS
  
  
  
  colors <- c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026")

  highchart() %>%
    hc_title(text = "<i>COVID-19 - Fallecidos por Departamento en Entre Ríos</i> - <b>GIBD</b>",
             margin = 5, align = "center", 
             style = list(color = "#bd0026", useHTML = TRUE, fontWeight = "bold")) %>% 
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(entrerios, fallecidos, name = "Fallecidos", value = "FALLECIDOS",
                      joinBy = c("nam", "DEPARTAMENTO"),
                      dataLabels = list(enabled = TRUE,
                                        format = '{point.properties.nam}: {point.value}')) %>%
    hc_colorAxis(stops=color_stops(n=length(colors), colors = colors)) %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerios de Salud Nación')) %>% 
    hc_chart(borderColor = "#bd0026", borderRadius = 10, borderWidth = 2)
  
```


## Incidencia Acumulada

La Incidencia Acumulada de toda la provincia de Entre Ríos es de `r round(sum(covider$cantidad)/sum(poblac_er$poblacion, na.rm = T)*100000, 2)` cada 100.000 habitantes.

La incidencia acumulada (IA) a nivel departamental, considerando la población proyectada por INDEC para el 2020 se observan en el mapa y tabla a continuación


###  {.tabset  .tabset-fade .tabset-pil}
#### Mapa
```{r casosER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}


   
   covid_er_ia <- covider %>% left_join(poblac_er, by=c("DEPARTAMENTO"="departamento")) %>% 
       mutate(ia= round(cantidad/poblacion * 100000, 1)) %>% arrange(desc(ia))

   highchart() %>%
    hc_title(text = "<i>Incidencia Acumulada de COVID-19 en Entre Ríos</i> ",
             margin = 20, align = "center", style = list(color = "#780000", useHTML = TRUE)) %>%
    hc_tooltip(followPointer =  FALSE) %>%
    hc_add_series_map(entrerios, covid_er_ia, name = "Incidencia", value = "ia",
                      joinBy = c("nam", "DEPARTAMENTO"),
                      dataLabels = list(enabled = TRUE,
                                        format = '{point.properties.nam}: {point.value}')) %>%
    hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
    hc_legend(align = "center", x = 0, y = -10) %>%
    hc_mapNavigation(enabled = TRUE) %>%
    hc_add_theme(hc_theme_ffx()) %>% 
    hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud ER')) %>% 
    hc_chart(borderColor = "#780000", borderRadius = 10, borderWidth = 2)

```

#### Tabla
```{r tablaIAER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
 tabiaprov_er <- covid_er_ia %>% select(DEPARTAMENTO, poblacion, cantidad, ia) %>% arrange(desc(ia))
  tabiaprov_er %>% kable(col.names = c("Departamento","Población",  "Casos", "Tasa Incidencia"),
                      format.args = list( big.mark=".", decimal.mark = ","),
            align=c('l', 'c', 'c', 'c')) %>%
  kable_styling()
```




## Composición por Edad
La composición de la siguiente pirámide poblacional de los casos confirmados fue confeccionada considerando las edades y sexo informado por el Ministerio de Salud ne su base de datos abiertos.
Representa el porcentaje por grupo etario y sexo de todos los pacientes con COVID-19 en Entre Ríos

<!-- ### {.tabset  .tabset-fade .tabset-pills} -->
#### Edad de casos confirmados
```{r piramideER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
  edadER <- covid19ER_Conf
  edadER$grEdad <- if_else(edadER$edad<10, "0 a 9", 
                          if_else(edadER$edad<20, "10 a 19", 
                          if_else(edadER$edad<30, "20 a 29", 
                          if_else(edadER$edad<40, "30 a 39",
                          if_else(edadER$edad<50, "40 a 49", 
                          if_else(edadER$edad<60, "50 a 59", 
                          if_else(edadER$edad<70, "60 a 69", 
                          if_else(edadER$edad<80, "70 a 79", "80 o más"))))))))
  
  edadER <- edadER %>% group_by(grEdad, sexo) %>% mutate(cant = n()) %>%
    select(grEdad, sexo, cant) %>% unique()
  
   edadER$sexo <- if_else(edadER$sexo=="M",  "Hombre", "Mujer")
   edadER <- edadER %>%  ungroup() %>% mutate(prop = round(cant/sum(cant)*100,2))
   edadER$prop <- if_else(edadER$sexo=="Hombre",  edadER$prop*-1, edadER$prop)
 
   plot_ly(edadER, x = ~prop, y = ~grEdad, color = ~sexo) %>%
     add_bars(orientation = "h",
           hoverinfo = "y+text+name", text =  ~paste(abs(prop), " %", '\n Cant.: (', cant,')'),  
           colors = c("#2c7fb8", "#fa9fb5")) %>%
     layout(bargap = 0.1, barmode = "overlay", 
            title = "Piramide Poblaciónal de Casos Confirmados en Entre Ríos", 
            xaxis = list(tickmode = "array", 
                       tickvals = c(-100, -50, -25, -20, -15, -10, -5, 0, 
                                      5, 10, 15, 20, 25, 50, 100),
                         ticktext = c("100", "50%", "25%", "20%", "15%", "10%","5%", "0",
                                      "5%", "10%", "15%","20%", "25%", "50%", "100%"),
                         title = "Casos Confirmados"), 
            yaxis = list(title = "Grupo Edad"))


```



## Casos Analizados
En Entre Ríos se han descartado casos sospechosos ya sea por invalidación epidemiológica como	por pruebas de laboratorio.

Para simplificar la lectura se graficará la cantidad de casos confirmados y descartados por semana epidemiológica. 

<!-- ### {.tabset  .tabset-fade .tabset-pills} -->
#### Casos confirmados y descartados
```{r descartados, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

 descartadosER <- covid19ER_Desc  %>%  filter(carga_provincia_nombre=="Entre Ríos")
 confirmadosER <- covid19ER_Conf %>%  filter(carga_provincia_nombre=="Entre Ríos") %>% 
   group_by(sepi_apertura) %>% 
   mutate(conf =n(), desde=min(fecha_apertura), hasta=max(fecha_apertura)) %>% 
   select(sepi_apertura, desde, hasta, conf)
   
 sem <- descartadosER %>% group_by(sepi_apertura) %>% 
   mutate(cant =n(), desde=min(fecha_apertura), hasta=max(fecha_apertura)) %>% 
  select(sepi_apertura, desde, hasta, cant)  %>% unique() %>% 
   left_join(confirmadosER, by=c("sepi_apertura"="sepi_apertura")) %>% 
   select(sepi_apertura, desde.x, hasta.x, cant, conf) %>% unique()
    
 sem$desde.x <- as.Date(sem$desde.x, "%d/%m/%Y")
 sem$hasta.x <- as.Date(sem$hasta.x, "%d/%m/%Y")
  
 plot_ly(sem, x = ~sepi_apertura, y = ~cant, type = "bar", name = "Descartados",  color = I("steelblue3"),
          hoverinfo = 'text',
          text = ~paste('</br> Desde: ', desde.x,
                      '</br> Hasta: ', hasta.x,
                      '</br> Confirmados: ', conf,
                      '</br> Descartados: ', cant)) %>% 
    add_trace(y = ~conf, name = "Confirmados", color = I("indianred3")) %>%
    layout(  title = "Casos Confirmados y Descartados en Entre Ríos", 
             xaxis = list(title="Semana Epidemiológica" ), 
           yaxis = list(title = "Estudiados"), 
           barmode = "stack",
           legend = list(font = list(size = 10)))


```



## Casos Sospechosos
En la base de datos nacional figuran al día `r as.Date(max(covid19ER$ultima_actualizacion), "%d/%m/%Y")`, un total de `r sum(covid19ER_Sosp$sospechosos)` casos sospechosos de COVID-19 cargados en el Sistema Nacional de Vigilancia.

La definición de caso es dinámica y puede variar según situación epidemiológica [Definición de Caso](https://www.argentina.gob.ar/salud/coronavirus-COVID-19/definicion-de-caso)

En Argentina sólo se procesan muestras que cumplen con la definición de caso sospechoso. La muestra enviada debe estar acompañada con los datos completos según Ficha de notificación, investigación epidemiológica y pedido de estudios de laboratorio. 

Entre estos casos hay algunos a los que ta se ha tomado la muestra y aún esperan resultados y otros a los que aún no se les ha realizado la muestra.

A continuación se graficará la cantidad de casos sospechosos por departamento y su clasificación

<!-- ### {.tabset  .tabset-fade .tabset-pills} -->
#### Casos Sospechosos
```{r sospechosos, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

  sospechosos <- covid19ER_Sosp %>%  group_by(residencia_departamento_nombre) %>% 
  spread(Clasificacion, sospechosos) %>% arrange(residencia_departamento_nombre)

  names(sospechosos) <- c("provincia", "departamento", "Con muestra sin resultado", "Muestra no apta",
                          "Sin muestra")
  
  sospechosos$`Sin muestra` <- if_else(is.na(sospechosos$`Sin muestra`), 0, as.double(sospechosos$`Sin muestra`))
  sospechosos$`Muestra no apta` <- if_else(is.na(sospechosos$`Muestra no apta`), 0, as.double(sospechosos$`Muestra no apta`))
  sospechosos$`Con muestra sin resultado` <- if_else(is.na(sospechosos$`Con muestra sin resultado`), 0, as.double(sospechosos$`Con muestra sin resultado`))
    
  plot_ly(sospechosos, x = ~departamento, y = ~`Con muestra sin resultado`, type = "bar", 
          name = "Con muestra sin resultado",  color =I("orchid3"), 
          hoverinfo = 'text',
          text = ~paste('</br> Departamento: ', departamento,
                        '</br> Con muestra sin resultado: ', `Con muestra sin resultado`)) %>% 
    add_trace(y = ~`Sin muestra`, 
              name = "Sin muestra", color = I("indianred3"),
              hoverinfo = 'text',
          text = ~paste('</br> Departamento: ', departamento,
                         '</br> Sin muestra: ',`Sin muestra`)) %>%
    add_trace(y = ~`Muestra no apta`,
               name = "Muestra no apta", color =I("olivedrab3"),
              hoverinfo = 'text',
          text = ~paste('</br> Departamento: ', departamento,
                        '</br> Muestra no apta: ', `Muestra no apta`)) %>%
    
    layout(title = "Casos sospechosos en Entre Ríos", 
           xaxis = list(title="Departamento" ), 
           yaxis = list(title = "Sospechosos"), 
           barmode = "stack",
           legend = list(font = list(size = 10)))


```


## Movilidad

A continuación se grafica el cambio en la movilidad de cada departamento tomando como linea de base la movilidad al mes de Febrero. Los datos utilizados son medidos por Facebook.

```{r movilidad, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
  
  datos_mov$movilidad <- round(-datos_mov$all_day_ratio_single_tile_users*100, 0)
  datos_mov$fecha <- datos_mov$ds
  
  p<- datos_mov %>% 
    # filter(NAME_1 =="Entre Ríos") %>%
    ggplot(mapping=aes(x=fecha, y=movilidad)) +
    geom_line(color="#67a9cf") +
    geom_point(color="#67a9cf") +
    geom_smooth(method = 'loess',
                formula = 'y ~ x', alpha = 0.2, size = 1, span = .3, se=FALSE, color="#ef8a62") + 
    labs(title = paste("COVID-19 en Entre Ríos"), 
         subtitle = paste0("Variación de la movilidad por departamento (al: ", max(datos_mov$ds), ")") , 
         caption = "Fuente: https://data.humdata.org/group/arg", 
         y = "Movilidad", 
         x = "Fecha") +
    facet_wrap(~ polygon_name, scales = "free_y", ncol = 3) +
    theme_elegante_std(base_family = "Assistant") 

  # p$ hoverinfo<- "name+x" #hover options for 'average'
  # p$data[[2]]$hoverinfo <- "name+x" #hover options for 'median'
  ggplotly(p, name="Movilidad",  height = 800)

```

