---
title: "Entre Ríos"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r carga, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(knitr)
library(kableExtra)
library(highcharter)
library(rjson)
library(plotly)
library(gganimate)
library(stringr)
library(leaflet)
library(leaflet.extras)
library(sf)
library(googlesheets4)
library(readxl)
library("tidyverse")
library("ggTimeSeries")
library(DT)
library(RcppRoll)

theme_elegante_std <- function(base_family) {}

entrerios <- fromJSON(file="data/mapas/entrerios_dpto.geo.json")
deptos_er <- st_read(dsn ="data/mapas/departamentos_entrerios.shp") 

### ENTRE RIOS
covid_er <- entre_rios_casos <- read_excel("data/entre_rios_casos.xlsx", "CASOS1")
localidades <- read_excel("data/entre_rios_casos.xlsx", "LOCALIDADES")
covid_er_fall <-  read_excel("data/entre_rios_casos.xlsx", "ALTAS")


diasH <- covid_er %>%  group_by(DEPARTAMENTO, FECHA) %>% mutate(casos = sum(CASOS)) %>% 
  select(departamento=DEPARTAMENTO, fecha=FECHA, casos) %>% unique()

## Razon
casos14 <- diasH %>% ungroup() %>%  group_by(departamento) %>%  filter(fecha >= today()-14) %>%  
  mutate(casos14 = sum(casos)) %>% 
  select(departamento, casos14) %>% unique()
casos28 <- diasH %>%  ungroup() %>%  group_by(departamento) %>% filter(fecha >= today() - 28 & fecha < today()-14) %>%  
  mutate(casos28 = sum(casos)) %>% 
  select(departamento, casos28) %>% unique()
razon <- casos14 %>% left_join(casos28)
razon$razon <- round(razon$casos14/razon$casos28, 1)

# casos a hoy
casosH <- diasH %>% ungroup() %>% 
  group_by(departamento) %>% mutate(casosH=sum(casos)) %>% 
  select(departamento, casosH) %>% unique()

dias <- covid_er %>%  filter(FECHA <= (max(FECHA) - days(7))) %>%
  group_by(DEPARTAMENTO, FECHA) %>% mutate(casos = sum(CASOS)) %>% 
  select(departamento=DEPARTAMENTO, fecha=FECHA, casos) %>% unique()
casosSem <- dias %>% ungroup() %>%
  group_by(departamento) %>% mutate(casosS=sum(casos)) %>%
  select(departamento, casosS) %>% unique()

dupl <- casosH %>%  left_join(casosSem, by = c("departamento" = "departamento"))
dupl$dias <- round(log2(2)/(log2(dupl$casosH) - log2(dupl$casosS))*7, 0)

poblac_er <-  read_delim("data/poblaciones/poblacion_entre_rios.csv",  ";", escape_double = FALSE,
                         locale = locale(decimal_mark = ",", grouping_mark = ".", encoding = "ISO-8859-1"), trim_ws = TRUE)
names(poblac_er) <- c("departamento", "poblacion")

### Base Nación
covid19ER <- read_csv("data/Covid19Casos.csv")

names(covid19ER) <- c("id_evento_caso", "sexo", "edad", "edad_anos_meses", 
                      "residencia_pais_nombre", "residencia_provincia_nombre",
                      "residencia_departamento_nombre", "carga_provincia_nombre",
                      "fecha_inicio_sintomas", 	"fecha_apertura",
                      "sepi_apertura", 	"fecha_internacion", 	"cuidado_intensivo", 	"fecha_cui_intensivo",
                      "fallecido", 	"fecha_fallecimiento",	"asistencia_respiratoria_mecanica",
                      "carga_provincia_id",	"origen_financiamiento",	"Clasificacion", "clasificacion_resumen",	
                      "residencia_provincia_id", 	"fecha_diagnostico", "residencia_departamento_id",	"ultima_actualizacion")

covid19ER <- covid19ER %>% filter(residencia_provincia_nombre=="Entre Ríos" & carga_provincia_nombre=="Entre Ríos")
# write.csv(covid19ER, "covidER.csv")

covid19ER_Conf <- covid19ER %>%
  filter(clasificacion_resumen=="Confirmado" & 
           carga_provincia_nombre=="Entre Ríos" & 
           residencia_provincia_nombre=="Entre Ríos")

covid19ER_Nexo <-covid19ER_Conf %>% 
  filter(Clasificacion %in% c("Caso confirmado por criterio clinico-epidemiológico - Activo",
                              "Caso confirmado por criterio clínico-epidemiologico - Fallecido",
                              "Caso confirmado por criterio clínico-epidemiológico  - No activo (por tiempo de evolución)",
                              "Caso confirmado por criterio clínico - epidemiológico -  Activo internado")) %>% 
  group_by(residencia_provincia_nombre, residencia_departamento_nombre) %>% mutate(nexo=n()) %>%
  select(residencia_provincia_nombre, residencia_departamento_nombre, nexo) %>% unique()

covid19ER_Lab <- covid19ER_Conf %>% 
  filter(!(Clasificacion %in% c("Caso confirmado por criterio clinico-epidemiológico - Activo",
                                "Caso confirmado por criterio clínico-epidemiologico - Fallecido",
                                "Caso confirmado por criterio clínico-epidemiológico  - No activo (por tiempo de evolución)",
                                "Caso confirmado por criterio clínico - epidemiológico -  Activo internado"))) %>% 
  group_by(residencia_provincia_nombre, residencia_departamento_nombre) %>% mutate(lab=n()) %>%
  select(residencia_provincia_nombre, residencia_departamento_nombre, lab) %>% unique()

covid19ER_Rec <- covid19ER %>%
  filter(carga_provincia_nombre=="Entre Ríos" &
           fallecido=="NO" & 
           clasificacion_resumen=="Confirmado" & 
           Clasificacion %in% c("Caso confirmado por criterio clínico-epidemiológico  - No activo (por tiempo de evolución)",
                                "Caso confirmado por laboratorio - No activo (por tiempo de evolución)",
                                "Caso confirmado por laboratorio - No Activo por criterio de laboratorio")) %>%
  group_by(residencia_provincia_nombre, residencia_departamento_nombre) %>% mutate(altas=n()) %>%
  select(residencia_provincia_nombre, residencia_departamento_nombre, altas) %>% unique()

covid_er_altas <- covid19ER_Rec # <- read_excel("data/entre_rios_casos.xlsx", "ALTAS")

covid19ER_Fall_sisa <- covid19ER %>%
  filter(carga_provincia_nombre=="Entre Ríos" & 
           residencia_provincia_nombre=="Entre Ríos" &
           clasificacion_resumen=="Confirmado" & fallecido=="SI")

covid19ER_Fall_S <-covid19ER_Fall_sisa %>% 
  group_by(residencia_departamento_nombre) %>%
  mutate(fallS = n()) %>%
  select(departamento = residencia_departamento_nombre, fallS) %>% unique()

covid19ER_Fall <- covid19ER %>% 
  filter(carga_provincia_nombre=="Entre Ríos" & 
           residencia_provincia_nombre=="Entre Ríos" &
           clasificacion_resumen=="Confirmado" & fallecido=="SI") 

covid19ER_Sosp <- covid19ER %>% 
  filter(clasificacion_resumen=="Sospechoso" & 
           carga_provincia_nombre=="Entre Ríos" & 
           residencia_provincia_nombre=="Entre Ríos") %>%
  group_by(residencia_provincia_nombre, residencia_departamento_nombre, Clasificacion) %>%
  mutate(sospechosos=n()) %>%
  select(residencia_provincia_nombre, residencia_departamento_nombre,Clasificacion, sospechosos) %>% unique()

covid19ER_Desc_Sem <- covid19ER %>% 
  filter(clasificacion_resumen=="Descartado" & 
           Clasificacion=="Caso Descartado" &
           residencia_provincia_nombre=="Entre Ríos" & 
           carga_provincia_nombre=="Entre Ríos") 


confLab <- covid19ER_Conf %>% 
  filter(!(Clasificacion %in% c("Caso confirmado por criterio clinico-epidemiológico - Activo",
                                "Caso confirmado por criterio clínico-epidemiologico - Fallecido",
                                "Caso confirmado por criterio clínico-epidemiológico  - No activo (por tiempo de evolución)",
                                "Caso confirmado por criterio clínico - epidemiológico -  Activo internado"))) %>% 
  group_by(fecha_diagnostico, residencia_departamento_nombre) %>% 
  mutate(lab=n()) %>%
  select(departamento = residencia_departamento_nombre, fecha_diagnostico, confirmados= lab) %>% unique()



covid19ER_Desc <- covid19ER %>% 
  filter(clasificacion_resumen=="Descartado" & 
           Clasificacion=="Caso Descartado" &
           residencia_provincia_nombre=="Entre Ríos" & 
           carga_provincia_nombre=="Entre Ríos") %>%
  group_by(residencia_departamento_nombre, fecha_diagnostico) %>%
  mutate(descartados=n()) %>%  
  select(departamento = residencia_departamento_nombre, fecha_diagnostico, descartado = descartados) %>% unique()


posit <- covid19ER_Desc %>% left_join(confLab, by=c("departamento"="departamento", "fecha_diagnostico"="fecha_diagnostico"))
posit$confirmados <- if_else(is.na(posit$confirmados), 0, as.double(posit$confirmados))
  
posit$positividad <- round(posit$confirmados/(posit$confirmados + posit$descartado)*100, 0)

posit <- posit %>% group_by(departamento) %>% arrange(fecha_diagnostico) %>%  
  mutate(promPos = round(roll_mean(positividad, n=7,align = "right", fill=NA),0))
  
# table(covid19ER_Desc$Clasificacion)
descartados <- covid19ER %>% 
  filter(clasificacion_resumen=="Descartado" & 
           Clasificacion=="Caso Descartado" &
           residencia_provincia_nombre=="Entre Ríos" & 
           carga_provincia_nombre=="Entre Ríos") %>%
  group_by(residencia_departamento_nombre) %>%
  mutate(descartados=n()) %>%  
  select(departamento = residencia_departamento_nombre, descartado = descartados) %>% unique()


### Movilidad
# poligonosMovil <- read_csv("data/poligonosMovil.csv",  locale = locale(encoding = "ISO-8859-1")) %>% 
#   filter(NAME_1=="Entre Ríos")
# movement <- read_delim("data/movement-range.txt", "\t", escape_double = FALSE, 
#                        locale = locale(encoding = "ISO-8859-1"), 
#                        trim_ws = TRUE) %>% filter(country=="ARG") 
# datos_mov <- movement %>% left_join(poligonosMovil, by=c("polygon_id" = "GID_2")) %>% 
#   filter(NAME_1 =="Entre Ríos")

porLoc <- covid_er %>% group_by(DEPARTAMENTO, LOCALIDAD) %>%
  mutate(total = sum(CASOS)) %>% select(DEPARTAMENTO, LOCALIDAD, total) %>% unique() %>% 
  left_join(localidades) %>% mutate(Lat=as.double(Lat), Long=as.double(Long)) %>% 
  select(DEPARTAMENTO, LOCALIDAD, casos=total, POBLACION, Lat, Long)
porLoc$incidencia <- round(porLoc$casos/porLoc$POBLACION*100000,1)

color <- function(d){ 
  c <- if_else(d==0, '#FFFFFF', 
               if_else(d < 100, '#fdd49e',
                       if_else(d < 500, '#fc8d59',
                               if_else(d < 750, '#d7301f',
                                       if_else(d < 1000, '#b30000', "#7f0000")))))  
  return(c)}
  
  
```

## Evolución provincial
A continuación se muestra la cantidad de casos diarios totales informados por en Ministerio de Salud de la provincia de Entre Ríos.

```{r diaC, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
diario <-  covid_er %>% group_by(FECHA) %>%
  mutate(casosD = sum(CASOS)) %>% select(FECHA, casosD) %>% unique()
diario$FECHA <- as.Date(diario$FECHA, "%d/%m/%Y")
diario <- diario %>% ungroup() %>% arrange(FECHA) %>%
  mutate(casosP=round(roll_mean(casosD, n=7, align="right", fill = NA), 0) ) %>%
  select(FECHA, casosD, casosP) %>% unique()

fig <- plot_ly(diario, x = ~FECHA, y = ~casosD, type = 'bar', name = 'Casos Diarios',
               text= ~casosD,  textposition = 'outside',
               marker = list(color = 'rgba(222,45,38,0.8)'), width = 800)
fig <- fig %>% add_trace(y = ~casosP, name = 'Casos Promedios', marker = list(color = 'rgb(55, 83, 109)'),
                         text= ~casosP,  textposition = 'outside')
fig <- fig %>% layout(title = 'Casos diarios y casos promediados (7 días)',
                      xaxis = list( title = "", tickfont = list(size = 14, color = 'rgb(107, 107, 107)')),
                      yaxis = list( title = 'Cantidad', titlefont = list(size = 16, color = 'rgb(107, 107, 107)'),
                                    tickfont = list( size = 14, color = 'rgb(107, 107, 107)')),
                      legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', 
                                    bordercolor = 'rgba(255, 255, 255, 0)'),
                      barmode = 'group', bargap = 0.15, bargroupgap = 0.1)
fig
    
```





## Evolución departamental
La evolución de casos por departamento desde el inicio de la pandemia se muestra a continuación

###  {.tabset  .tabset-fade .tabset-pills}
#### Acumulados
```{r evolER, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%' }

covid_er$FECHA <- as.Date(covid_er$FECHA, '%d/%m/%Y')
evolER <- covid_er %>% group_by(DEPARTAMENTO, FECHA) %>% 
  mutate(cantidad= sum(CASOS)) %>% select(DEPARTAMENTO, FECHA, cantidad) %>% unique()

diario <- evolER %>% 
  group_by(DEPARTAMENTO) %>% 
  mutate(promD = roll_mean(cantidad, n=7, align="right", fill = NA))
diario$promD <- if_else(is.na(diario$promD), 0, as.double(diario$promD))

evolER$acumulados <-0
evolER <- evolER %>% ungroup() %>% group_by(DEPARTAMENTO) %>% 
  arrange(DEPARTAMENTO, FECHA) %>% 
  mutate(acumulados =cumsum(cantidad))

evolER <- evolER %>%
  gather(cantidad, acum, -c(DEPARTAMENTO, FECHA))
names(evolER) <- c("departamento", "fecha", "tipo", "cant")

p <- evolER %>%
  filter(cant>0 & tipo=="acumulados") %>%
  group_by(departamento) %>% arrange(fecha) %>% mutate(dia1 = row_number())

fig <- plot_ly(p, x = ~fecha, y = ~cant, color = ~departamento, width = 800, type = "scatter", mode='lines+markers')
fig <- layout(fig, title="Evolución de casos confirmados por Departamento",
              xaxis = list(title = "día"), yaxis = list(title = "casos"))
fig

     
```


#### Diarios
Casos diarios promediados a 7 días previos.
```{r promERDpto, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%' }

fig <- plot_ly(diario, x = ~FECHA, y = ~promD, color = ~DEPARTAMENTO, 
               text= ~round(promD, 0),  textposition = 'outside', type = "bar")
fig <- layout(fig, title="Evolución de casos diarios por Dpto. \n (promedio de 7 días)",
              xaxis = list(title = "día"), yaxis = list(title = "casos"))
fig

```


#### Todos
```{r promERDptos, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%' }
diario %>% filter(!(DEPARTAMENTO %in% c("Otros", "Turistas"))) %>% 
  ggplot(mapping=aes(x=FECHA, color=DEPARTAMENTO, y=promD, label = max(promD))) +
  geom_line(show.legend = F,alpha = 0.5) + 
  geom_point(show.legend = F, alpha = 0.5) + 
  geom_smooth(method = 'loess', formula = 'y ~ x', alpha = 0.2,
              size = 2, span = .3, se=FALSE, show.legend=F) +
  labs(title = paste("COVID-19 ENTRE RÍOS - Casos diarios por Departamento"), 
       subtitle = paste0("Escala libre") ,
       y = "Casos",  x = "Fecha", width = 800) +
  facet_wrap(~ DEPARTAMENTO, 
             scales = "free_y",
             ncol = 6)

```




## Fallecidos por Fechas
La siguiente información es extraída de los datos abiertos proporcionados por el Ministerio de Salud Nacional, en base a la información reportada en el Sistema Nacional de Vigilancia en Salud (SISA)

### Total Provincial
```{r fallD, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
FallDiario <-  covid19ER_Fall_sisa %>% group_by(fecha_fallecimiento) %>%
  mutate(fallD = n()) %>% select(FECHA=fecha_fallecimiento, fallD) %>% unique()

fig <- plot_ly(FallDiario, x = ~FECHA, y = ~fallD, type = 'bar', name = 'Fall. Diarios',
               text= ~fallD, textposition = 'outside', 
               marker = list(color = 'rgba(222,45,38,0.8)'), width = 800)
fig <- fig %>% layout(title = 'Fallecidos por Fecha de fallecimiento',
                      xaxis = list( title = "", tickfont = list(size = 14, color = 'rgb(107, 107, 107)')),
                      yaxis = list( title = 'Cantidad', titlefont = list(size = 16, color = 'rgb(107, 107, 107)'),
                                    tickfont = list( size = 14, color = 'rgb(107, 107, 107)')),
                      legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', 
                                    bordercolor = 'rgba(255, 255, 255, 0)'),
                      barmode = 'group', bargap = 0.15, bargroupgap = 0.1)
fig
    
```


### Por Departamento
La siguiente información es extraída de los datos abiertos proporcionados por el Ministerio de Salud Nacional, en base a la información reportada en el Sistema Nacional de Vigilancia en Salud (SISA). 
Se consideran los fallecidos residentes  y que han sido cargados por la provincia de Entre Ríos

```{r fallDpto, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
fall_er <- covid19ER %>% 
  filter(residencia_provincia_nombre=="Entre Ríos" & carga_provincia_nombre=="Entre Ríos") %>%
  group_by(residencia_departamento_nombre, fecha_fallecimiento) %>% mutate(fall =n()) %>% 
  select(departamento = residencia_departamento_nombre, fecha= fecha_fallecimiento, fallecidos=fall) %>% unique()

fig <- plot_ly(fall_er, x = ~fecha, y = ~fallecidos, color = ~departamento,   
               text= ~fallecidos,  textposition = 'outside', type = "bar")
fig <- layout(fig, title="Fallecidos por Dpto. \n (por fecha de fallecimiento)",
              xaxis = list(title = "día"), yaxis = list(title = "cantidad"))
fig

  
```




## Casos del día

###  {.tabset  .tabset-fade .tabset-pills}
#### Distribución departamental
A continuación se muestran los casos confirmados por la provincia el día `r max(covid_er$FECHA)` en base a la distribución departamental

```{r casosDia, echo=FALSE, message=FALSE, warning=FALSE}
covid_er_hoy <- covid_er %>% filter(FECHA==max(FECHA)) %>% group_by(DEPARTAMENTO) %>% 
  mutate(CASOS=sum(CASOS)) %>% 
  select(DEPARTAMENTO,FECHA, CASOS) %>% unique()
covid_er_hoy$parents <- "Confirmados"
plot_ly(data = covid_er_hoy, type= "treemap",
        values = ~CASOS,
        labels= ~DEPARTAMENTO,
        parents=  ~parents,
        domain = list(column=0),
        name = "Confirmados",
        textinfo="label+value+percent parent") %>%
  layout(title = paste("Covid19 ER - Distribución de casos Confirmados", max(covid_er_hoy$FECHA)))
  

```


#### Por Ciudad
La cantidad de casos confirmados el día  `r max(covid_er$FECHA)` por localidad de residencia informados por la provincia se muestran en el mapa a continuación.

```{r locERHoy, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

localidades_er_hoy <- covid_er %>% filter(FECHA==max(FECHA)) %>%
  left_join(localidades, by=c("DEPARTAMENTO"="DEPARTAMENTO", "LOCALIDAD"="LOCALIDAD")) %>% 
  group_by(Lat2, Long2) %>% mutate(cant=sum(CASOS), Lat=as.double(Lat), Long=as.double(Long)) %>% 
  select(LOCALIDAD, Lat, Long, cant) %>% unique()
localidades_er_hoy <- as.data.frame(lapply(localidades_er_hoy, rep, localidades_er_hoy$cant))
# write.csv(localidades_er_hoy, "localidades_er_hoy.csv")
leaflet(height = 900, width = 900) %>% addTiles() %>% 
  addProviderTiles(providers$OpenStreetMap) %>% 
  addPolygons(data=deptos_er, fill=FALSE, weight = 1, color = "#000")  %>% 
  addFullscreenControl()  %>%
  addMarkers(data=localidades_er_hoy, lng = localidades_er_hoy$Long, lat = localidades_er_hoy$Lat,
             clusterOptions = markerClusterOptions(singleMarkerMode= T), clusterId = "pointsCluster") %>%
  addEasyButton( easyButton(states =  list(easyButtonState( stateName="unfrozen-markers", 
                                                            icon="ion-toggle",
                                                            title="Freeze Clusters",
                                                            onClick = JS("function(btn, map) {var  clusterManager = map.layerManager.getLayer('cluster', 'pointsCluster');
                                                                         clusterManager.freezeAtZoom();
                                                                         btn.state('frozen-markers');}")),
                                           easyButtonState( stateName="frozen-markers", icon="ion-toggle-filled",
                                           title="UnFreeze Clusters", onClick = JS("function(btn, map) {
                                           var clusterManager = map.layerManager.getLayer('cluster', 'pointsCluster');
                                           clusterManager.unfreeze(); btn.state('unfrozen-markers');}")))))
  
```


## Incidencia diaria
Evolución de la incidencia (Casos cada 100.000 Habitantes) por departamentos. Los casos diarios son tomados como el promedio de los reportados los 7 días previos

Para seleccionar sólo un departamento haga doble click sobre el nombre del mismo en la leyenda

###  {.tabset  .tabset-fade .tabset-pills}
#### A 7 días
```{r incDptalvDiaria, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%' }
incDep <- diario %>% 
  filter(FECHA > "2020-06-14" & 
           !(DEPARTAMENTO %in% c("Otros", "Turistas"))) %>% 
  left_join(poblac_er, by=c("DEPARTAMENTO"="departamento")) %>% 
  mutate(incid = round(cantidad/poblacion*100000, 1),
         incidP =  round(roll_mean(incid,  n=7, align="right", fill = 0), 1)) %>% #NA), 0)) %>% 
  arrange(DEPARTAMENTO, FECHA)

fig <- plot_ly(incDep, x = ~FECHA, y = ~incidP, color = ~DEPARTAMENTO, alpha = 1,  size = 20, type = 'area')
fig <- layout(fig,  autosize = F, width = 800,
              title="Evolución de la Incidencia diaria por Departamento",
              xaxis = list(title = "día"), yaxis = list(title = "casos c/100 mil Hab"))
fig

```


#### A 14 días
```{r incDptalvDiaria14, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%' }
incDep <- incDep %>% 
 
  mutate(#incid = round(cantidad/poblacion*100000, 1),
         incidP2 =  round(roll_mean(incid,  n=14, align="right", fill = 0), 1)) %>% #NA), 0)) %>% 
  arrange(DEPARTAMENTO, FECHA)

fig <- plot_ly(incDep, x = ~FECHA, y = ~incidP2, color = ~DEPARTAMENTO, alpha = 1,  size = 20, type = 'area')
fig <- layout(fig,  autosize = F, width = 800,
              title="Evolución de la Incidencia diaria por Departamento",
              xaxis = list(title = "día"), yaxis = list(title = "casos c/100 mil Hab"))
fig

```

#### Tabla
```{r incDpto, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
incDep %>%
  mutate(promD  = round(promD,1)) %>% 
  select(DEPARTAMENTO, poblacion, FECHA, casos=cantidad, promD, incid, incidP, incidP2) %>% 
  arrange(DEPARTAMENTO, FECHA) %>% 
  datatable(extensions = 'Buttons', rownames = FALSE,
            colnames = c("Departamento", "Población", "Fecha", "Casos del día", "Casos Prom. 7 días",
                         "Incidencia diaria", "Incid. Prom. a 7 días", "Incid. Prom. 14 días"),
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1), c(10,25,50,"All"))))
```



## Incidencia Acumulada
Evolución de la incidencia acumulada cada 14 días por por departamentos. 

###  {.tabset  .tabset-fade .tabset-pills}
#### Acum 14 días
```{r incDptal14, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, out.width='100%' }
incDep2 <- diario %>% filter(FECHA > "2020-06-14"& 
           !(DEPARTAMENTO %in% c("Otros", "Turistas"))) %>% 
  left_join(poblac_er, by=c("DEPARTAMENTO"="departamento")) %>% 
  mutate(casos = roll_sum(cantidad,  n=14, align="right", fill = 0),
         incidP =  round(casos/poblacion*100000, 0)) %>%
  arrange(DEPARTAMENTO, FECHA)


fig <- plot_ly(incDep2, x = ~FECHA, y = ~incidP, color = ~DEPARTAMENTO, alpha = 1,  size = 20, type = 'area')
fig <- layout(fig,  autosize = F, width = 800,
              title="Incidencia Acumulada en 14 por Departamento",
              xaxis = list(title = "día"), yaxis = list(title = "casos c/100 mil Hab"))
fig

```


#### Tabla
```{r incDpto2, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
incDep2 %>%
  select(DEPARTAMENTO, FECHA, casos, incidP) %>% 
  arrange(DEPARTAMENTO, FECHA) %>% 
  datatable(extensions = 'Buttons', rownames = FALSE,
            colnames = c("Departamento", "Fecha", "Casos", "Incid. Acum. 14 días"),
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1), c(10,25,50,"All"))))
```






## Positividad por Departamento
La positividad es calculada en base a los casos confirmados y descartados por Laboratorio. 

A continuación se muestra la curva de positividad para cada departamento, calculada como el promedio de los últimos 7 días.

```{r positProv,echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
      posit <- posit %>% filter(month(fecha_diagnostico)>=6)
      
      fig <- plot_ly(posit, x = ~fecha_diagnostico, y = ~promPos, 
                    color = ~departamento, type = "scatter", mode='lines+markers') 
      fig <- layout(fig,   autosize = F, width = 800, height=550,# 
                    title="Evolución de la Tasa de Positividad por Departamento \n (promedio a 7 días)",
                    legend = list(x = 0.1, y = 1.0),
                    xaxis = list(title = "día"), yaxis = list(title = "% Posit.", side = "right"))
      fig

```



## Mapa por Departamento
A continuación se muestran la cantidad de casos de COVID-19 confirmados por el Ministerio de Salud de Entre Ríos, discriminados por departamento y localidad


```{r mapaER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

covider <- covid_er %>% group_by(DEPARTAMENTO) %>%
  mutate(cantidad=sum(CASOS)) %>% select(DEPARTAMENTO, cantidad) %>% unique()

highchart( ) %>%
  hc_title(text = "<i>Casos de COVID-19 en Entre Ríos</i> ",
           margin = 20, align = "center", style = list(color = "#08338F", useHTML = TRUE)) %>%
  hc_tooltip(followPointer =  FALSE) %>%
  hc_add_series_map(entrerios, covider, name = "Casos", value = "cantidad",
                    joinBy = c("nam", "DEPARTAMENTO"),
                    dataLabels = list(enabled = TRUE, format = '{point.properties.nam}: {point.value}')) %>%
  hc_colorAxis(minColor = "#B7D4EB", maxColor = "#08338F")  %>%
  hc_legend(align = "center", x = 0, y = -10) %>%
  hc_mapNavigation(enabled = TRUE) %>%
  hc_add_theme(hc_theme_ffx()) %>%
  hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud ER')) %>% 
  hc_chart(borderColor = "#FFFFFF", borderRadius = 10, borderWidth = 2)
  
```



## Por Ciudad
Cantidad de casos totales acumulados por ciudad de residencia informada por la provincia de Entre Ríos

```{r locER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

localidades_er <- covid_er %>% left_join(localidades, by=c("DEPARTAMENTO"="DEPARTAMENTO", "LOCALIDAD"="LOCALIDAD")) %>% 
  group_by(Lat2, Long2) %>% mutate(cant=sum(CASOS), Lat=as.double(Lat), Long=as.double(Long)) %>% 
  select(LOCALIDAD, Lat, Long, cant) %>% unique()
localidades_er <- as.data.frame(lapply(localidades_er, rep, localidades_er$cant))
write.csv(localidades_er, "casos.csv")
leaflet( ) %>%
  addTiles() %>% 
  addProviderTiles(providers$OpenStreetMap) %>% 
  addPolygons(data=deptos_er, fill=FALSE, weight = 1, color = "#000")  %>% 
  addFullscreenControl()  %>%
  addMarkers(data=localidades_er, lng = localidades_er$Long, lat = localidades_er$Lat,
             clusterOptions = markerClusterOptions(singleMarkerMode= T), clusterId = "pointsCluster") %>%
  addEasyButton( easyButton(states =  list(easyButtonState( 
    stateName="unfrozen-markers", icon="ion-toggle",
    title="Freeze Clusters",
    onClick = JS("function(btn, map) {var  clusterManager = map.layerManager.getLayer('cluster', 'pointsCluster');
                 clusterManager.freezeAtZoom(); btn.state('frozen-markers');}")),
    easyButtonState( stateName="frozen-markers", icon="ion-toggle-filled",
    title="UnFreeze Clusters", onClick = JS("function(btn, map) {
    var clusterManager = map.layerManager.getLayer('cluster', 'pointsCluster');
    clusterManager.unfreeze(); btn.state('unfrozen-markers');}"))
    )))
  
```







## Casos Activos
A continuación se muestran la cantidad de casos Activos de COVID-19. Los casos activos son los confirmados menos los recuperados y fallecidos


###  {.tabset  .tabset-fade .tabset-pills}
#### Departamental
```{r mapaERAct, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
covider$provincia <- "Entre Ríos"
activos <- covider %>% 
  left_join(covid_er_altas, by=c("DEPARTAMENTO"="residencia_departamento_nombre")) %>% 
  left_join(covid_er_fall, by = c("DEPARTAMENTO"="DEPARTAMENTO"))
activos$altas <- if_else(is.na(activos$altas), 0, as.double(activos$altas))  

activos$FALLECIDOS <- if_else(is.na(activos$FALLECIDOS), 0, as.double(activos$FALLECIDOS))  
activos$activos <- activos$cantidad - activos$altas - activos$FALLECIDOS
colors <- c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026")


highchart( ) %>%
  hc_title(text = "<i>Casos Activos COVID-19 por Departamento en Entre Ríos</i> - <b>GIBD</b>",
           margin = 5, align = "center", 
           style = list(color = "#bd0026", useHTML = TRUE, fontWeight = "bold")) %>% 
  hc_tooltip(followPointer =  FALSE) %>%
  hc_add_series_map(entrerios, activos, name = "Activos", value = "activos",
                    joinBy = c("nam", "DEPARTAMENTO"),
                    dataLabels = list(enabled = TRUE,
                                      format = '{point.properties.nam}: {point.value}')) %>%
  hc_colorAxis(stops=color_stops(n=length(colors), colors = colors)) %>%
  hc_legend(align = "center", x = 0, y = -10) %>%
  hc_mapNavigation(enabled = TRUE) %>%
  hc_add_theme(hc_theme_ffx()) %>% 
  hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerios de Salud Nación')) %>% 
  hc_chart(borderColor = "#bd0026", borderRadius = 10, borderWidth = 2)

```





## Fallecidos
A continuación se muestra el mapa departamental de los fallecidos COVID-19 en la provincia de Entre Ríos.

###  {.tabset  .tabset-fade .tabset-pills}
#### Mapa
```{r mapaERFall, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# fallecidos <- covider %>% 
#   left_join(covid_er_altas, by=c("DEPARTAMENTO"="DEPARTAMENTO"))
# fallecidos$FALLECIDOS <- if_else(is.na(fallecidos$FALLECIDOS), 0, as.double(fallecidos$FALLECIDOS))

colors <- c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026")

highchart( ) %>%
  hc_title(text = "<i>COVID-19 - Fallecidos por Departamento en Entre Ríos</i> - <b>GIBD</b>",
           margin = 5, align = "center", 
           style = list(color = "#bd0026", useHTML = TRUE, fontWeight = "bold")) %>% 
  hc_tooltip(followPointer =  FALSE) %>%
  hc_add_series_map(entrerios, activos, name = "Fallecidos", value = "FALLECIDOS",
                    joinBy = c("nam", "DEPARTAMENTO"),
                    dataLabels = list(enabled = TRUE,
                                      format = '{point.properties.nam}: {point.value}')) %>%
  hc_colorAxis(stops=color_stops(n=length(colors), colors = colors)) %>%
  hc_legend(align = "center", x = 0, y = -10) %>%
  hc_mapNavigation(enabled = TRUE) %>%
  hc_add_theme(hc_theme_ffx()) %>% 
  hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerios de Salud Nación')) %>% 
  hc_chart(borderColor = "#bd0026", borderRadius = 10, borderWidth = 2)
  
```


## Incidencia Acumulada

La Incidencia Acumulada de toda la provincia de Entre Ríos es de `r round(sum(covider$cantidad)/sum(poblac_er$poblacion, na.rm = T)*100000, 2)` cada 100.000 habitantes.

La incidencia acumulada (IA) a nivel departamental, considerando la población proyectada por INDEC para el 2020 se observan en el mapa y tabla a continuación


###  {.tabset  .tabset-fade .tabset-pil}
#### Mapa
```{r casosER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
covid_er_ia <- covider %>% left_join(poblac_er, by=c("DEPARTAMENTO"="departamento")) %>% 
  mutate(ia= round(cantidad/poblacion * 100000, 1)) %>% arrange(desc(ia))

highchart( ) %>% #width = 900, height = 800) %>%
  hc_title(text = "<i>Incidencia Acumulada de COVID-19 en Entre Ríos</i> ",
           margin = 20, align = "center", style = list(color = "#780000", useHTML = TRUE)) %>%
  hc_tooltip(followPointer =  FALSE) %>%
  hc_add_series_map(entrerios, covid_er_ia, name = "Incidencia", value = "ia",
                    joinBy = c("nam", "DEPARTAMENTO"),
                    dataLabels = list(enabled = TRUE, format = '{point.properties.nam}: {point.value}')) %>%
  hc_colorAxis(minColor = "#FFAAAA", maxColor = "#780000")  %>%
  hc_legend(align = "center", x = 0, y = -10) %>%
  hc_mapNavigation(enabled = TRUE) %>%
  hc_add_theme(hc_theme_ffx()) %>% 
  hc_add_annotation(xValue = 0, yValue = 0, title = list(text = 'Fuente: Ministerio Salud ER')) %>% 
  hc_chart(borderColor = "#780000", borderRadius = 10, borderWidth = 2)

```

#### Tabla
```{r tablaIAER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
tabiaprov_er <- covid_er_ia %>% select(DEPARTAMENTO, poblacion, cantidad, ia) %>% arrange(desc(ia))
tabiaprov_er %>% kable(col.names = c("Departamento","Población",  "Casos", "Tasa Incidencia"),
                       format.args = list( big.mark=".", decimal.mark = ","),
                       align=c('l', 'c', 'c', 'c')) %>%
  kable_styling()
```




## Incidencia por Ciudades

### {.tabset  .tabset-fade .tabset-pills}
#### Mapa
```{r mapaIncCiud, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
palcontinua <- colorNumeric(palette =  "Reds",  domain = porLoc$incidencia,  reverse = FALSE)

leaflet() %>% #height = 900, width = 900) %>% 
  addTiles() %>% 
  addProviderTiles(providers$OpenStreetMap) %>% 
  addFullscreenControl()  %>%
  addCircleMarkers(data=porLoc, lng = porLoc$Long, lat = porLoc$Lat, radius = 10,
                   color = ~color(porLoc$incidencia), fill = ~color(porLoc$incidencia),
                   stroke = FALSE, fillOpacity = 0.9,
                   label = ~paste(porLoc$LOCALIDAD,": \n", porLoc$incidencia)) %>% 
  addEasyButton( easyButton(states =  list(easyButtonState( 
    stateName="unfrozen-markers", icon="ion-toggle",
    title="Freeze Clusters",
    onClick = JS("function(btn, map) {var  clusterManager = map.layerManager.getLayer('cluster', 'pointsCluster');
                 clusterManager.freezeAtZoom(); btn.state('frozen-markers');}")),
    easyButtonState( stateName="frozen-markers", icon="ion-toggle-filled",
    title="UnFreeze Clusters", onClick = JS("function(btn, map) {
    var clusterManager = map.layerManager.getLayer('cluster', 'pointsCluster');
    clusterManager.unfreeze(); btn.state('unfrozen-markers');}"))
    )))
 
```

#### Tabla
```{r incCiudad, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
porLoc %>% select(DEPARTAMENTO, LOCALIDAD, casos, incidencia) %>% 
  arrange(DEPARTAMENTO, incidencia) %>% 
  datatable(extensions = 'Buttons', rownames = FALSE,
            colnames = c("Departamento", "Localidad", "Casos", "Incidencia"),
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1), c(10,25,50,"All"))))
```




## Composición por Edad
La composición de la siguiente pirámide poblacional de los casos confirmados fue confeccionada considerando las edades y sexo informado por el Ministerio de Salud ne su base de datos abiertos.
Representa el porcentaje por grupo etario y sexo de todos los pacientes con COVID-19 en Entre Ríos

### {.tabset  .tabset-fade .tabset-pills}
#### Edad de casos confirmados
```{r piramideER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
  edadER <- covid19ER_Conf
  edadER$grEdad <- if_else(edadER$edad<10, "0 a 9", 
                          if_else(edadER$edad<20, "10 a 19", 
                          if_else(edadER$edad<30, "20 a 29", 
                          if_else(edadER$edad<40, "30 a 39",
                          if_else(edadER$edad<50, "40 a 49", 
                          if_else(edadER$edad<60, "50 a 59", 
                          if_else(edadER$edad<70, "60 a 69", 
                          if_else(edadER$edad<80, "70 a 79", "80 o más"))))))))
  
  edadER <- edadER %>% group_by(grEdad, sexo) %>% filter(!is.na(grEdad) & sexo %in% c("M", "F")) %>% 
    mutate(cant = n()) %>%
    select(grEdad, sexo, cant) %>% unique()
  
   edadER$sexo <- if_else(edadER$sexo=="M",  "Hombre", "Mujer")
   edadER <- edadER %>%  ungroup() %>% mutate(prop = round(cant/sum(cant)*100,2))
   edadER$prop <- if_else(edadER$sexo=="Hombre",  edadER$prop*-1, edadER$prop)
  
   plot_ly(edadER, x = ~prop, y = ~grEdad, color = ~sexo, width = 900, height = 600) %>%
     add_bars(orientation = "h",
           hoverinfo = "y+text+name", 
           text =  ~paste(abs(round(prop,1)), "%", '\n(',cant,')'),  
           textposition = 'outside',
           colors = c("#2c7fb8", "#fa9fb5")) %>%
     layout(bargap = 0.1, barmode = "overlay", 
            title = "Piramide Poblaciónal de Casos Confirmados en Entre Ríos", 
            xaxis = list(tickmode = "array", 
                       tickvals = c(-100, -50, -25, -20, -15, -10, -5, 0, 
                                      5, 10, 15, 20, 25, 50, 100),
                         ticktext = c("100", "50%", "25%", "20%", "15%", "10%","5%", "0",
                                      "5%", "10%", "15%","20%", "25%", "50%", "100%"),
                         title = "Casos Confirmados"), 
            yaxis = list(title = "Grupo Edad"))


```



#### Pirámide de los Fallecidos
```{r piramideERF, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
  edadERF <- covid19ER_Fall
  edadERF$grEdad <- if_else(edadERF$edad<10, "0 a 9", 
                          if_else(edadERF$edad<20, "10 a 19", 
                          if_else(edadERF$edad<30, "20 a 29", 
                          if_else(edadERF$edad<40, "30 a 39",
                          if_else(edadERF$edad<50, "40 a 49", 
                          if_else(edadERF$edad<60, "50 a 59", 
                          if_else(edadERF$edad<70, "60 a 69", 
                          if_else(edadERF$edad<80, "70 a 79", "80 o más"))))))))
  
  edadERF <- edadERF %>% filter(!(sexo=="NR")) %>%  group_by(grEdad, sexo) %>% mutate(cant = n()) %>%
    select(grEdad, sexo, cant) %>% unique()
  
   edadERF$sexo <- if_else(edadERF$sexo=="M",  "Hombre", "Mujer")
   edadERF <- edadERF %>%  ungroup() %>% mutate(prop = round(cant/sum(cant)*100,2))
   edadERF$prop <- if_else(edadERF$sexo=="Hombre",  edadERF$prop*(-1), edadERF$prop)
  
   plot_ly(edadERF, x = ~prop, y = ~grEdad, color = ~sexo, width = 900, height = 700) %>%
     add_bars(orientation = "h",
           hoverinfo = "y+text+name", 
           text =  ~paste(abs(round(prop,1)), "%", '\n(',cant,')'),  
           textposition = 'outside',
           colors = c("#2c7fb8", "#fa9fb5")) %>%
     layout(bargap = 0.1, barmode = "overlay", 
            title = "Piramide Poblaciónal de los Fallecidos en Entre Ríos", 
            xaxis = list(tickmode = "array", 
                       tickvals = c(-100, -50, -25, -20, -15, -10, -5, 0, 
                                      5, 10, 15, 20, 25, 50, 100),
                         ticktext = c("100", "50%", "25%", "20%", "15%", "10%","5%", "0",
                                      "5%", "10%", "15%","20%", "25%", "50%", "100%"),
                         title = "Fallecido"), 
            yaxis = list(title = "Grupo Edad"))


```



#### Letalidad por Grupo
```{r let_Edad_ER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

  let_edad <- edadER %>% left_join(edadERF, by=c("sexo"="sexo", "grEdad"="grEdad")) %>% 
    filter(!is.na(grEdad) & !is.na(sexo)) %>% 
  mutate(let = round(cant.y/cant.x*100, 1)) %>% select(sexo, grupo=grEdad, let) %>% unique()
  let_edad$let <- if_else(is.na(let_edad$let), 0, as.double(let_edad$let))
   plot_ly(let_edad, x=~let, y=~grupo, color=~sexo, width = 900) %>% 
       add_bars(orientation = "h",
        hoverinfo = "y+text", 
        text = ~paste(let, '%'), 
        textposition = 'outside',
        colors = c("#2c7fb8", "#fa9fb5")) %>% 
       layout( title = "Tasas de Letalidad por Grupo",
               xaxis = list(title = "Letalidad"), yaxis = list(title = "Grupo Edad"))

```




## Casos Analizados
En Entre Ríos se han descartado casos sospechosos ya sea por invalidación epidemiológica como	por pruebas de laboratorio.

Para simplificar la lectura se graficará la cantidad de casos confirmados y descartados por semana epidemiológica. 

<!-- ### {.tabset  .tabset-fade .tabset-pills} -->
#### Casos confirmados y descartados
```{r descartados, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

 # descartadosER <- covid19ER_Desc_Sem  # %>%  filter(carga_provincia_nombre=="Entre Ríos")
 confirmadosER <- covid19ER_Conf %>%  filter(carga_provincia_nombre=="Entre Ríos") %>% mutate(anio = year(fecha_apertura)) %>% 
   group_by(anio, sepi_apertura) %>% 
   mutate(conf =n(), desde=min(fecha_apertura), hasta=max(fecha_apertura)) %>% ungroup() %>% 
  mutate(sepi_apertura=paste0(anio, " - ", sepi_apertura)) %>% 
   select(sepi_apertura, desde, hasta, conf)
   
 sem <- covid19ER_Desc_Sem %>%  mutate(anio = year(fecha_apertura))%>% 
   group_by(anio, sepi_apertura) %>% 
   mutate(cant =n(), desde=min(fecha_apertura), hasta=max(fecha_apertura)) %>% ungroup() %>% 
   mutate(sepi_apertura=paste0(anio, " - ", sepi_apertura)) %>% 
  select(sepi_apertura, desde, hasta, cant)  %>% unique() %>% 
   left_join(confirmadosER, by=c("sepi_apertura"="sepi_apertura")) %>% 
   select(sepi_apertura, desde.x, hasta.x, cant, conf) %>% unique()
    
 sem$desde.x <- as.Date(sem$desde.x, "%d/%m/%Y")
 sem$hasta.x <- as.Date(sem$hasta.x, "%d/%m/%Y")
  
 plot_ly(sem, x = ~sepi_apertura, y = ~cant, type = "bar", width = 800, 
         name = "Descartados",  color = I("steelblue3"),
          hoverinfo = 'text',
          text = ~paste('</br> Desde: ', desde.x,
                      '</br> Hasta: ', hasta.x,
                      '</br> Confirmados: ', conf,
                      '</br> Descartados: ', cant)) %>% 
    add_trace(y = ~conf, name = "Confirmados", color = I("indianred3")) %>%
    layout(  title = "Casos Confirmados y Descartados en Entre Ríos", 
             xaxis = list(title="Semana Epidemiológica" ), 
           yaxis = list(title = "Estudiados"), 
           barmode = "stack",
           legend = list(font = list(size = 10)))


```



## Casos Sospechosos
En la base de datos nacional figuran al día `r as.Date(max(covid19ER$ultima_actualizacion), "%d/%m/%Y")`, un total de `r sum(covid19ER_Sosp$sospechosos)` casos sospechosos de COVID-19 cargados en el Sistema Nacional de Vigilancia.

La definición de caso es dinámica y puede variar según situación epidemiológica [Definición de Caso](https://www.argentina.gob.ar/salud/coronavirus-COVID-19/definicion-de-caso)

En Argentina sólo se procesan muestras que cumplen con la definición de caso sospechoso. La muestra enviada debe estar acompañada con los datos completos según Ficha de notificación, investigación epidemiológica y pedido de estudios de laboratorio. 

Entre estos casos hay algunos a los que ta se ha tomado la muestra y aún esperan resultados y otros a los que aún no se les ha realizado la muestra.

A continuación se graficará la cantidad de casos sospechosos por departamento y su clasificación


#### Casos Sospechosos
```{r sospechosos, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

  sospechosos <- covid19ER_Sosp %>%  group_by(residencia_departamento_nombre) %>% 
  spread(Clasificacion, sospechosos) %>% arrange(residencia_departamento_nombre)

  names(sospechosos) <- c("provincia", "departamento", "Con muestra sin resultado", "Muestra no apta",
                          "Sin muestra")
  
  sospechosos$`Sin muestra` <- if_else(is.na(sospechosos$`Sin muestra`), 0, as.double(sospechosos$`Sin muestra`))
  sospechosos$`Muestra no apta` <- if_else(is.na(sospechosos$`Muestra no apta`), 0, as.double(sospechosos$`Muestra no apta`))
  sospechosos$`Con muestra sin resultado` <- if_else(is.na(sospechosos$`Con muestra sin resultado`), 0, as.double(sospechosos$`Con muestra sin resultado`))
    
  plot_ly(sospechosos, x = ~departamento, y = ~`Con muestra sin resultado`, type = "bar",  width = 800,
          name = "Con muestra sin resultado",  color =I("orchid3"), 
          hoverinfo = 'text',
          text = ~paste('</br> Departamento: ', departamento,
                        '</br> Con muestra sin resultado: ', `Con muestra sin resultado`)) %>% 
    add_trace(y = ~`Sin muestra`, 
              name = "Sin muestra", color = I("indianred3"),
              hoverinfo = 'text',
          text = ~paste('</br> Departamento: ', departamento,
                         '</br> Sin muestra: ',`Sin muestra`)) %>%
    add_trace(y = ~`Muestra no apta`,
               name = "Muestra no apta", color =I("olivedrab3"),
              hoverinfo = 'text',
          text = ~paste('</br> Departamento: ', departamento,
                        '</br> Muestra no apta: ', `Muestra no apta`)) %>%
    
    layout(title = "Casos sospechosos en Entre Ríos", 
           xaxis = list(title="Departamento" ), 
           yaxis = list(title = "Sospechosos"), 
           barmode = "stack",
           legend = list(font = list(size = 10)))


```


<!-- ## Movilidad -->

<!-- A continuación se grafica el cambio en la movilidad de cada departamento tomando como linea de base la movilidad al mes de Febrero. Los datos utilizados son medidos por Facebook. -->


<!--  ```{r movilidad, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'} -->
  
  <!-- datos_mov$movilidad <- round(-datos_mov$all_day_ratio_single_tile_users*100, 0) -->
  <!-- datos_mov$fecha <- datos_mov$ds -->

  <!-- p<- datos_mov %>%  -->
  <!--   # filter(NAME_1 =="Entre Ríos") %>% -->
  <!--   ggplot(mapping=aes(x=fecha, y=movilidad)) + -->
  <!--   geom_line(color="#67a9cf") + -->
  <!--   geom_point(color="#67a9cf") + -->
  <!--   geom_smooth(method = 'loess', -->
  <!--               formula = 'y ~ x', alpha = 0.2, size = 1, span = .3, se=FALSE, color="#ef8a62") +  -->
  <!--   labs(title = paste("COVID-19 en Entre Ríos"),  -->
  <!--        subtitle = paste0("Variación de la movilidad por departamento (al: ", max(datos_mov$ds), ")") ,  -->
  <!--        caption = "Fuente: https://data.humdata.org/group/arg",  -->
  <!--        y = "Movilidad",  -->
  <!--        x = "Fecha") + -->
  <!--   facet_wrap(~ NAME_2, scales = "free_y", ncol = 8) + -->
  <!--   theme_elegante_std(base_family = "Assistant")  -->

  <!-- ggplotly(p, name="Movilidad", width = 1200 ) #, height = 800) -->

<!-- ``` -->



## Datos
En la siguiente tabla se muestran los datos de Cantidad de Casos detectados, Altas, Fallecidos y Sospechosos calculado con la base de datos abiertos del Min. de Salud de la Nación. 

Los datos pueden ser descargados en diversos formatos
```{r datosER, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width='100%'}
 
sospechosos <- covid19ER_Sosp %>% group_by(residencia_departamento_nombre) %>% mutate(sospechosos=sum(sospechosos)) %>% 
  select(departamento=residencia_departamento_nombre, sospechosos) %>% unique()

fallecidos <- covid_er_fall %>% #  covid_er_altas %>%
  select(departamento = DEPARTAMENTO, fallecidos=FALLECIDOS)

dupl <- dupl %>% select(departamento, dias)
covid19ER_Nexo <- covid19ER_Nexo %>%  select(departamento = residencia_departamento_nombre, nexo)
covid19ER_Lab <- covid19ER_Lab %>%  select(departamento= residencia_departamento_nombre, lab)
    
tabla <- covider %>% 
  left_join(covid19ER_Rec, by=c("DEPARTAMENTO"="residencia_departamento_nombre")) %>% 
  select(departamento=DEPARTAMENTO, casos=cantidad, altas) %>% 
   left_join(covid19ER_Nexo, by=c("departamento"="departamento")) %>% 
   left_join(covid19ER_Lab, by=c("departamento"="departamento")) %>% 
   left_join(fallecidos, by=c("departamento"="departamento")) %>% 
   left_join(covid19ER_Fall_S, by=c("departamento"="departamento")) %>% 
   left_join(descartados, by=c("departamento"="departamento")) %>% 
   left_join(sospechosos, by=c("departamento"="departamento")) %>% 
   left_join(dupl, by=c("departamento"="departamento")) %>% 
  left_join(razon,by=c("departamento"="departamento" )) %>% 
   select(departamento, casos, nexo, lab, altas, fallecidos, fallS, descartado, sospechosos, dias, razon) %>%
  unique() %>% arrange(departamento)

tabla %>% datatable(extensions = 'Buttons', rownames = FALSE,
                    colnames = c("Departamento", "Casos Detectados", "Por Nexo", "Por Lab.", 
                                 "Recuperados", "Fallecidos", "Fall. SISA", "Descartados", "Sospechosos", "Dias Dupl.", "Razón"),
                    options = list(dom = 'Blfrtip',
                                   buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                                   lengthMenu = list(c(10,25,50,-1), c(10,25,50,"All"))))
```
```